"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[976],{74935:(e,t,n)=>{n.d(t,{$P:()=>tZ,AP:()=>j,Ak:()=>ea,Ap:()=>$,BU:()=>N,F2:()=>ns,Fr:()=>ta,Ge:()=>ef,HM:()=>e2,HN:()=>Y,IZ:()=>el,JB:()=>en,Je:()=>t3,Jf:()=>eA,Jv:()=>eT,Mv:()=>tQ,N1:()=>nd,OX:()=>H,P$:()=>na,Sl:()=>t0,UU:()=>tG,Us:()=>eu,WU:()=>A,Xf:()=>ee,aG:()=>e5,aX:()=>e9,b4:()=>ts,bR:()=>eh,dP:()=>e4,ez:()=>Q,gk:()=>eM,h$:()=>ec,j$:()=>L,js:()=>d,k2:()=>g,nn:()=>eN,oK:()=>tF,vA:()=>eP,x7:()=>e3,xb:()=>eR,xl:()=>T});var r=Object.defineProperty,i="@liveblocks/core",o="3.2.1",s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};function a(e){console.error(e)}function d(e,t,n){let r=Symbol.for(e),d=n?`${t||"dev"} (${n})`:t||"dev";s[r]?s[r]===d||a(`Multiple copies of Liveblocks are being loaded in your project. This will cause issues! See https://liveblocks.io/docs/errors/dupes 

Conflicts:
- ${e} ${s[r]} (already loaded)
- ${e} ${d} (trying to load this now)`):s[r]=d,t&&o&&t!==o&&a(`Cross-linked versions of Liveblocks found, which will cause issues! See https://liveblocks.io/docs/errors/cross-linked 

Conflicts:
- ${i} is at ${o}
- ${e} is at ${t}

Always upgrade all Liveblocks packages to the same version number.`)}function l(e){let t=e.editedAt?new Date(e.editedAt):void 0,n=new Date(e.createdAt),r=e.reactions.map(e=>({...e,createdAt:new Date(e.createdAt)}));if(e.body)return{...e,reactions:r,createdAt:n,editedAt:t};{let i=new Date(e.deletedAt);return{...e,reactions:r,createdAt:n,editedAt:t,deletedAt:i}}}function c(e){let t=new Date(e.createdAt),n=new Date(e.updatedAt),r=e.comments.map(e=>l(e));return{...e,createdAt:t,updatedAt:n,comments:r}}function u(e){let t=new Date(e.notifiedAt),n=e.readAt?new Date(e.readAt):null;if("activities"in e){let r=e.activities.map(e=>({...e,createdAt:new Date(e.createdAt)}));return{...e,notifiedAt:t,readAt:n,activities:r}}return{...e,notifiedAt:t,readAt:n}}function h(e){let t=new Date(e.createdAt);return{...e,createdAt:t}}function f(e){let t=new Date(e.deletedAt);return{...e,deletedAt:t}}function p(e){let t=new Date(e.deletedAt);return{...e,deletedAt:t}}function m(e){let t=new Date(e.deletedAt);return{...e,deletedAt:t}}var g={};((e,t)=>{for(var n in t)r(e,n,{get:t[n],enumerable:!0})})(g,{error:()=>_,errorWithTitle:()=>I,warn:()=>b,warnWithTitle:()=>S});var y="background:#0e0d12;border-radius:9999px;color:#fff;padding:3px 7px;font-family:sans-serif;font-weight:600;";function v(e){return"undefined"==typeof window?console[e]:(t,...n)=>console[e]("%cLiveblocks",y,t,...n)}var b=v("warn"),_=v("error");function w(e){return"undefined"==typeof window?console[e]:(t,n,...r)=>console[e](`%cLiveblocks%c ${t}`,y,"font-weight:600",n,...r)}var S=w("warn"),I=w("error");function E(e){return null!=e}function O(e){return null!==e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)}function A(e){return O(e)&&"string"==typeof e.startsWith}function T(e){throw Error(e)}function k(e){return Object.entries(e)}function C(e){try{return JSON.parse(e)}catch(e){return}}function R(e){return JSON.parse(JSON.stringify(e))}function P(e){return e.filter(e=>null!=e)}function N(e){let t={...e};return Object.keys(e).forEach(e=>{void 0===t[e]&&delete t[e]}),t}async function D(e,t,n){let r;return Promise.race([e,new Promise((e,i)=>{r=setTimeout(()=>{i(Error(n))},t)})]).finally(()=>clearTimeout(r))}function x(e){let t=null;return()=>(null===t&&(t=e().catch(e=>{throw setTimeout(()=>{t=null},5e3),e})),t)}var L=class e extends Error{response;details;constructor(e,t,n){super(e),this.name="HttpError",this.response=t,this.details=n}static async fromResponse(t){let n,r,i;try{n=await t.text()}catch{}let o=n?C(n):void 0;O(o)&&(r=o);let s="";s||="string"==typeof r?.message?r.message:"",s||="string"==typeof r?.error?r.error:"",void 0===o&&(s||=n||""),s||=t.statusText;try{i=new URL(t.url).pathname}catch{}return new e(s+=void 0!==i?` (got status ${t.status} from ${i})`:` (got status ${t.status})`,t,r)}get status(){return this.response.status}},M=e=>e instanceof L&&e.status>=400&&e.status<500;async function $(e,t,n,r=M){let i=n.length>0?n[n.length-1]:0,o=0;for(;;){o++;try{return await e()}catch(e){if(r(e))throw e;if(o>=t)throw Error(`Failed after ${t} attempts: ${String(e)}`)}let s=n[o-1]??i;b(`Attempt ${o} was unsuccessful. Retrying in ${s} milliseconds.`),await function(e){return new Promise(t=>setTimeout(t,e))}(s)}}function U(){let e,t;return[new Promise((n,r)=>{e=n,t=r}),e,t]}function K(){let[e,t,n]=U();return{promise:e,resolve:t,reject:n}}function j(){let e=new Set;function t(t){return e.add(t),()=>e.delete(t)}function n(e){let n=t(t=>(n(),e(t)));return n}async function r(e){let n;return new Promise(r=>{n=t(t=>{(void 0===e||e(t))&&r(t)})}).finally(()=>n?.())}return{notify:function(t){let n=!1;for(let r of e)r(t),n=!0;return n},subscribe:t,subscribeOnce:n,count:function(){return e.size},waitUntil:r,dispose(){e.clear()},observable:{subscribe:t,subscribeOnce:n,waitUntil:r}}}var q=e=>e,z=Symbol("kSinks"),V=Symbol("kTrigger"),F=null,B=null;function H(e){if(null!==F)return void e();F=new Set;try{e()}finally{for(let e of F)e[V]();F=null}}function W(e){F||T("Expected to be in an active batch"),F.add(e)}function G(e,t){let n=!1,r={...e};return Object.keys(t).forEach(e=>{let i=t[e];r[e]!==i&&(void 0===i?delete r[e]:r[e]=i,n=!0)}),n?r:e}var J=class{equals;#e;[z];constructor(e){this.equals=e??Object.is,this.#e=j(),this[z]=new Set,this.get=this.get.bind(this),this.subscribe=this.subscribe.bind(this),this.subscribeOnce=this.subscribeOnce.bind(this)}dispose(){this.#e.dispose(),this.#e="(disposed)",this.equals="(disposed)"}get hasWatchers(){if(this.#e.count()>0)return!0;for(let e of this[z])if(e.hasWatchers)return!0;return!1}[V](){for(let e of(this.#e.notify(),this[z]))W(e)}subscribe(e){return 0===this.#e.count()&&this.get(),this.#e.subscribe(e)}subscribeOnce(e){let t=this.subscribe(()=>(t(),e()));return t}waitUntil(){throw Error("waitUntil not supported on Signals")}markSinksDirty(){for(let e of this[z])e.markDirty()}addSink(e){this[z].add(e)}removeSink(e){this[z].delete(e)}asReadonly(){return this}},Y=class extends J{#t;constructor(e,t){super(t),this.#t=q(e)}dispose(){super.dispose(),this.#t="(disposed)"}get(){return B?.add(this),this.#t}set(e){H(()=>{"function"==typeof e&&(e=e(this.#t)),this.equals(this.#t,e)||(this.#t=q(e),this.markSinksDirty(),W(this))})}},X=class extends Y{constructor(e){super(q(N(e)))}set(){throw Error("Don't call .set() directly, use .patch()")}patch(e){super.set(t=>G(t,e))}},Z=Symbol(),Q=class e extends J{#n;#r;#i;#o;#s;static from(...t){let n=t.pop();if("function"!=typeof n&&T("Invalid .from() call, last argument expected to be a function"),"function"!=typeof t[t.length-1])return new e(t,n);{let r=t.pop();return new e(t,r,n)}}constructor(e,t,n){super(n),this.#r=!0,this.#n=Z,this.#o=e,this.#i=new Set,this.#s=t}dispose(){for(let e of this.#i)e.removeSink(this);this.#n="(disposed)",this.#i="(disposed)",this.#o="(disposed)",this.#s="(disposed)"}get isDirty(){return this.#r}#a(){let e,t=B;B=new Set;try{e=this.#s(...this.#o.map(e=>e.get()))}finally{let e=this.#i;for(let t of(this.#i=new Set,B))this.#i.add(t),e.delete(t);for(let t of e)t.removeSink(this);for(let e of this.#i)e.addSink(this);B=t}return this.#r=!1,!this.equals(this.#n,e)&&(this.#n=e,!0)}markDirty(){this.#r||(this.#r=!0,this.markSinksDirty())}get(){return this.#r&&this.#a(),B?.add(this),this.#n}[V](){this.hasWatchers&&this.#a()&&super[V]()}},ee=class extends J{#d;constructor(e){super(),this.#d=e}dispose(){super.dispose(),this.#d="(disposed)"}get(){return B?.add(this),this.#d}mutate(e){H(()=>{let t=!e||e(this.#d);null!==t&&"object"==typeof t&&"then"in t&&T("MutableSignal.mutate() does not support async callbacks"),!1!==t&&(this.markSinksDirty(),W(this))})}};function et(e,t){return null===t||"object"!=typeof t||Array.isArray(t)?t:Object.keys(t).sort().reduce((e,n)=>(e[n]=t[n],e),{})}function en(e){return JSON.stringify(e,et)}function er(e){try{return JSON.stringify(e)}catch(t){throw console.error(`Could not stringify: ${t.message}`),console.error(e),t}}var ei=class{input;resolve;reject;promise;constructor(e){this.input=e;let{promise:t,resolve:n,reject:r}=K();this.promise=t,this.resolve=n,this.reject=r}},eo=class{#l=[];#c;#u;#h;#f;error=!1;constructor(e,t){this.#c=e,this.#u=t.size??50,this.#h=t.delay}#p(){void 0!==this.#f&&(clearTimeout(this.#f),this.#f=void 0)}#m(){this.#l.length===this.#u?this.#g():1===this.#l.length&&(this.#p(),this.#f=setTimeout(()=>void this.#g(),this.#h))}async #g(){if(0===this.#l.length)return;let e=this.#l.splice(0),t=e.map(e=>e.input);try{let n=await this.#c(t);this.error=!1,e.forEach((t,r)=>{let i=n?.[r];Array.isArray(n)?e.length!==n.length?t.reject(Error(`Callback must return an array of the same length as the number of provided items. Expected ${e.length}, but got ${n.length}.`)):i instanceof Error?t.reject(i):t.resolve(i):t.reject(Error("Callback must return an array."))})}catch(t){this.error=!0,e.forEach(e=>{e.reject(t)})}}get(e){let t=this.#l.find(t=>en(t.input)===en(e));if(t)return t.promise;let n=new ei(e);return this.#l.push(n),this.#m(),n.promise}clear(){this.#l=[],this.error=!1,this.#p()}};function es(e){let t=new ee(new Map);function n(e,n){t.mutate(t=>{t.set(e,n)})}async function r(r){let i=en(r);if(!t.get().has(i))try{n(i,{isLoading:!0});let t=await e.get(r);n(i,{isLoading:!1,data:t})}catch(e){n(i,{isLoading:!1,error:e})}}return{subscribe:t.subscribe,enqueue:r,getItemState:function(e){let n=en(e);return t.get().get(n)},invalidate:function(e){t.mutate(t=>{if(Array.isArray(e))for(let n of e)t.delete(en(n));else t.clear()})},batch:e,_cacheKeys:function(){return[...t.get().keys()]}}}var ea=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((e,t)=>e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t<63?"_":"-","");function ed(e){return`${e}_${ea()}`}function el(){return ed("th")}function ec(){return ed("cm")}function eu(){return ed("at")}function eh(){return ed("in")}var ef=class extends Map{#y;constructor(e,t){super(t),this.#y=e}getOrCreate(e,t){if(super.has(e))return super.get(e);{let n=(t??this.#y??T("DefaultMap used without a factory function"))(e);return this.set(e,n),n}}},ep=/^[a-zA-Z_][a-zA-Z0-9_]*$/;function em(e){let t=[],n=Object.entries(e),r=[],i=[],o=[];return n.forEach(([e,t])=>{if(!ep.test(e))throw Error("Key must only contain letters, numbers, _");ev(t)?r.push([e,t]):O(t)&&(A(t)?i.push([e,t]):o.push([e,t]))}),t=[...eg(r),...ey(i)],o.forEach(([e,n])=>{let r=Object.entries(n),i=[],o=[];r.forEach(([t,n])=>{if(e_(t))throw Error("Key cannot be empty");ev(n)?i.push([eb(e,t),n]):A(n)&&o.push([eb(e,t),n])}),t=[...t,...eg(i),...ey(o)]}),t.map(({key:e,operator:t,value:n})=>`${e}${t}${ew(n)}`).join(" ")}var eg=e=>{let t=[];return e.forEach(([e,n])=>{t.push({key:e,operator:":",value:n})}),t},ey=e=>{let t=[];return e.forEach(([e,n])=>{"startsWith"in n&&"string"==typeof n.startsWith&&t.push({key:e,operator:"^",value:n.startsWith})}),t},ev=e=>"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e,eb=(e,t)=>t?`${e}[${ew(t)}]`:e,e_=e=>!e||""===e.toString().trim();function ew(e){let t=JSON.stringify(e);return"string"!=typeof e||t.includes("'")?t:`'${t.slice(1,-1).replace(/\\"/g,'"')}'`}var eS="https://localhost:9999",eI=/^[a-zA-Z][a-zA-Z\d+\-.]*?:/,eE=/\/(?:(?:\?|#).*)?$/;function eO(e,...t){return e.reduce((e,n,r)=>e+encodeURIComponent(t[r-1]??"")+n)}function eA(e){e.startsWith("www.")&&(e="https://"+e);try{let t=eI.test(e),n=new URL(e,t?void 0:eS);if("http:"!==n.protocol&&"https:"!==n.protocol)return null;let r=eE.test(e),i=(t?n.origin:"")+("/"===n.pathname?r?"/":"":r&&!n.pathname.endsWith("/")?n.pathname+"/":n.pathname)+n.search+n.hash;return""!==i?i:null}catch{return null}}function eT(e,t,n){let r=eI.test(e),i=new URL(e,r?void 0:eS);if(void 0!==t)for(let[e,n]of Object.entries(t))n&&i.searchParams.set(e,String(n));return i.hash||void 0===n||(i.hash=`#${n}`),r?i.href:i.href.replace(eS,"")}function ek(e){return"public"===e.type?e.publicApiKey:e.token.raw}var eC=class{#v;#b;constructor(e,t){this.#v=e,this.#b=t}async #_(e,t,n,r){e.startsWith("/v2/c/")||T("This client can only be used to make /v2/c/* requests");let i=function(e,t,n){let r=new URL(t,e);return void 0!==n&&(r.search=(n instanceof URLSearchParams?n:function(e){let t=new URLSearchParams;for(let[n,r]of Object.entries(e))null!=r&&t.set(n,r.toString());return t}(n)).toString()),r.toString()}(this.#v,e,r);return await this.#b(i,{...n,headers:{"Content-Type":"application/json; charset=utf-8",...n?.headers,Authorization:`Bearer ${ek(t)}`,"X-LB-Client":o||"dev"}})}async #w(e,t,n,r){let i,o=await this.#_(e,t,n,r);if(!o.ok)throw await L.fromResponse(o);try{i=await o.json()}catch{i={}}return i}async rawGet(e,t,n,r){return await this.#_(e,t,r,n)}async rawPost(e,t,n){return await this.#_(e,t,{method:"POST",body:er(n)})}async rawDelete(e,t){return await this.#_(e,t,{method:"DELETE"})}async get(e,t,n,r){return await this.#w(e,t,r,n)}async post(e,t,n,r,i){return await this.#w(e,t,{...r,method:"POST",body:er(n)},i)}async delete(e,t){return await this.#w(e,t,{method:"DELETE"})}async putBlob(e,t,n,r,i){return await this.#w(e,t,{...i,method:"PUT",headers:{"Content-Type":"application/octet-stream"},body:n},r)}};function eR(e,t){throw Error(t)}function eP(e,t){}function eN(e,t="Expected value to be non-nullable"){return eP(null!=e,t),e}var eD=class{#S;constructor(e){this.#S=e}get current(){return this.#S}allowPatching(e){let t=this,n=!0;e({...this.#S,patch(e){if(n)for(let n of(t.#S=Object.assign({},t.#S,e),Object.entries(e))){let[e,t]=n;"patch"!==e&&(this[e]=t)}else throw Error("Can no longer patch stale context")}}),n=!1}},ex=1,eL=class{id;#I;#E;#O;#A;#T;#k;events;#C;#R;#P;get #N(){let e=this.#O.values()[Symbol.iterator]().next();if(!e.done)return e.value;throw Error("No states defined yet")}get currentState(){if(null===this.#A)if(0===this.#I)throw Error("Not started yet");else throw Error("Already stopped");return this.#A}start(){if(0!==this.#I)throw Error("State machine has already started");return this.#I=1,this.#A=this.#N,this.#D(null),this}stop(){if(1!==this.#I)throw Error("Cannot stop a state machine that hasn't started yet");this.#x(null),this.#I=2,this.#A=null}constructor(e){this.id=ex++,this.#I=0,this.#A=null,this.#O=new Set,this.#R=new Map,this.#C=[],this.#P=new Set,this.#T=new Map,this.#E=new eD(e),this.#k={didReceiveEvent:j(),willTransition:j(),didIgnoreEvent:j(),willExitState:j(),didEnterState:j()},this.events={didReceiveEvent:this.#k.didReceiveEvent.observable,willTransition:this.#k.willTransition.observable,didIgnoreEvent:this.#k.didIgnoreEvent.observable,willExitState:this.#k.willExitState.observable,didEnterState:this.#k.didEnterState.observable}}get context(){return this.#E.current}addState(e){if(0!==this.#I)throw Error("Already started");return this.#O.add(e),this}onEnter(e,t){if(0!==this.#I)throw Error("Already started");if(this.#R.has(e))throw Error(`enter/exit function for ${e} already exists`);return this.#R.set(e,t),this}onEnterAsync(e,t,n,r,i){return this.onEnter(e,()=>{let e=new AbortController,o=e.signal,s=i?setTimeout(()=>{let e=Error("Timed out");this.#L({type:"ASYNC_ERROR",reason:e},r)},i):void 0,a=!1;return t(this.#E.current,o).then(e=>{o.aborted||(a=!0,this.#L({type:"ASYNC_OK",data:e},n))},e=>{o.aborted||(a=!0,this.#L({type:"ASYNC_ERROR",reason:e},r))}),()=>{clearTimeout(s),a||e.abort()}})}#M(e){let t=[];if("*"===e)for(let e of this.#O)t.push(e);else if(e.endsWith(".*")){let n=e.slice(0,-1);for(let e of this.#O)e.startsWith(n)&&t.push(e)}else this.#O.has(e)&&t.push(e);if(0===t.length)throw Error(`No states match ${JSON.stringify(e)}`);return t}addTransitions(e,t){if(0!==this.#I)throw Error("Already started");for(let n of this.#M(e)){let r=this.#T.get(n);for(let[i,o]of(void 0===r&&(r=new Map,this.#T.set(n,r)),Object.entries(t))){if(r.has(i))throw Error(`Trying to set transition "${i}" on "${n}" (via "${e}"), but a transition already exists there.`);let t=o;if(this.#P.add(i),void 0!==t){let e="function"==typeof t?t:()=>t;r.set(i,e)}}}return this}addTimedTransition(e,t,n){return this.onEnter(e,()=>{let e=setTimeout(()=>{this.#L({type:"TIMER"},n)},"function"==typeof t?t(this.#E.current):t);return()=>{clearTimeout(e)}})}#$(e){return this.#T.get(this.currentState)?.get(e)}#x(e){this.#k.willExitState.notify(this.currentState),this.#E.allowPatching(t=>{e=e??this.#C.length;for(let n=0;n<e;n++)this.#C.pop()?.(t)})}#D(e){let t=function(e,t){let n=e.split(".");if(t<1||t>n.length+1)throw Error("Invalid number of levels");let r=[];t>n.length&&r.push("*");for(let e=n.length-t+1;e<n.length;e++){let t=n.slice(0,e);t.length>0&&r.push(t.join(".")+".*")}return r.push(e),r}(this.currentState,e??this.currentState.split(".").length+1);this.#E.allowPatching(e=>{for(let n of t){let t=this.#R.get(n),r=t?.(e);"function"==typeof r?this.#C.push(r):this.#C.push(null)}}),this.#k.didEnterState.notify(this.currentState)}send(e){if(!this.#P.has(e.type))throw Error(`Invalid event ${JSON.stringify(e.type)}`);if(2===this.#I)return;let t=this.#$(e.type);if(void 0!==t)return this.#L(e,t);this.#k.didIgnoreEvent.notify(e)}#L(e,t){let n,r;this.#k.didReceiveEvent.notify(e);let i=this.currentState,o=("function"==typeof t?t:()=>t)(e,this.#E.current);if(null===o)return void this.#k.didIgnoreEvent.notify(e);if("string"==typeof o?n=o:(n=o.target,r=Array.isArray(o.effect)?o.effect:[o.effect]),!this.#O.has(n))throw Error(`Invalid next state name: ${JSON.stringify(n)}`);this.#k.willTransition.notify({from:i,to:n});let[s,a]=function(e,t){if(e===t)return[0,0];let n=e.split("."),r=t.split("."),i=Math.min(n.length,r.length),o=0;for(;o<i&&n[o]===r[o];o++);return[n.length-o,r.length-o]}(this.currentState,n);if(s>0&&this.#x(s),this.#A=n,void 0!==r){let t=r;this.#E.allowPatching(n=>{for(let r of t)"function"==typeof r?r(n,e):n.patch(r)})}a>0&&this.#D(a)}},eM=(e=>(e[e.UPDATE_PRESENCE=100]="UPDATE_PRESENCE",e[e.USER_JOINED=101]="USER_JOINED",e[e.USER_LEFT=102]="USER_LEFT",e[e.BROADCASTED_EVENT=103]="BROADCASTED_EVENT",e[e.ROOM_STATE=104]="ROOM_STATE",e[e.INITIAL_STORAGE_STATE=200]="INITIAL_STORAGE_STATE",e[e.UPDATE_STORAGE=201]="UPDATE_STORAGE",e[e.REJECT_STORAGE_OP=299]="REJECT_STORAGE_OP",e[e.UPDATE_YDOC=300]="UPDATE_YDOC",e[e.THREAD_CREATED=400]="THREAD_CREATED",e[e.THREAD_DELETED=407]="THREAD_DELETED",e[e.THREAD_METADATA_UPDATED=401]="THREAD_METADATA_UPDATED",e[e.THREAD_UPDATED=408]="THREAD_UPDATED",e[e.COMMENT_CREATED=402]="COMMENT_CREATED",e[e.COMMENT_EDITED=403]="COMMENT_EDITED",e[e.COMMENT_DELETED=404]="COMMENT_DELETED",e[e.COMMENT_REACTION_ADDED=405]="COMMENT_REACTION_ADDED",e[e.COMMENT_REACTION_REMOVED=406]="COMMENT_REACTION_REMOVED",e))(eM||{}),e$=(e=>(e[e.CLOSE_NORMAL=1e3]="CLOSE_NORMAL",e[e.CLOSE_ABNORMAL=1006]="CLOSE_ABNORMAL",e[e.UNEXPECTED_CONDITION=1011]="UNEXPECTED_CONDITION",e[e.TRY_AGAIN_LATER=1013]="TRY_AGAIN_LATER",e[e.INVALID_MESSAGE_FORMAT=4e3]="INVALID_MESSAGE_FORMAT",e[e.NOT_ALLOWED=4001]="NOT_ALLOWED",e[e.MAX_NUMBER_OF_MESSAGES_PER_SECONDS=4002]="MAX_NUMBER_OF_MESSAGES_PER_SECONDS",e[e.MAX_NUMBER_OF_CONCURRENT_CONNECTIONS=4003]="MAX_NUMBER_OF_CONCURRENT_CONNECTIONS",e[e.MAX_NUMBER_OF_MESSAGES_PER_DAY_PER_APP=4004]="MAX_NUMBER_OF_MESSAGES_PER_DAY_PER_APP",e[e.MAX_NUMBER_OF_CONCURRENT_CONNECTIONS_PER_ROOM=4005]="MAX_NUMBER_OF_CONCURRENT_CONNECTIONS_PER_ROOM",e[e.ROOM_ID_UPDATED=4006]="ROOM_ID_UPDATED",e[e.KICKED=4100]="KICKED",e[e.TOKEN_EXPIRED=4109]="TOKEN_EXPIRED",e[e.CLOSE_WITHOUT_RETRY=4999]="CLOSE_WITHOUT_RETRY",e))(e$||{});function eU(e){return 4999===e||e>=4e3&&e<4100}function eK(e){return 1013===e||e>=4200&&e<4300}function ej(e){let t=e.currentState;switch(t){case"@ok.connected":case"@ok.awaiting-pong":return"connected";case"@idle.initial":return"initial";case"@auth.busy":case"@auth.backoff":case"@connecting.busy":case"@connecting.backoff":case"@idle.zombie":return e.context.successCount>0?"reconnecting":"connecting";case"@idle.failed":return"disconnected";default:return eR(t,"Unknown state")}}var eq=[250,500,1e3,2e3,4e3,8e3,1e4],ez=eq[0]-1,eV=[2e3,3e4,6e4,3e5],eF=class extends Error{constructor(e){super(e)}};function eB(e,t){return t.find(t=>t>e)??t[t.length-1]}function eH(e){e.patch({backoffDelay:eB(e.backoffDelay,eq)})}function eW(e){e.patch({backoffDelay:eB(e.backoffDelay,eV)})}function eG(e){e.patch({successCount:0})}function eJ(e,t){let n=2===e?_:1===e?b:()=>{};return()=>{n(t)}}function eY(e){let t="Connection to Liveblocks websocket server";return n=>{e instanceof Error?b(`${t} could not be established. ${String(e)}`):b(eQ(e)?`${t} closed prematurely (code: ${e.code}). Retrying in ${n.backoffDelay}ms.`:`${t} could not be established.`)}}function eX(e){let t=[`code: ${e.code}`];return e.reason&&t.push(`reason: ${e.reason}`),e=>{b(`Connection to Liveblocks websocket server closed (${t.join(", ")}). Retrying in ${e.backoffDelay}ms.`)}}var eZ=eJ(1,"Connection to WebSocket closed permanently. Won't retry.");function eQ(e){return!(e instanceof Error)&&"close"===e.type}var e0=e=>t=>t.patch(e),e1=class{#U;#K;events;constructor(e,t=!1,n=!0){let{machine:r,events:i,cleanups:o}=function(e,t){let n=function(){let e=j(),t=null;return{...e,notify:function(n){return null!==t?(t.push(n),!1):e.notify(n)},pause:function(){t=[]},unpause:function(){if(null!==t){for(let n of t)e.notify(n);t=null}},dispose(){e.dispose(),null!==t&&(t.length=0)}}}();n.pause();let r=j();function i(e,t){return()=>{r.notify({message:e,code:t})}}let o=new eL({successCount:0,authValue:null,socket:null,backoffDelay:ez}).addState("@idle.initial").addState("@idle.failed").addState("@idle.zombie").addState("@auth.busy").addState("@auth.backoff").addState("@connecting.busy").addState("@connecting.backoff").addState("@ok.connected").addState("@ok.awaiting-pong");o.addTransitions("*",{RECONNECT:{target:"@auth.backoff",effect:[eH,eG]},DISCONNECT:"@idle.initial"}),o.onEnter("@idle.*",eG).addTransitions("@idle.*",{CONNECT:(e,t)=>null!==t.authValue?"@connecting.busy":"@auth.busy"}),o.addTransitions("@auth.backoff",{NAVIGATOR_ONLINE:{target:"@auth.busy",effect:e0({backoffDelay:ez})}}).addTimedTransition("@auth.backoff",e=>e.backoffDelay,"@auth.busy").onEnterAsync("@auth.busy",()=>D(e.authenticate(),1e4,"Timed out during auth"),e=>({target:"@connecting.busy",effect:e0({authValue:e.data})}),e=>e.reason instanceof eF?{target:"@idle.failed",effect:[eJ(2,e.reason.message),i(e.reason.message,-1)]}:{target:"@auth.backoff",effect:[eH,eJ(2,`Authentication failed: ${e.reason instanceof Error?e.reason.message:String(e.reason)}`)]});let s=e=>o.send({type:"EXPLICIT_SOCKET_ERROR",event:e}),a=e=>o.send({type:"EXPLICIT_SOCKET_CLOSE",event:e}),d=e=>"pong"===e.data?o.send({type:"PONG"}):n.notify(e);function l(e){e&&(e.removeEventListener("error",s),e.removeEventListener("close",a),e.removeEventListener("message",d),e.close())}o.addTransitions("@connecting.backoff",{NAVIGATOR_ONLINE:{target:"@connecting.busy",effect:e0({backoffDelay:ez})}}).addTimedTransition("@connecting.backoff",e=>e.backoffDelay,"@connecting.busy").onEnterAsync("@connecting.busy",async(n,r)=>{let i=null,o=null;return D(new Promise((r,l)=>{if(null===n.authValue)throw Error("No auth authValue");let c=e.createSocket(n.authValue);function u(e){i=e,c.removeEventListener("message",d),l(e)}o=c;let[h,f]=U();function p(e){let t=C(e.data);t?.type===104&&f()}t.waitForActorId||f(),c.addEventListener("message",d),t.waitForActorId&&c.addEventListener("message",p),c.addEventListener("error",u),c.addEventListener("close",u),c.addEventListener("open",()=>{c.addEventListener("error",s),c.addEventListener("close",a);let e=()=>{c.removeEventListener("error",u),c.removeEventListener("close",u),c.removeEventListener("message",p)};h.then(()=>{r([c,e])})})}),1e4,"Timed out during websocket connection").then(([e,t])=>{if(t(),r.aborted)throw Error("Aborted");if(i)throw i;return e}).catch(e=>{throw l(o),e})},e=>({target:"@ok.connected",effect:e0({socket:e.data,backoffDelay:ez})}),e=>{let t=e.reason;if(t instanceof eF)return{target:"@idle.failed",effect:[eJ(2,t.message),i(t.message,-1)]};if(eQ(t)){if(4109===t.code)return"@auth.busy";if(eK(t.code))return{target:"@connecting.backoff",effect:[eW,eY(t)]};if(eU(t.code))return{target:"@idle.failed",effect:[eJ(2,t.reason),i(t.reason,t.code)]}}return{target:"@auth.backoff",effect:[eH,eY(t)]}});let c={target:"@ok.awaiting-pong",effect:e=>{e.socket?.send("ping")}},u=()=>("undefined"!=typeof document?document:void 0)?.visibilityState==="hidden"&&e.canZombie()?"@idle.zombie":c;if(o.addTimedTransition("@ok.connected",3e4,u).addTransitions("@ok.connected",{NAVIGATOR_OFFLINE:u,WINDOW_GOT_FOCUS:c}),o.addTransitions("@idle.zombie",{WINDOW_GOT_FOCUS:"@connecting.backoff"}),o.onEnter("@ok.*",e=>{e.patch({successCount:e.successCount+1});let t=setTimeout(n.unpause,0);return e=>{l(e.socket),e.patch({socket:null}),clearTimeout(t),n.pause()}}).addTransitions("@ok.awaiting-pong",{PONG:"@ok.connected"}).addTimedTransition("@ok.awaiting-pong",2e3,{target:"@connecting.busy",effect:eJ(1,"Received no pong from server, assume implicit connection loss.")}).addTransitions("@ok.*",{EXPLICIT_SOCKET_ERROR:(e,t)=>t.socket?.readyState===1?null:{target:"@connecting.backoff",effect:eH},EXPLICIT_SOCKET_CLOSE:e=>{var t;if(eU(e.event.code))return{target:"@idle.failed",effect:[eZ,i(e.event.reason,e.event.code)]};if((t=e.event.code)>=4100&&t<4200)if(4109===e.event.code)return"@auth.busy";else return{target:"@auth.backoff",effect:[eH,eX(e.event)]};return eK(e.event.code)?{target:"@connecting.backoff",effect:[eW,eX(e.event)]}:{target:"@connecting.backoff",effect:[eH,eX(e.event)]}}}),"undefined"!=typeof document){let e="undefined"!=typeof document?document:void 0,t="undefined"!=typeof window?window:void 0,n=t??e;o.onEnter("*",r=>{function i(){o.send({type:"NAVIGATOR_OFFLINE"})}function s(){o.send({type:"NAVIGATOR_ONLINE"})}function a(){e?.visibilityState==="visible"&&o.send({type:"WINDOW_GOT_FOCUS"})}return t?.addEventListener("online",s),t?.addEventListener("offline",i),n?.addEventListener("visibilitychange",a),()=>{n?.removeEventListener("visibilitychange",a),t?.removeEventListener("online",s),t?.removeEventListener("offline",i),l(r.socket)}})}let h=[],{statusDidChange:f,didConnect:p,didDisconnect:m,unsubscribe:g}=function(e){let t=j(),n=j(),r=j(),i=null,o=e.events.didEnterState.subscribe(()=>{let o=ej(e);o!==i&&t.notify(o),"connected"===i&&"connected"!==o?r.notify():"connected"!==i&&"connected"===o&&n.notify(),i=o});return{statusDidChange:t.observable,didConnect:n.observable,didDisconnect:r.observable,unsubscribe:o}}(o);return h.push(g),t.enableDebugLogging&&h.push(function(e){let t=new Date().getTime();function n(...r){b(`${((new Date().getTime()-t)/1e3).toFixed(2)} [FSM #${e.id}]`,...r)}let r=[e.events.didReceiveEvent.subscribe(e=>n(`Event ${e.type}`)),e.events.willTransition.subscribe(({from:e,to:t})=>n("Transitioning",e,"â†’",t)),e.events.didIgnoreEvent.subscribe(e=>n("Ignored event",e.type,e,"(current state won't handle it)"))];return()=>{for(let e of r)e()}}(o)),o.start(),{machine:o,cleanups:h,events:{statusDidChange:f,didConnect:p,didDisconnect:m,onMessage:n.observable,onConnectionError:r.observable}}}(e,{waitForActorId:n,enableDebugLogging:t});this.#U=r,this.events=i,this.#K=o}getStatus(){try{return ej(this.#U)}catch{return"initial"}}get authValue(){return this.#U.context.authValue}connect(){this.#U.send({type:"CONNECT"})}reconnect(){this.#U.send({type:"RECONNECT"})}disconnect(){this.#U.send({type:"DISCONNECT"})}destroy(){let e;for(this.#U.stop();e=this.#K.pop();)e()}send(e){let t=this.#U.context?.socket;null===t?b("Cannot send: not connected yet",e):1!==t.readyState?b("Cannot send: WebSocket no longer open",e):t.send(e)}_privateSendMachineEvent(e){this.#U.send(e)}},e2=Symbol();function e3(e,t){if(Object.is(e,t))return!0;let n=Array.isArray(e),r=Array.isArray(t);if(n||r){if(!n||!r)return!1;if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Object.is(e[n],t[n]))return!1;return!0}if(!O(e)||!O(t))return!1;let i=Object.keys(e);return i.length===Object.keys(t).length&&i.every(n=>Object.prototype.hasOwnProperty.call(t,n)&&Object.is(e[n],t[n]))}function e4(e,t){if(!O(e)||!O(t))return e3(e,t);let n=Object.keys(e);return n.length===Object.keys(t).length&&n.every(n=>Object.prototype.hasOwnProperty.call(t,n)&&e3(e[n],t[n]))}var e5=class e{#j;#q;constructor(e,t){this.#q=t,this.#j=e}static with(t){return e.fromAlreadySorted([],t)}static from(t,n){let r=new e([],n);for(let e of t)r.add(e);return r}static fromAlreadySorted(t,n){return new e(t,n)}clone(){return new e(this.#j.slice(),this.#q)}add(e){let t=function(e,t,n){let r=0,i=e.length;for(;r<i;){let o=r+(i-r>>1);n(t,e[o])?i=o:r=o+1}return r}(this.#j,e,this.#q);this.#j.splice(t,0,e)}clear(){let e=this.#j.length>0;return this.#j.length=0,e}removeBy(e,t=Number.POSITIVE_INFINITY){let n=0;for(let r=0;r<this.#j.length;r++)if(e(this.#j[r])){if(this.#j.splice(r,1),++n>=t)break;r--}return n>0}remove(e){let t=this.#j.indexOf(e);return t>=0&&(this.#j.splice(t,1),!0)}at(e){return this.#j[e]}get length(){return this.#j.length}*filter(e){for(let t of this.#j)e(t)&&(yield t)}*findAllRight(e){for(let t=this.#j.length-1;t>=0;t--){let n=this.#j[t];e(n,t)&&(yield n)}}[Symbol.iterator](){return this.#j[Symbol.iterator]()}*iterReversed(){for(let e=this.#j.length-1;e>=0;e--)yield this.#j[e]}find(e,t){let n=this.findIndex(e,t);return n>-1?this.#j.at(n):void 0}findIndex(e,t=0){for(let n=Math.max(0,t);n<this.#j.length;n++)if(e(this.#j[n],n))return n;return -1}findRight(e,t){let n=this.findIndexRight(e,t);return n>-1?this.#j.at(n):void 0}findIndexRight(e,t=this.#j.length-1){for(let n=Math.min(t,this.#j.length-1);n>=0;n--)if(e(this.#j[n],n))return n;return -1}get rawArray(){return this.#j}},e6=class{#z;#V;#F;#B;#H;#W;constructor(e,t,n){this.#B=e,this.#H=t,this.#W=n,this.#z=new Map,this.#V=new ef(()=>new Set),this.#F=e5.with(n)}get(e){return this.#z.get(e)}getOrThrow(e){return this.get(e)??T(`Item with id ${e} not found`)}get sorted(){return this.#F}getParentId(e){let t=this.getOrThrow(e);return this.#H(t)}getParent(e){let t=this.getParentId(e);return t?this.getOrThrow(t):null}getChildren(e){let t=this.#V.get(e);return t?Array.from(t).map(e=>this.#z.get(e)):[]}*walkUp(e,t){let n=e;do{let e=this.getOrThrow(n);(!t||t(e))&&(yield e),n=this.#H(e)}while(null!==n)}*walkLeft(e,t){let n=this.getOrThrow(e);for(let r of e5.from(this.getSiblings(e),this.#W).iterReversed())!this.#W(n,r)&&(!t||t(r))&&(yield r)}*walkRight(e,t){let n=this.getOrThrow(e);for(let r of e5.from(this.getSiblings(e),this.#W))!this.#W(r,n)&&(!t||t(r))&&(yield r)}*walkDown(e,t){let n=e5.from(this.getChildren(e),this.#W).rawArray;for(let e=n.length-1;e>=0;e--){let r=n[e];yield*this.walkDown(this.#B(r),t),(!t||t(r))&&(yield r)}}getSiblings(e){let t=this.getOrThrow(e),n=this.getParentId(e);return this.getChildren(n).filter(e=>e!==t)}[Symbol.iterator](){return this.#F[Symbol.iterator]()}upsert(e){let t=this.#B(e),n=this.#z.get(t);if(n){if(this.#H(n)!==this.#H(e))throw Error("Cannot upsert parent ID changes that change the tree structure. Remove the entry first, and recreate it");this.#F.remove(n)}this.#z.set(t,e),this.#F.add(e);let r=this.#H(e);this.#V.getOrCreate(r).add(t)}remove(e){let t=this.#z.get(e);if(!t)return!1;if(this.#V.get(e))throw Error(`Cannot remove item '${e}' while it still has children. Remove children first.`);let n=this.#H(t),r=this.#V.get(n);return r&&(r.delete(e),0===r.size&&this.#V.delete(n)),this.#F.remove(t),this.#V.delete(e),this.#z.delete(e),!0}clear(){return 0!==this.#z.size&&(this.#V.clear(),this.#z.clear(),this.#F.clear(),!0)}},e9=(e=>(e.Read="room:read",e.Write="room:write",e.PresenceWrite="room:presence:write",e.CommentsWrite="comments:write",e.CommentsRead="comments:read",e))(e9||{});function e8(e){return e.includes("room:write")}function e7(e){return e.includes("comments:write")||e.includes("room:write")}function te(e){var t;let n=e.split(".");if(3!==n.length)throw Error("Authentication error: invalid JWT token");let r=C(function(e){try{let t=e.replace(/-/g,"+").replace(/_/g,"/");return decodeURIComponent(atob(t).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}catch(t){return atob(e)}}(n[1]));if(!(r&&O(t=r)&&("acc"===t.k||"id"===t.k||"sec-legacy"===t.k)))throw Error("Authentication error: expected a valid token but did not get one. Hint: if you are using a callback, ensure the room is passed when creating the token. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientCallback");return{raw:e,parsed:r}}var tt=class{#G;#J;#Y;constructor(){this.#G=new Set,this.#J=new ef(()=>new Map),this.#Y=void 0}registerLayer(e){return this.#G.has(e)&&T(`Layer '${e}' already exists, provide a unique layer id`),this.#G.add(e),e}deregisterLayer(e){this.#G.delete(e);let t=!1;for(let[n,r]of this.#J)r.delete(e)&&(t=!0),0===r.size&&this.#J.delete(n);t&&this.invalidate()}get(){return this.#Y??=this.#a()}invalidate(){this.#Y=void 0}#a(){return Array.from(this.#J.values()).flatMap(e=>Array.from(e.values()).slice(-1).filter(E))}updateKnowledge(e,t,n){this.#G.has(e)||T(`Unknown layer key: ${e}`),this.#J.getOrCreate(t).set(e,n),this.invalidate()}};function tn(){return new Date().toISOString()}var tr=Symbol("*");async function ti(e,t,n){let r,i=await e(t,{method:"POST",headers:{"Content-Type":"application/json"},body:er(n)});if(!i.ok){let e=`${(await i.text()).trim()||"reason not provided in auth response"} (${i.status} returned by POST ${t})`;if(401===i.status||403===i.status)throw new eF(`Unauthorized: ${e}`);throw Error(`Failed to authenticate: ${e}`)}try{r=await i.json()}catch(e){throw Error(`Expected a JSON response when doing a POST request on "${t}". ${String(e)}`)}if(!O(r)||"string"!=typeof r.token)throw Error(`Expected a JSON response of the form \`{ token: "..." }\` when doing a POST request on "${t}", but got ${er(r)}`);let{token:o}=r;return{token:o}}j().observable,Date.now();var to=Symbol("notification-settings-plain");function ts(e){let t={[to]:{value:e,enumerable:!1}};for(let e of["email","slack","teams","webPush"])t[e]={enumerable:!0,get(){let t=this[to][e];return void 0===t?(_(`In order to use the '${e}' channel, please set up your project first. For more information: https://liveblocks.io/docs/errors/enable-a-notification-channel`),null):t}};return void 0!==t?Object.create(null,t):Object.create(null)}function ta(e,t){let n=ts({...e[to]});for(let e of Object.keys(t)){let r=t[e];if(void 0!==r){let t=Object.fromEntries(k(r).filter(([,e])=>void 0!==e));n[to][e]={...n[to][e],...t}}}return n}var td=tu(0),tl=tu(1),tc=td+tu(-1);function tu(e){let t=32+(e<0?95+e:e);if(t<32||t>126)throw Error(`Invalid n value: ${e}`);return String.fromCharCode(t)}function th(e,t){if(void 0!==e&&void 0!==t){var n=e,r=t;if(n<r)return tf(n,r);if(n>r)return tf(r,n);throw Error("Cannot compute value between two equal positions")}if(void 0!==e){var i=e;for(let e=0;e<=i.length-1;e++){let t=i.charCodeAt(e);if(!(t>=126))return i.substring(0,e)+String.fromCharCode(t+1)}return i+tl}if(void 0===t)return tl;{var o=t;let e=o.length-1;for(let t=0;t<=e;t++){let n=o.charCodeAt(t);if(!(n<=32))if(t!==e)return o.substring(0,t+1);else if(33===n)return o.substring(0,t)+tc;else return o.substring(0,t)+String.fromCharCode(n-1)}return tl}}function tf(e,t){let n=0,r=e.length,i=t.length;for(;;){let a=n<r?e.charCodeAt(n):32,d=n<i?t.charCodeAt(n):126;if(a===d){n++;continue}if(d-a!=1){var o,s;return o=e,((s=n)<o.length?o.substring(0,s):o+td.repeat(s-o.length))+String.fromCharCode(d+a>>1)}{let t=n+1,r=e.substring(0,t);return r.length<t&&(r+=td.repeat(t-r.length)),r+tf(e.substring(t),"")}}}function tp(e){return!function(e){if(""===e)return!1;let t=e.length-1,n=e.charCodeAt(t);if(n<33||n>126)return!1;for(let n=0;n<t;n++){let t=e.charCodeAt(n);if(t<32||t>126)return!1}return!0}(e)?function(e){let t=[];for(let n=0;n<e.length;n++){let r=e.charCodeAt(n);t.push(r<32?32:r>126?126:r)}for(;t.length>0&&32===t[t.length-1];)t.length--;return t.length>0?String.fromCharCode(...t):tl}(e):e}var tm=(e=>(e[e.INIT=0]="INIT",e[e.SET_PARENT_KEY=1]="SET_PARENT_KEY",e[e.CREATE_LIST=2]="CREATE_LIST",e[e.UPDATE_OBJECT=3]="UPDATE_OBJECT",e[e.CREATE_OBJECT=4]="CREATE_OBJECT",e[e.DELETE_CRDT=5]="DELETE_CRDT",e[e.DELETE_OBJECT_KEY=6]="DELETE_OBJECT_KEY",e[e.CREATE_MAP=7]="CREATE_MAP",e[e.CREATE_REGISTER=8]="CREATE_REGISTER",e))(tm||{});function tg(e,t,n=tp(t)){return Object.freeze({type:"HasParent",node:e,key:t,pos:n})}var ty=Object.freeze({type:"NoParent"}),tv=class{#X;#Z;#Q=ty;_getParentKeyOrThrow(){switch(this.parent.type){case"HasParent":return this.parent.key;case"NoParent":throw Error("Parent key is missing");case"Orphaned":return this.parent.oldKey;default:return eR(this.parent,"Unknown state")}}get _parentPos(){switch(this.parent.type){case"HasParent":return this.parent.pos;case"NoParent":throw Error("Parent key is missing");case"Orphaned":return this.parent.oldPos;default:return eR(this.parent,"Unknown state")}}get _pool(){return this.#X}get roomId(){return this.#X?this.#X.roomId:null}get _id(){return this.#Z}get parent(){return this.#Q}get _parentKey(){switch(this.parent.type){case"HasParent":return this.parent.key;case"NoParent":return null;case"Orphaned":return this.parent.oldKey;default:return eR(this.parent,"Unknown state")}}_apply(e,t){if(5===e.type&&"HasParent"===this.parent.type)return this.parent.node._detachChild(this);return{modified:!1}}_setParentLink(e,t){switch(this.parent.type){case"HasParent":if(this.parent.node!==e)throw Error("Cannot set parent: node already has a parent");this.#Q=tg(e,t);return;case"Orphaned":case"NoParent":this.#Q=tg(e,t);return;default:return eR(this.parent,"Unknown state")}}_attach(e,t){if(this.#Z||this.#X)throw Error("Cannot attach node: already attached");t.addNode(e,this),this.#Z=e,this.#X=t}_detach(){switch(this.#X&&this.#Z&&this.#X.deleteNode(this.#Z),this.parent.type){case"HasParent":this.#Q=function(e,t=tp(e)){return Object.freeze({type:"Orphaned",oldKey:e,oldPos:t})}(this.parent.key,this.parent.pos);break;case"NoParent":this.#Q=ty;break;case"Orphaned":break;default:eR(this.parent,"Unknown state")}this.#X=void 0}#ee;#et;#en;invalidate(){(void 0!==this.#ee||void 0!==this.#en)&&(this.#ee=void 0,this.#en=void 0,"HasParent"===this.parent.type&&this.parent.node.invalidate())}toTreeNode(e){return(void 0===this.#en||this.#et!==e)&&(this.#et=e,this.#en=this._toTreeNode(e)),this.#en}toImmutable(){return void 0===this.#ee&&(this.#ee=this._toImmutable()),this.#ee}},tb=(e=>(e[e.OBJECT=0]="OBJECT",e[e.LIST=1]="LIST",e[e.MAP=2]="MAP",e[e.REGISTER=3]="REGISTER",e))(tb||{}),t_=class e extends tv{#j;constructor(e){super(),this.#j=e}get data(){return this.#j}static _deserialize([t,n],r,i){let o=new e(n.data);return o._attach(t,i),o}_toOps(e,t,n){if(void 0===this._id)throw Error("Cannot serialize register if parentId or parentKey is undefined");return[{type:8,opId:n?.generateOpId(),id:this._id,parentId:e,parentKey:t,data:this.data}]}_serialize(){if("HasParent"!==this.parent.type)throw Error("Cannot serialize LiveRegister if parent is missing");return{type:3,parentId:eN(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key,data:this.data}}_attachChild(e){throw Error("Method not implemented.")}_detachChild(e){throw Error("Method not implemented.")}_apply(e,t){return super._apply(e,t)}_toTreeNode(e){return{type:"Json",id:this._id??ea(),key:e,payload:this.#j}}_toImmutable(){return this.#j}clone(){return R(this.data)}};function tw(e,t){let n=e._parentPos,r=t._parentPos;return n===r?0:n<r?-1:1}var tS=class e extends tv{#er;#ei;#eo;constructor(e){let t;for(let n of(super(),this.#er=[],this.#ei=new WeakSet,this.#eo=new Map,e)){let e=th(t),r=tj(n);r._setParentLink(this,e),this.#er.push(r),t=e}}static _deserialize([t],n,r){let i=new e([]);i._attach(t,r);let o=n.get(t);if(void 0===o)return i;for(let[e,t]of o){let o=tx([e,t],n,r);o._setParentLink(i,t.parentKey),i._insertAndSort(o)}return i}_toOps(e,t,n){if(void 0===this._id)throw Error("Cannot serialize item is not attached");let r=[],i={id:this._id,opId:n?.generateOpId(),type:2,parentId:e,parentKey:t};for(let e of(r.push(i),this.#er)){let t=e._getParentKeyOrThrow(),i=tC(e._toOps(this._id,t,n),void 0),o=i[0].opId;void 0!==o&&this.#eo.set(t,o),r.push(...i)}return r}_insertAndSort(e){this.#er.push(e),this._sortItems()}_sortItems(){this.#er.sort(tw),this.invalidate()}_indexOfPosition(e){return this.#er.findIndex(t=>t._getParentKeyOrThrow()===e)}_attach(e,t){for(let n of(super._attach(e,t),this.#er))n._attach(t.generateId(),t)}_detach(){for(let e of(super._detach(),this.#er))e._detach()}#es(e){if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");let{id:t,parentKey:n}=e,r=tN(e);r._attach(t,this._pool),r._setParentLink(this,n);let i=e.deletedId,o=this._indexOfPosition(n);if(-1!==o){let t=this.#er[o];if(t._id===i)return t._detach(),this.#er[o]=r,{modified:tE(this,[tO(o,r)]),reverse:[]};{this.#ei.add(t),this.#er[o]=r;let n=[tO(o,r)],i=this.#ea(e.deletedId);return i&&n.push(i),{modified:tE(this,n),reverse:[]}}}{let t=[],i=this.#ea(e.deletedId);return i&&t.push(i),this._insertAndSort(r),t.push(tT(this._indexOfPosition(n),r)),{reverse:[],modified:tE(this,t)}}}#ed(e){if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");let t=[],n=this.#ea(e.deletedId);n&&t.push(n);let r=this.#eo.get(e.parentKey);if(void 0!==r)if(r!==e.opId)return 0===t.length?{modified:!1}:{modified:tE(this,t),reverse:[]};else this.#eo.delete(e.parentKey);let i=this._indexOfPosition(e.parentKey),o=this.#er.find(t=>t._id===e.id);if(void 0!==o){if(o._parentKey===e.parentKey)return{modified:t.length>0&&tE(this,t),reverse:[]};if(-1!==i){this.#ei.add(this.#er[i]);let[e]=this.#er.splice(i,1);t.push(tA(i,e))}let n=this.#er.indexOf(o);o._setParentLink(this,e.parentKey),this._sortItems();let r=this.#er.indexOf(o);return r!==n&&t.push(tk(n,r,o)),{modified:t.length>0&&tE(this,t),reverse:[]}}{let n=this._pool.getNode(e.id);if(n&&this.#ei.has(n)){n._setParentLink(this,e.parentKey),this.#ei.delete(n),this._insertAndSort(n);let r=this.#er.indexOf(n);return{modified:tE(this,[-1===i?tT(r,n):tO(r,n),...t]),reverse:[]}}{-1!==i&&this.#er.splice(i,1);let{newItem:n,newIndex:r}=this.#el(e,e.parentKey);return{modified:tE(this,[-1===i?tT(r,n):tO(r,n),...t]),reverse:[]}}}}#ea(e){if(void 0===e||void 0===this._pool)return null;let t=this._pool.getNode(e);if(void 0===t)return null;let n=this._detachChild(t);return!1===n.modified?null:n.modified.updates[0]}#ec(e){if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");let t=tp(e.parentKey),n=this._indexOfPosition(t);-1!==n&&this.#eu(n,t);let{newItem:r,newIndex:i}=this.#el(e,t);return{modified:tE(this,[tT(i,r)]),reverse:[]}}#eh(e){let t=this.#er.find(t=>t._id===e.id),n=tp(e.parentKey),r=this._indexOfPosition(n);if(t)if(t._parentKey===n)return{modified:!1};else{let e=this.#er.indexOf(t);-1!==r&&this.#eu(r,n),t._setParentLink(this,n),this._sortItems();let i=this._indexOfPosition(n);return i===e?{modified:!1}:{modified:tE(this,[tk(e,i,t)]),reverse:[]}}{let t=eN(this._pool).getNode(e.id);if(t&&this.#ei.has(t))return t._setParentLink(this,n),this.#ei.delete(t),this._insertAndSort(t),{modified:tE(this,[tT(this._indexOfPosition(n),t)]),reverse:[]};{-1!==r&&this.#eu(r,n);let{newItem:t,newIndex:i}=this.#el(e,n);return{modified:tE(this,[tT(i,t)]),reverse:[]}}}}#ef(e){let{id:t,parentKey:n}=e,r=tN(e);if(this._pool?.getNode(t)!==void 0)return{modified:!1};r._attach(t,eN(this._pool)),r._setParentLink(this,n);let i=this._indexOfPosition(n),o=n;return -1!==i&&(o=th(this.#er[i]?._parentPos,this.#er[i+1]?._parentPos),r._setParentLink(this,o)),this._insertAndSort(r),{modified:tE(this,[tT(this._indexOfPosition(o),r)]),reverse:[{type:5,id:t}]}}#ep(e){let{id:t,parentKey:n}=e,r=tN(e);if(this._pool?.getNode(t)!==void 0)return{modified:!1};this.#eo.set(n,eN(e.opId));let i=this._indexOfPosition(n);if(r._attach(t,eN(this._pool)),r._setParentLink(this,n),-1===i)return this._insertAndSort(r),this.#ea(e.deletedId),{reverse:[{type:5,id:t}],modified:tE(this,[tT(this._indexOfPosition(n),r)])};{let t=this.#er[i];t._detach(),this.#er[i]=r;let o=tC(t._toOps(eN(this._id),n,this._pool),e.id),s=[tO(i,r)],a=this.#ea(e.deletedId);return a&&s.push(a),{modified:tE(this,s),reverse:o}}}_attachChild(e,t){let n;if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");return!1!==(n="set"===e.intent?1===t?this.#es(e):2===t?this.#ed(e):this.#ep(e):1===t?this.#ec(e):2===t?this.#eh(e):this.#ef(e)).modified&&this.invalidate(),n}_detachChild(e){if(e){let t=eN(e._parentKey),n=e._toOps(eN(this._id),t,this._pool),r=this.#er.indexOf(e);if(-1===r)return{modified:!1};let[i]=this.#er.splice(r,1);return this.invalidate(),e._detach(),{modified:tE(this,[tA(r,i)]),reverse:n}}return{modified:!1}}#em(e,t){if(this.#ei.has(t))return this.#ei.delete(t),t._setParentLink(this,e),this._insertAndSort(t),{modified:tE(this,[tT(this.#er.indexOf(t),t)]),reverse:[]};if(e===t._parentKey)return{modified:!1};let n=this._indexOfPosition(e);if(-1===n){let n=this.#er.indexOf(t);t._setParentLink(this,e),this._sortItems();let r=this.#er.indexOf(t);return r===n?{modified:!1}:{modified:tE(this,[tk(n,r,t)]),reverse:[]}}{this.#er[n]._setParentLink(this,th(e,this.#er[n+1]?._parentPos));let r=this.#er.indexOf(t);t._setParentLink(this,e),this._sortItems();let i=this.#er.indexOf(t);return i===r?{modified:!1}:{modified:tE(this,[tk(r,i,t)]),reverse:[]}}}#eg(e,t){let n=eN(t._parentKey);if(this.#ei.has(t)){let n=this._indexOfPosition(e);return this.#ei.delete(t),-1!==n&&this.#er[n]._setParentLink(this,th(e,this.#er[n+1]?._parentPos)),t._setParentLink(this,e),this._insertAndSort(t),{modified:!1}}{if(e===n)return{modified:!1};let r=this.#er.indexOf(t),i=this._indexOfPosition(e);-1!==i&&this.#er[i]._setParentLink(this,th(e,this.#er[i+1]?._parentPos)),t._setParentLink(this,e),this._sortItems();let o=this.#er.indexOf(t);return r===o?{modified:!1}:{modified:tE(this,[tk(r,o,t)]),reverse:[]}}}#ey(e,t){let n=eN(t._parentKey),r=this.#er.indexOf(t),i=this._indexOfPosition(e);-1!==i&&this.#er[i]._setParentLink(this,th(e,this.#er[i+1]?._parentPos)),t._setParentLink(this,e),this._sortItems();let o=this.#er.indexOf(t);return r===o?{modified:!1}:{modified:tE(this,[tk(r,o,t)]),reverse:[{type:1,id:eN(t._id),parentKey:n}]}}_setChildKey(e,t,n){return 1===n?this.#em(e,t):2===n?this.#eg(e,t):this.#ey(e,t)}_apply(e,t){return super._apply(e,t)}_serialize(){if("HasParent"!==this.parent.type)throw Error("Cannot serialize LiveList if parent is missing");return{type:1,parentId:eN(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key}}get length(){return this.#er.length}push(e){return this._pool?.assertStorageIsWritable(),this.insert(e,this.length)}insert(e,t){if(this._pool?.assertStorageIsWritable(),t<0||t>this.#er.length)throw Error(`Cannot insert list item at index "${t}". index should be between 0 and ${this.#er.length}`);let n=th(this.#er[t-1]?this.#er[t-1]._parentPos:void 0,this.#er[t]?this.#er[t]._parentPos:void 0),r=tj(e);if(r._setParentLink(this,n),this._insertAndSort(r),this._pool&&this._id){let e=this._pool.generateId();r._attach(e,this._pool),this._pool.dispatch(r._toOps(this._id,n,this._pool),[{type:5,id:e}],new Map([[this._id,tE(this,[tT(t,r)])]]))}}move(e,t){if(this._pool?.assertStorageIsWritable(),t<0)throw Error("targetIndex cannot be less than 0");if(t>=this.#er.length)throw Error("targetIndex cannot be greater or equal than the list length");if(e<0)throw Error("index cannot be less than 0");if(e>=this.#er.length)throw Error("index cannot be greater or equal than the list length");let n=null,r=null;e<t?(r=t===this.#er.length-1?void 0:this.#er[t+1]._parentPos,n=this.#er[t]._parentPos):(r=this.#er[t]._parentPos,n=0===t?void 0:this.#er[t-1]._parentPos);let i=th(n,r),o=this.#er[e],s=o._getParentKeyOrThrow();if(o._setParentLink(this,i),this._sortItems(),this._pool&&this._id){let n=new Map([[this._id,tE(this,[tk(e,t,o)])]]);this._pool.dispatch([{type:1,id:eN(o._id),opId:this._pool.generateOpId(),parentKey:i}],[{type:1,id:eN(o._id),parentKey:s}],n)}}delete(e){if(this._pool?.assertStorageIsWritable(),e<0||e>=this.#er.length)throw Error(`Cannot delete list item at index "${e}". index should be between 0 and ${this.#er.length-1}`);let t=this.#er[e];t._detach();let[n]=this.#er.splice(e,1);if(this.invalidate(),this._pool){let r=t._id;if(r){let i=new Map;i.set(eN(this._id),tE(this,[tA(e,n)])),this._pool.dispatch([{id:r,opId:this._pool.generateOpId(),type:5}],t._toOps(eN(this._id),t._getParentKeyOrThrow()),i)}}}clear(){if(this._pool?.assertStorageIsWritable(),this._pool){let e=[],t=[],n=[];for(let r of this.#er){r._detach();let i=r._id;i&&(e.push({type:5,id:i,opId:this._pool.generateOpId()}),t.push(...r._toOps(eN(this._id),r._getParentKeyOrThrow())),n.push(tA(0,r)))}this.#er=[],this.invalidate();let r=new Map;r.set(eN(this._id),tE(this,n)),this._pool.dispatch(e,t,r)}else{for(let e of this.#er)e._detach();this.#er=[],this.invalidate()}}set(e,t){if(this._pool?.assertStorageIsWritable(),e<0||e>=this.#er.length)throw Error(`Cannot set list item at index "${e}". index should be between 0 and ${this.#er.length-1}`);let n=this.#er[e],r=n._getParentKeyOrThrow(),i=n._id;n._detach();let o=tj(t);if(o._setParentLink(this,r),this.#er[e]=o,this.invalidate(),this._pool&&this._id){let t=this._pool.generateId();o._attach(t,this._pool);let s=new Map;s.set(this._id,tE(this,[tO(e,o)]));let a=tC(o._toOps(this._id,r,this._pool),i);this.#eo.set(r,eN(a[0].opId));let d=tC(n._toOps(this._id,r,void 0),t);this._pool.dispatch(a,d,s)}}toArray(){return this.#er.map(e=>tK(e))}every(e){return this.toArray().every(e)}filter(e){return this.toArray().filter(e)}find(e){return this.toArray().find(e)}findIndex(e){return this.toArray().findIndex(e)}forEach(e){return this.toArray().forEach(e)}get(e){if(!(e<0)&&!(e>=this.#er.length))return tK(this.#er[e])}indexOf(e,t){return this.toArray().indexOf(e,t)}lastIndexOf(e,t){return this.toArray().lastIndexOf(e,t)}map(e){return this.#er.map((t,n)=>e(tK(t),n))}some(e){return this.toArray().some(e)}[Symbol.iterator](){return new tI(this.#er)}#el(e,t){let n=tN(e);return n._attach(e.id,eN(this._pool)),n._setParentLink(this,t),this._insertAndSort(n),{newItem:n,newIndex:this._indexOfPosition(t)}}#eu(e,t){let n=th(t,this.#er.length>e+1?this.#er[e+1]?._parentPos:void 0);this.#er[e]._setParentLink(this,n)}_toTreeNode(e){return{type:"LiveList",id:this._id??ea(),key:e,payload:this.#er.map((e,t)=>e.toTreeNode(t.toString()))}}toImmutable(){return super.toImmutable()}_toImmutable(){return this.#er.map(e=>e.toImmutable())}clone(){return new e(this.#er.map(e=>e.clone()))}},tI=class{#ev;constructor(e){this.#ev=e[Symbol.iterator]()}[Symbol.iterator](){return this}next(){let e=this.#ev.next();return e.done?{done:!0,value:void 0}:{value:tK(e.value)}}};function tE(e,t){return{node:e,type:"LiveList",updates:t}}function tO(e,t){return{index:e,type:"set",item:t instanceof t_?t.data:t}}function tA(e,t){return{type:"delete",index:e,deletedItem:t instanceof t_?t.data:t}}function tT(e,t){return{index:e,type:"insert",item:t instanceof t_?t.data:t}}function tk(e,t,n){return{type:"move",index:t,item:n instanceof t_?n.data:n,previousIndex:e}}function tC(e,t){return e.map((e,n)=>0===n?{...e,intent:"set",deletedId:t}:e)}var tR=class e extends tv{#eb;#e_;constructor(e){if(super(),this.#e_=new Map,e){let t=[];for(let[n,r]of e){let e=tj(r);e._setParentLink(this,n),t.push([n,e])}this.#eb=new Map(t)}else this.#eb=new Map}_toOps(e,t,n){if(void 0===this._id)throw Error("Cannot serialize item is not attached");let r=[],i={id:this._id,opId:n?.generateOpId(),type:7,parentId:e,parentKey:t};for(let[e,t]of(r.push(i),this.#eb))r.push(...t._toOps(this._id,e,n));return r}static _deserialize([t,n],r,i){let o=new e;o._attach(t,i);let s=r.get(t);if(void 0===s)return o;for(let[e,t]of s){let n=tx([e,t],r,i);n._setParentLink(o,t.parentKey),o.#eb.set(t.parentKey,n),o.invalidate()}return o}_attach(e,t){for(let[n,r]of(super._attach(e,t),this.#eb))tM(r)&&r._attach(t.generateId(),t)}_attachChild(e,t){let n;if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");let{id:r,parentKey:i,opId:o}=e,s=tN(e);if(void 0!==this._pool.getNode(r))return{modified:!1};if(2===t){let e=this.#e_.get(i);if(e===o)return this.#e_.delete(i),{modified:!1};if(void 0!==e)return{modified:!1}}else 1===t&&this.#e_.delete(i);let a=this.#eb.get(i);if(a){let e=eN(this._id);n=a._toOps(e,i),a._detach()}else n=[{type:5,id:r}];return s._setParentLink(this,i),s._attach(r,this._pool),this.#eb.set(i,s),this.invalidate(),{modified:{node:this,type:"LiveMap",updates:{[i]:{type:"update"}}},reverse:n}}_detach(){for(let e of(super._detach(),this.#eb.values()))e._detach()}_detachChild(e){let t=eN(this._id),n=eN(e._parentKey),r=e._toOps(t,n,this._pool);for(let[t,n]of this.#eb)n===e&&(this.#eb.delete(t),this.invalidate());return e._detach(),{modified:{node:this,type:"LiveMap",updates:{[n]:{type:"delete"}}},reverse:r}}_serialize(){if("HasParent"!==this.parent.type)throw Error("Cannot serialize LiveMap if parent is missing");return{type:2,parentId:eN(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key}}get(e){let t=this.#eb.get(e);if(void 0!==t)return tK(t)}set(e,t){this._pool?.assertStorageIsWritable();let n=this.#eb.get(e);n&&n._detach();let r=tj(t);if(r._setParentLink(this,e),this.#eb.set(e,r),this.invalidate(),this._pool&&this._id){let t=this._pool.generateId();r._attach(t,this._pool);let i=new Map;i.set(this._id,{node:this,type:"LiveMap",updates:{[e]:{type:"update"}}});let o=r._toOps(this._id,e,this._pool);this.#e_.set(e,eN(o[0].opId)),this._pool.dispatch(r._toOps(this._id,e,this._pool),n?n._toOps(this._id,e):[{type:5,id:t}],i)}}get size(){return this.#eb.size}has(e){return this.#eb.has(e)}delete(e){this._pool?.assertStorageIsWritable();let t=this.#eb.get(e);if(void 0===t)return!1;if(t._detach(),this.#eb.delete(e),this.invalidate(),this._pool&&t._id){let n=eN(this._id),r=new Map;r.set(n,{node:this,type:"LiveMap",updates:{[e]:{type:"delete"}}}),this._pool.dispatch([{type:5,id:t._id,opId:this._pool.generateOpId()}],t._toOps(n,e),r)}return!0}entries(){let e=this.#eb.entries();return{[Symbol.iterator](){return this},next(){let t=e.next();return t.done?{done:!0,value:void 0}:{value:[t.value[0],tK(t.value[1])]}}}}[Symbol.iterator](){return this.entries()}keys(){return this.#eb.keys()}values(){let e=this.#eb.values();return{[Symbol.iterator](){return this},next(){let t=e.next();return t.done?{done:!0,value:void 0}:{value:tK(t.value)}}}}forEach(e){for(let t of this)e(t[1],t[0],this)}_toTreeNode(e){return{type:"LiveMap",id:this._id??ea(),key:e,payload:Array.from(this.#eb.entries()).map(([e,t])=>t.toTreeNode(e))}}toImmutable(){return super.toImmutable()}_toImmutable(){let e=new Map;for(let[t,n]of this.#eb)e.set(t,n.toImmutable());return q(e)}clone(){return new e(Array.from(this.#eb).map(([e,t])=>[e,t.clone()]))}},tP=class e extends tv{#eb;#ew;static detectLargeObjects=!1;static #eS(e){let t=new Map,n=null;for(let[i,o]of e){var r;if(0!==o.type||void 0!==(r=o).parentId&&void 0!==r.parentKey){let e=[i,o],n=t.get(o.parentId);void 0!==n?n.push(e):t.set(o.parentId,[e])}else n=[i,o]}if(null===n)throw Error("Root can't be null");return[n,t]}static _fromItems(t,n){let[r,i]=e.#eS(t);return e._deserialize(r,i,n)}constructor(e={}){super(),this.#ew=new Map;let t=N(e);for(let e of Object.keys(t)){let n=t[e];tM(n)&&n._setParentLink(this,e)}this.#eb=new Map(Object.entries(t))}_toOps(e,t,n){if(void 0===this._id)throw Error("Cannot serialize item is not attached");let r=n?.generateOpId(),i=[],o={type:4,id:this._id,opId:r,parentId:e,parentKey:t,data:{}};for(let[e,t]of(i.push(o),this.#eb))tM(t)?i.push(...t._toOps(this._id,e,n)):o.data[e]=t;return i}static _deserialize([t,n],r,i){let o=new e(n.data);return o._attach(t,i),this._deserializeChildren(o,r,i)}static _deserializeChildren(e,t,n){let r=t.get(eN(e._id));if(void 0===r)return e;for(let[i,o]of r){let r=function([e,t],n,r){switch(t.type){case 0:return tP._deserialize([e,t],n,r);case 1:return tS._deserialize([e,t],n,r);case 2:return tR._deserialize([e,t],n,r);case 3:return t.data;default:throw Error("Unexpected CRDT type")}}([i,o],t,n);tL(r)&&r._setParentLink(e,o.parentKey),e.#eb.set(o.parentKey,r),e.invalidate()}return e}_attach(e,t){for(let[n,r]of(super._attach(e,t),this.#eb))tM(r)&&r._attach(t.generateId(),t)}_attachChild(e,t){let n;if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");let{id:r,opId:i,parentKey:o}=e,s=tD(e);if(void 0!==this._pool.getNode(r))return this.#ew.get(o)===i&&this.#ew.delete(o),{modified:!1};if(0===t)this.#ew.set(o,eN(i));else if(void 0===this.#ew.get(o));else if(this.#ew.get(o)===i)return this.#ew.delete(o),{modified:!1};else return{modified:!1};let a=eN(this._id),d=this.#eb.get(o);return tM(d)?(n=d._toOps(a,o),d._detach()):n=void 0===d?[{type:6,id:a,key:o}]:[{type:3,id:a,data:{[o]:d}}],this.#eb.set(o,s),this.invalidate(),tL(s)&&(s._setParentLink(this,o),s._attach(r,this._pool)),{reverse:n,modified:{node:this,type:"LiveObject",updates:{[o]:{type:"update"}}}}}_detachChild(e){if(e){let t=eN(this._id),n=eN(e._parentKey),r=e._toOps(t,n,this._pool);for(let[t,n]of this.#eb)n===e&&(this.#eb.delete(t),this.invalidate());return e._detach(),{modified:{node:this,type:"LiveObject",updates:{[n]:{type:"delete"}}},reverse:r}}return{modified:!1}}_detach(){for(let e of(super._detach(),this.#eb.values()))tM(e)&&e._detach()}_apply(e,t){return 3===e.type?this.#eI(e,t):6===e.type?this.#eE(e,t):super._apply(e,t)}_serialize(){let e={};for(let[t,n]of this.#eb)tM(n)||(e[t]=n);return"HasParent"===this.parent.type&&this.parent.node._id?{type:0,parentId:this.parent.node._id,parentKey:this.parent.key,data:e}:{type:0,data:e}}#eI(e,t){let n=!1,r=eN(this._id),i=[],o={type:3,id:r,data:{}};for(let t in e.data){let e=this.#eb.get(t);tM(e)?(i.push(...e._toOps(r,t)),e._detach()):void 0!==e?o.data[t]=e:void 0===e&&i.push({type:6,id:r,key:t})}let s={};for(let r in e.data){let i=e.data[r];if(void 0===i)continue;if(t)this.#ew.set(r,eN(e.opId));else if(void 0===this.#ew.get(r))n=!0;else{if(this.#ew.get(r)!==e.opId)continue;this.#ew.delete(r);continue}let o=this.#eb.get(r);tM(o)&&o._detach(),n=!0,s[r]={type:"update"},this.#eb.set(r,i),this.invalidate()}return 0!==Object.keys(o.data).length&&i.unshift(o),n?{modified:{node:this,type:"LiveObject",updates:s},reverse:i}:{modified:!1}}#eE(e,t){let n=e.key;if(!1===this.#eb.has(n)||!t&&void 0!==this.#ew.get(n))return{modified:!1};let r=this.#eb.get(n),i=eN(this._id),o=[];return tM(r)?(o=r._toOps(i,e.key),r._detach()):void 0!==r&&(o=[{type:3,id:i,data:{[n]:r}}]),this.#eb.delete(n),this.invalidate(),{modified:{node:this,type:"LiveObject",updates:{[e.key]:{type:"delete"}}},reverse:o}}toObject(){return Object.fromEntries(this.#eb)}set(e,t){this._pool?.assertStorageIsWritable(),this.update({[e]:t})}get(e){return this.#eb.get(e)}delete(e){let t;this._pool?.assertStorageIsWritable();let n=this.#eb.get(e);if(void 0===n)return;if(void 0===this._pool||void 0===this._id){tM(n)&&n._detach(),this.#eb.delete(e),this.invalidate();return}tM(n)?(n._detach(),t=n._toOps(this._id,e)):t=[{type:3,data:{[e]:n},id:this._id}],this.#eb.delete(e),this.invalidate();let r=new Map;r.set(this._id,{node:this,type:"LiveObject",updates:{[e]:{type:"delete"}}}),this._pool.dispatch([{type:6,key:e,id:this._id,opId:this._pool.generateOpId()}],t,r)}update(t){if(this._pool?.assertStorageIsWritable(),e.detectLargeObjects){let e={};for(let[t,n]of this.#eb)tM(n)||(e[t]=n);for(let n of Object.keys(t)){let r=t[n];void 0!==r&&(tM(r)||(e[n]=r))}let n=JSON.stringify(e);if(4*n.length>131072){let e=new TextEncoder().encode(n).length;if(e>131072)throw Error(`LiveObject size exceeded limit: ${e} bytes > 131072 bytes. See https://liveblocks.io/docs/platform/limits#Liveblocks-Storage-limits`)}}if(void 0===this._pool||void 0===this._id){for(let e in t){let n=t[e];if(void 0===n)continue;let r=this.#eb.get(e);tM(r)&&r._detach(),tM(n)&&n._setParentLink(this,e),this.#eb.set(e,n),this.invalidate()}return}let n=[],r=[],i=this._pool.generateOpId(),o={},s={id:this._id,type:3,data:{}},a={};for(let e in t){let d=t[e];if(void 0===d)continue;let l=this.#eb.get(e);if(tM(l)?(r.push(...l._toOps(this._id,e)),l._detach()):void 0===l?r.push({type:6,id:this._id,key:e}):s.data[e]=l,tM(d)){d._setParentLink(this,e),d._attach(this._pool.generateId(),this._pool);let t=d._toOps(this._id,e,this._pool),r=t.find(e=>e.parentId===this._id);r&&this.#ew.set(e,eN(r.opId)),n.push(...t)}else o[e]=d,this.#ew.set(e,i);this.#eb.set(e,d),this.invalidate(),a[e]={type:"update"}}0!==Object.keys(s.data).length&&r.unshift(s),0!==Object.keys(o).length&&n.unshift({opId:i,id:this._id,type:3,data:o});let d=new Map;d.set(this._id,{node:this,type:"LiveObject",updates:a}),this._pool.dispatch(n,r,d)}toImmutable(){return super.toImmutable()}toTreeNode(e){return super.toTreeNode(e)}_toTreeNode(e){let t=this._id??ea();return{type:"LiveObject",id:t,key:e,payload:Array.from(this.#eb.entries()).map(([e,n])=>tM(n)?n.toTreeNode(e):{type:"Json",id:`${t}:${e}`,key:e,payload:n})}}_toImmutable(){let e={};for(let[t,n]of this.#eb)e[t]=tL(n)?n.toImmutable():n;return e}clone(){return new e(Object.fromEntries(Array.from(this.#eb).map(([e,t])=>[e,tL(t)?t.clone():R(t)])))}};function tN(e){return tj(tD(e))}function tD(e){switch(e.type){case 8:return e.data;case 4:return new tP(e.data);case 7:return new tR;case 2:return new tS([]);default:return eR(e,"Unknown creation Op")}}function tx([e,t],n,r){switch(t.type){case 0:return tP._deserialize([e,t],n,r);case 1:return tS._deserialize([e,t],n,r);case 2:return tR._deserialize([e,t],n,r);case 3:return t_._deserialize([e,t],n,r);default:throw Error("Unexpected CRDT type")}}function tL(e){return t$(e)||e instanceof tR||tU(e)}function tM(e){return tL(e)||e instanceof t_}function t$(e){return e instanceof tS}function tU(e){return e instanceof tP}function tK(e){return e instanceof t_?e.data:e instanceof tS||e instanceof tR||e instanceof tP?e:eR(e,"Unknown AbstractCrdt")}function tj(e){return e instanceof tP||e instanceof tR||e instanceof tS?e:new t_(e)}function tq(e,t){if(void 0===e)return t;if("LiveObject"===e.type&&"LiveObject"===t.type||"LiveMap"===e.type&&"LiveMap"===t.type){let n=e.updates;for(let[e,r]of k(t.updates))n[e]=r;return{...t,updates:n}}if("LiveList"===e.type&&"LiveList"===t.type){let n=e.updates;return{...t,updates:n.concat(t.updates)}}return t}var tz=class{#j;#eO;#eA;#u;constructor(){this.#j={},this.#eO=0,this.#eA=1,this.#u=0}get length(){return this.#u}*[Symbol.iterator](){let e=this.#u,t=this.#eO;for(let n=0;n<e;n++)yield this.#j[t+n]}push(e){let t=Array.isArray(e)?e:[e];for(let e of(this.#eA>Number.MAX_SAFE_INTEGER-t.length-1&&T("Deque full"),t))this.#j[this.#eA++-1]=e;this.#u+=t.length}pop(){if(this.#u<1)return;this.#eA--;let e=this.#j[this.#eA-1];return delete this.#j[this.#eA-1],this.#u--,e}pushLeft(e){let t=Array.isArray(e)?e:[e];this.#eO<Number.MIN_SAFE_INTEGER+t.length&&T("Deque full");for(let e=t.length-1;e>=0;e--)this.#j[--this.#eO]=t[e];this.#u+=t.length}popLeft(){if(this.#u<1)return;let e=this.#j[this.#eO];return delete this.#j[this.#eO],this.#eO++,this.#u--,e}};function tV(e){return Array.isArray(e)}var tF=(e=>(e[e.UPDATE_PRESENCE=100]="UPDATE_PRESENCE",e[e.BROADCAST_EVENT=103]="BROADCAST_EVENT",e[e.FETCH_STORAGE=200]="FETCH_STORAGE",e[e.UPDATE_STORAGE=201]="UPDATE_STORAGE",e[e.FETCH_YDOC=300]="FETCH_YDOC",e[e.UPDATE_YDOC=301]="UPDATE_YDOC",e))(tF||{}),tB=class{#eT;#ek;signal;constructor(){this.#eT=new ee({connections:new Map,presences:new Map}),this.signal=Q.from(this.#eT,e=>P(Array.from(this.#eT.get().presences.keys()).map(e=>this.getUser(Number(e))))),this.#ek=new Map}get(){return this.signal.get()}connectionIds(){return this.#eT.get().connections.keys()}clearOthers(){this.#eT.mutate(e=>{e.connections.clear(),e.presences.clear(),this.#ek.clear()})}#eC(e){let t=this.#eT.get(),n=t.connections.get(e),r=t.presences.get(e);if(void 0!==n&&void 0!==r){let{connectionId:e,id:t,info:i}=n,o=e8(n.scopes);return q(N({connectionId:e,id:t,info:i,canWrite:o,canComment:e7(n.scopes),isReadOnly:!o,presence:r}))}}getUser(e){let t=this.#ek.get(e);if(t)return t;let n=this.#eC(e);if(n)return this.#ek.set(e,n),n}#eR(e){this.#ek.delete(e)}setConnection(e,t,n,r){this.#eT.mutate(i=>(i.connections.set(e,q({connectionId:e,id:t,info:n,scopes:r})),!!i.presences.has(e)&&this.#eR(e)))}removeConnection(e){this.#eT.mutate(t=>{t.connections.delete(e),t.presences.delete(e),this.#eR(e)})}setOther(e,t){this.#eT.mutate(n=>(n.presences.set(e,q(N(t))),!!n.connections.has(e)&&this.#eR(e)))}patchOther(e,t){this.#eT.mutate(n=>{let r=n.presences.get(e);if(void 0===r)return!1;let i=G(r,t);return r!==i&&(n.presences.set(e,q(i)),this.#eR(e))})}},tH=class e extends Error{context;constructor(e,t,n){super(e,{cause:n}),this.context=t,this.name="LiveblocksError"}get roomId(){return this.context.roomId}get code(){return this.context.code}static from(t,n){return new e(function(e){switch(e.type){case"ROOM_CONNECTION_ERROR":switch(e.code){case 4001:return"Not allowed to connect to the room";case 4005:return"Room is already full";case 4006:return"Kicked out of the room, because the room ID changed";default:return"Could not connect to the room"}case"AI_CONNECTION_ERROR":if(4001===e.code)return"Not allowed to connect to ai";return"Could not connect to the room";case"CREATE_THREAD_ERROR":return"Could not create new thread";case"DELETE_THREAD_ERROR":return"Could not delete thread";case"EDIT_THREAD_METADATA_ERROR":return"Could not edit thread metadata";case"MARK_THREAD_AS_RESOLVED_ERROR":return"Could not mark thread as resolved";case"MARK_THREAD_AS_UNRESOLVED_ERROR":return"Could not mark thread as unresolved";case"SUBSCRIBE_TO_THREAD_ERROR":return"Could not subscribe to thread";case"UNSUBSCRIBE_FROM_THREAD_ERROR":return"Could not unsubscribe from thread";case"CREATE_COMMENT_ERROR":return"Could not create new comment";case"EDIT_COMMENT_ERROR":return"Could not edit comment";case"DELETE_COMMENT_ERROR":return"Could not delete comment";case"ADD_REACTION_ERROR":return"Could not add reaction";case"REMOVE_REACTION_ERROR":return"Could not remove reaction";case"MARK_INBOX_NOTIFICATION_AS_READ_ERROR":return"Could not mark inbox notification as read";case"DELETE_INBOX_NOTIFICATION_ERROR":return"Could not delete inbox notification";case"MARK_ALL_INBOX_NOTIFICATIONS_AS_READ_ERROR":return"Could not mark all inbox notifications as read";case"DELETE_ALL_INBOX_NOTIFICATIONS_ERROR":return"Could not delete all inbox notifications";case"UPDATE_ROOM_SUBSCRIPTION_SETTINGS_ERROR":return"Could not update room subscription settings";case"UPDATE_NOTIFICATION_SETTINGS_ERROR":return"Could not update notification settings";case"LARGE_MESSAGE_ERROR":return"Could not send large message";default:return eR(e,"Unhandled case")}}(t),t,n)}};function tW(e,t){return{type:"User",id:`${t.connectionId}`,key:e,payload:{connectionId:t.connectionId,id:t.id,info:t.info,presence:t.presence,isReadOnly:!t.canWrite}}}function tG(e){var t,n;let r=tJ("throttle",e.throttle??100,16,1e3),i=tJ("lostConnectionTimeout",e.lostConnectionTimeout??5e3,200,3e4,1e3),s=tY(e.backgroundKeepAliveTimeout),a="string"==typeof(t=e.baseUrl)&&t.startsWith("http")?t:"https://api.liveblocks.io",d=new Y(void 0),g=function(e,t){let n=function(e){let{publicApiKey:t,authEndpoint:n}=e;if(void 0!==n&&void 0!==t)throw Error("You cannot simultaneously use `publicApiKey` and `authEndpoint` options. Please pick one and leave the other option unspecified. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClient");if("string"==typeof t){if(t.startsWith("sk_"))throw Error("Invalid `publicApiKey` option. The value you passed is a secret key, which should not be used from the client. Please only ever pass a public key here. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientPublicKey");if(!t.startsWith("pk_"))throw Error("Invalid key. Please use the public key format: pk_<public key>. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientPublicKey");return{type:"public",publicApiKey:t}}if("string"==typeof n)return{type:"private",url:n};if("function"==typeof n)return{type:"custom",callback:n};if(void 0!==n)throw Error("The `authEndpoint` option must be a string or a function. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientAuthEndpoint");throw Error("Invalid Liveblocks client options. Please provide either a `publicApiKey` or `authEndpoint` option. They cannot both be empty. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClient")}(e),r=new Set,i=[],o=[],s=new Map;function a(e,t){return"comments:read"===e?t.includes("comments:read")||t.includes("comments:write")||t.includes("room:read")||t.includes("room:write"):"room:read"===e&&(t.includes("room:read")||t.includes("room:write"))}async function d(i){let o=e.polyfills?.fetch??("undefined"==typeof window?void 0:window.fetch);if("private"===n.type){if(void 0===o)throw new eF("To use Liveblocks client in a non-DOM environment with a url as auth endpoint, you need to provide a fetch polyfill.");let e=te((await ti(o,n.url,{room:i.roomId})).token);if(r.has(e.raw))throw new eF("The same Liveblocks auth token was issued from the backend before. Caching Liveblocks tokens is not supported.");return t?.(e.parsed),e}if("custom"===n.type){let e=await n.callback(i.roomId);if(e&&"object"==typeof e){if("string"==typeof e.token){let n=te(e.token);return t?.(n.parsed),n}else if("string"==typeof e.error){let t=`Authentication failed: ${"reason"in e&&"string"==typeof e.reason?e.reason:"Forbidden"}`;if("forbidden"===e.error)throw new eF(t);throw Error(t)}}throw Error('Your authentication callback function should return a token, but it did not. Hint: the return value should look like: { token: "..." }')}throw Error("Unexpected authentication type. Must be private or custom.")}return{reset:function(){r.clear(),i.length=0,o.length=0,s.clear()},getAuthValue:async function(e){let t;if("public"===n.type)return{type:"public",publicApiKey:n.publicApiKey};let l=function(e){let t=Math.ceil(Date.now()/1e3);for(let n=i.length-1;n>=0;n--){let r=i[n];if(o[n]<=t){i.splice(n,1),o.splice(n,1);continue}if("id"===r.parsed.k)return r;if("acc"===r.parsed.k){if(!e.roomId&&0===Object.entries(r.parsed.perms).length)return r;for(let[t,n]of Object.entries(r.parsed.perms))if(e.roomId){if(t.includes("*")&&e.roomId.startsWith(t.replace("*",""))||e.roomId===t&&a(e.requestedScope,n))return r}else if(t.includes("*")&&a(e.requestedScope,n))return r}}}(e);if(void 0!==l)return{type:"secret",token:l};e.roomId?void 0===(t=s.get(e.roomId))&&(t=d(e),s.set(e.roomId,t)):void 0===(t=s.get("liveblocks-user-token"))&&(t=d(e),s.set("liveblocks-user-token",t));try{let e=await t,n=Math.floor(Date.now()/1e3)+(e.parsed.exp-e.parsed.iat)-30;return r.add(e.raw),"sec-legacy"!==e.parsed.k&&(i.push(e),o.push(n)),{type:"secret",token:e}}finally{e.roomId?s.delete(e.roomId):s.delete("liveblocks-user-token")}}}}(e,e=>{let t="sec-legacy"===e.k?e.id:e.uid;d.set(()=>t)}),y=function({baseUrl:e,authManager:t,currentUserId:n,fetchPolyfill:r}){let i=new eC(e,r);async function o(e){let n=await i.get(eO`/v2/c/rooms/${e.roomId}/threads/delta`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),{since:e.since.toISOString()},{signal:e.signal});return{threads:{updated:n.data.map(c),deleted:n.deletedThreads.map(f)},inboxNotifications:{updated:n.inboxNotifications.map(u),deleted:n.deletedInboxNotifications.map(p)},subscriptions:{updated:n.subscriptions.map(h),deleted:n.deletedSubscriptions.map(m)},requestedAt:new Date(n.meta.requestedAt),permissionHints:n.meta.permissionHints}}async function s(e){let n;e.query&&(n=em(e.query));try{let r=await i.get(eO`/v2/c/rooms/${e.roomId}/threads`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),{cursor:e.cursor,query:n,limit:50});return{threads:r.data.map(c),inboxNotifications:r.inboxNotifications.map(u),subscriptions:r.subscriptions.map(h),nextCursor:r.meta.nextCursor,requestedAt:new Date(r.meta.requestedAt),permissionHints:r.meta.permissionHints}}catch(e){if(e instanceof L&&404===e.status)return{threads:[],inboxNotifications:[],subscriptions:[],nextCursor:null,requestedAt:new Date(Date.now()-216e5),permissionHints:{}};throw e}}async function a(e){let n=e.commentId??ec(),r=e.threadId??el();return c(await i.post(eO`/v2/c/rooms/${e.roomId}/threads`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),{id:r,comment:{id:n,body:e.body,attachmentIds:e.attachmentIds},metadata:e.metadata}))}async function d(e){await i.delete(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}))}async function g(e){let n=await i.rawGet(eO`/v2/c/rooms/${e.roomId}/thread-with-notification/${e.threadId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}));if(n.ok){let e=await n.json();return{thread:c(e.thread),inboxNotification:e.inboxNotification?u(e.inboxNotification):void 0,subscription:e.subscription?h(e.subscription):void 0}}if(404===n.status)return{thread:void 0,inboxNotification:void 0,subscription:void 0};throw Error(`There was an error while getting thread ${e.threadId}.`)}async function y(e){return await i.post(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}/metadata`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),e.metadata)}async function v(e){let n=e.commentId??ec();return l(await i.post(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}/comments`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),{id:n,body:e.body,attachmentIds:e.attachmentIds}))}async function b(e){return l(await i.post(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}/comments/${e.commentId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),{body:e.body,attachmentIds:e.attachmentIds}))}async function _(e){await i.delete(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}/comments/${e.commentId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}))}async function w(e){var n;return{...n=await i.post(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}/comments/${e.commentId}/reactions`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),{emoji:e.emoji}),createdAt:new Date(n.createdAt)}}async function S(e){await i.delete(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}/comments/${e.commentId}/reactions/${e.emoji}`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}))}async function I(e){await i.post(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}/mark-as-resolved`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}))}async function E(e){await i.post(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}/mark-as-unresolved`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}))}async function O(e){return h(await i.post(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}/subscribe`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId})))}async function A(e){await i.post(eO`/v2/c/rooms/${e.roomId}/threads/${e.threadId}/unsubscribe`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}))}async function T(e){let n=e.roomId,r=e.signal,o=e.attachment,s=r?new DOMException(`Upload of attachment ${e.attachment.id} was aborted.`,"AbortError"):void 0;if(r?.aborted)throw s;let a=e=>{if(r?.aborted)throw s;if(e instanceof L&&413===e.status)throw e;return!1},d=[2e3,2e3,2e3,2e3,2e3,2e3,2e3,2e3,2e3,2e3];if(o.size<=5242880)return $(async()=>i.putBlob(eO`/v2/c/rooms/${n}/attachments/${o.id}/upload/${encodeURIComponent(o.name)}`,await t.getAuthValue({requestedScope:"comments:read",roomId:n}),o.file,{fileSize:o.size},{signal:r}),10,d,a);{let e,l=[],c=await $(async()=>i.post(eO`/v2/c/rooms/${n}/attachments/${o.id}/multipart/${encodeURIComponent(o.name)}`,await t.getAuthValue({requestedScope:"comments:read",roomId:n}),void 0,{signal:r},{fileSize:o.size}),10,d,a);try{e=c.uploadId;let u=function(e){let t=[],n=0;for(;n<e.size;){let r=Math.min(n+5242880,e.size);t.push({partNumber:t.length+1,part:e.slice(n,r)}),n=r}return t}(o.file);if(r?.aborted)throw s;for(let e of function(e,t){let n=[];for(let t=0,r=e.length;t<r;t+=5)n.push(e.slice(t,t+5));return n}(u,5)){let s=[];for(let{part:l,partNumber:u}of e)s.push($(async()=>i.putBlob(eO`/v2/c/rooms/${n}/attachments/${o.id}/multipart/${c.uploadId}/${String(u)}`,await t.getAuthValue({requestedScope:"comments:read",roomId:n}),l,void 0,{signal:r}),10,d,a));l.push(...await Promise.all(s))}if(r?.aborted)throw s;let h=l.sort((e,t)=>e.partNumber-t.partNumber);return i.post(eO`/v2/c/rooms/${n}/attachments/${o.id}/multipart/${e}/complete`,await t.getAuthValue({requestedScope:"comments:read",roomId:n}),{parts:h},{signal:r})}catch(r){if(e&&r?.name&&("AbortError"===r.name||"TimeoutError"===r.name))try{await i.rawDelete(eO`/v2/c/rooms/${n}/attachments/${o.id}/multipart/${e}`,await t.getAuthValue({requestedScope:"comments:read",roomId:n}))}catch(e){}throw r}}}let k=new ef(e=>es(new eo(async n=>{let r=n.flat(),{urls:o}=await i.post(eO`/v2/c/rooms/${e}/attachments/presigned-urls`,await t.getAuthValue({requestedScope:"comments:read",roomId:e}),{attachmentIds:r});return o.map(e=>e??Error("There was an error while getting this attachment's URL"))},{delay:50})));function C(e){return k.getOrCreate(e)}async function R(e){let{chatId:r,attachment:o,signal:s}=e;if(void 0===n.get())throw Error("Attachment upload requires an authenticated user.");if(e.attachment.file.size<=5242880)await i.putBlob(eO`/v2/c/chats/${r}/attachments/${o.id}/upload/${encodeURIComponent(o.file.name)}`,await t.getAuthValue({requestedScope:"comments:read"}),o.file,{fileSize:o.file.size},{signal:s});else{let e=await i.post(eO`/v2/c/chats/${r}/attachments/${o.id}/multipart/${encodeURIComponent(o.file.name)}`,await t.getAuthValue({requestedScope:"comments:read"}),void 0,{signal:s},{fileSize:o.file.size});try{let n=[],a=[],d=0;for(;d<o.file.size;){let e=Math.min(d+5242880,o.file.size);a.push({number:a.length+1,part:o.file.slice(d,e)}),d=e}n.push(...await Promise.all(a.map(async({number:n,part:a})=>await i.putBlob(eO`/v2/c/chats/${r}/attachments/${o.id}/multipart/${e.uploadId}/${String(n)}`,await t.getAuthValue({requestedScope:"comments:read"}),a,void 0,{signal:s})))),await i.post(eO`/v2/c/chats/${r}/attachments/${o.id}/multipart/${e.uploadId}/complete`,await t.getAuthValue({requestedScope:"comments:read"}),{parts:n.sort((e,t)=>e.number-t.number)},{signal:s})}catch(n){try{await i.delete(eO`/v2/c/chats/${r}/attachments/${o.id}/multipart/${e.uploadId}`,await t.getAuthValue({requestedScope:"comments:read"}))}catch(e){}throw n}}}let P=new ef(e=>es(new eo(async n=>{let r=n.flat(),{urls:o}=await i.post(eO`/v2/c/chats/${e}/attachments/presigned-urls`,await t.getAuthValue({requestedScope:"comments:read"}),{attachmentIds:r});return o.map(e=>e??Error("There was an error while getting this attachment's URL"))},{delay:50})));function N(e){return P.getOrCreate(e)}async function D(e){return i.get(eO`/v2/c/rooms/${e.roomId}/subscription-settings`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),void 0,{signal:e.signal})}async function x(e){return i.post(eO`/v2/c/rooms/${e.roomId}/subscription-settings`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),e.settings)}let M=new ef(e=>new eo(async n=>{let r=n.flat();return await i.post(eO`/v2/c/rooms/${e}/inbox-notifications/read`,await t.getAuthValue({requestedScope:"comments:read",roomId:e}),{inboxNotificationIds:r}),r},{delay:50}));async function U(e){return M.getOrCreate(e.roomId).get(e.inboxNotificationId)}async function K(e){await i.rawPost(eO`/v2/c/rooms/${e.roomId}/text-mentions`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),{userId:e.userId,mentionId:e.mentionId})}async function j(e){await i.rawDelete(eO`/v2/c/rooms/${e.roomId}/text-mentions/${e.mentionId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}))}async function q(e){return i.rawGet(eO`/v2/c/rooms/${e.roomId}/y-version/${e.versionId}`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}))}async function z(e){await i.rawPost(eO`/v2/c/rooms/${e.roomId}/version`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}))}async function V(e){await i.rawPost(eO`/v2/c/rooms/${e.roomId}/text-metadata`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),{type:e.type,rootKey:e.rootKey})}async function F(e){let n=await i.post(eO`/v2/c/rooms/${e.roomId}/ai/contextual-prompt`,await t.getAuthValue({requestedScope:"room:read",roomId:e.roomId}),{prompt:e.prompt,context:{beforeSelection:e.context.beforeSelection,selection:e.context.selection,afterSelection:e.context.afterSelection},previous:e.previous},{signal:e.signal});if(!n||0===n.content.length)throw Error("No content returned from server");return n.content[0].text}async function B(e){let n=await i.get(eO`/v2/c/rooms/${e.roomId}/versions`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}));return{versions:n.versions.map(({createdAt:e,...t})=>({createdAt:new Date(e),...t})),requestedAt:new Date(n.meta.requestedAt)}}async function H(e){let n=await i.get(eO`/v2/c/rooms/${e.roomId}/versions/delta`,await t.getAuthValue({requestedScope:"comments:read",roomId:e.roomId}),{since:e.since.toISOString()},{signal:e.signal});return{versions:n.versions.map(({createdAt:e,...t})=>({createdAt:new Date(e),...t})),requestedAt:new Date(n.meta.requestedAt)}}async function W(e){let n=await i.rawGet(eO`/v2/c/rooms/${e.roomId}/storage`,await t.getAuthValue({requestedScope:"room:read",roomId:e.roomId}));return await n.json()}async function G(e){return i.rawPost(eO`/v2/c/rooms/${e.roomId}/send-message`,await t.getAuthValue({requestedScope:"room:read",roomId:e.roomId}),{nonce:e.nonce,messages:e.messages})}async function J(e){let n=await i.get(eO`/v2/c/inbox-notifications`,await t.getAuthValue({requestedScope:"comments:read"}),{cursor:e?.cursor,limit:50});return{inboxNotifications:n.inboxNotifications.map(u),threads:n.threads.map(c),subscriptions:n.subscriptions.map(h),nextCursor:n.meta.nextCursor,requestedAt:new Date(n.meta.requestedAt)}}async function Y(e){let n=await i.get(eO`/v2/c/inbox-notifications/delta`,await t.getAuthValue({requestedScope:"comments:read"}),{since:e.since.toISOString()},{signal:e.signal});return{inboxNotifications:{updated:n.inboxNotifications.map(u),deleted:n.deletedInboxNotifications.map(p)},threads:{updated:n.threads.map(c),deleted:n.deletedThreads.map(f)},subscriptions:{updated:n.subscriptions.map(h),deleted:n.deletedSubscriptions.map(m)},requestedAt:new Date(n.meta.requestedAt)}}async function X(){let{count:e}=await i.get(eO`/v2/c/inbox-notifications/count`,await t.getAuthValue({requestedScope:"comments:read"}));return e}async function Z(){await i.post(eO`/v2/c/inbox-notifications/read`,await t.getAuthValue({requestedScope:"comments:read"}),{inboxNotificationIds:"all"})}async function Q(e){await i.post(eO`/v2/c/inbox-notifications/read`,await t.getAuthValue({requestedScope:"comments:read"}),{inboxNotificationIds:e})}let ee=new eo(async e=>{let t=e.flat();return await Q(t),t},{delay:50});return{getThreads:s,getThreadsSince:o,createThread:a,getThread:g,deleteThread:d,editThreadMetadata:y,createComment:v,editComment:b,deleteComment:_,addReaction:w,removeReaction:S,markThreadAsResolved:I,markThreadAsUnresolved:E,subscribeToThread:O,unsubscribeFromThread:A,markRoomInboxNotificationAsRead:U,getSubscriptionSettings:D,updateSubscriptionSettings:x,createTextMention:K,deleteTextMention:j,getTextVersion:q,createTextVersion:z,reportTextEditor:V,listTextVersions:B,listTextVersionsSince:H,getAttachmentUrl:function(e){return C(e.roomId).batch.get(e.attachmentId)},uploadAttachment:T,getOrCreateAttachmentUrlsStore:C,uploadChatAttachment:R,getOrCreateChatAttachmentUrlsStore:N,getChatAttachmentUrl:function(e){return N(e.chatId).batch.get(e.attachmentId)},streamStorage:W,sendMessages:G,getInboxNotifications:J,getInboxNotificationsSince:Y,getUnreadInboxNotificationsCount:X,markAllInboxNotificationsAsRead:Z,markInboxNotificationAsRead:async function(e){await ee.get(e)},deleteAllInboxNotifications:async function(){await i.delete(eO`/v2/c/inbox-notifications`,await t.getAuthValue({requestedScope:"comments:read"}))},deleteInboxNotification:async function(e){await i.delete(eO`/v2/c/inbox-notifications/${e}`,await t.getAuthValue({requestedScope:"comments:read"}))},getNotificationSettings:async function(e){return i.get(eO`/v2/c/notification-settings`,await t.getAuthValue({requestedScope:"comments:read"}),void 0,{signal:e?.signal})},updateNotificationSettings:async function(e){return i.post(eO`/v2/c/notification-settings`,await t.getAuthValue({requestedScope:"comments:read"}),e)},getUserThreads_experimental:async function(e){let n;e?.query&&(n=em(e.query));let r=await i.get(eO`/v2/c/threads`,await t.getAuthValue({requestedScope:"comments:read"}),{cursor:e?.cursor,query:n,limit:50});return{threads:r.threads.map(c),inboxNotifications:r.inboxNotifications.map(u),subscriptions:r.subscriptions.map(h),nextCursor:r.meta.nextCursor,requestedAt:new Date(r.meta.requestedAt),permissionHints:r.meta.permissionHints}},getUserThreadsSince_experimental:async function(e){let n=await i.get(eO`/v2/c/threads/delta`,await t.getAuthValue({requestedScope:"comments:read"}),{since:e.since.toISOString()},{signal:e.signal});return{threads:{updated:n.threads.map(c),deleted:n.deletedThreads.map(f)},inboxNotifications:{updated:n.inboxNotifications.map(u),deleted:n.deletedInboxNotifications.map(p)},subscriptions:{updated:n.subscriptions.map(h),deleted:n.deletedSubscriptions.map(m)},requestedAt:new Date(n.meta.requestedAt),permissionHints:n.meta.permissionHints}},executeContextualPrompt:F}}({baseUrl:a,fetchPolyfill:e.polyfills?.fetch||globalThis.fetch?.bind(globalThis),currentUserId:d,authManager:g}),v=new Map,w=function(e){let t,n,r=new e1(e.delegates,e.enableDebugLogging,!1),i=function(){let e=new ee(e5.with((e,t)=>t.createdAt<e.createdAt));function t(t){e.mutate(e=>{for(let n of t)e.removeBy(e=>e.id===n.id,1),e.add(n)})}function n(e){t([e])}return{chatsÎ£:Q.from(()=>Array.from(e.get()).filter(e=>!e.deletedAt)),getChatById:function(t){return Array.from(e.get()).find(e=>e.id===t)},upsert:n,upsertMany:t,markDeleted:function(t){e.mutate(e=>{let r=e.find(e=>e.id===t);if(!r)return!1;n({...r,deletedAt:tn()})})}}}(),o=function(){let e=new ef(e=>new ef(e=>new Y(void 0))),t=new ef(t=>{let[n,r]=C(t);return Q.from(()=>(void 0!==r?e.getOrCreate(r).getOrCreate(n):void 0)?.get()??e.getOrCreate(tr).getOrCreate(n).get())});return{getToolDescriptions:function(t){let n=e.get(tr),r=e.get(t);return Array.from([...n?.entries()??[],...r?.entries()??[]]).flatMap(([e,t])=>{let n=t.get();return n&&(n.enabled??!0)?[{name:e,description:n.description,parameters:n.parameters}]:[]})},getToolÎ£:function(e,n){let r=JSON.stringify(void 0!==n?[e,n]:[e]);return t.getOrCreate(r)},registerTool:function(t,n,r){if(!n.execute&&!n.render)throw Error("A tool definition must have an execute() function, a render() function, or both.");let i=r??tr;return e.getOrCreate(i).getOrCreate(t).set(n),()=>(function(t,n){let r=e.get(t);if(void 0===r)return;let i=r.get(n);void 0!==i&&i.set(void 0)})(i,t)}}}(),s=function(e,t){let n=new Set,r=new Set,i=new ef(e=>new ee(new e6(e=>e.id,e=>e.parentId,(e,t)=>e.createdAt<t.createdAt))),o=new ee(new Map);function s(e){H(()=>{for(let t of e)a(t)})}function a(s){H(()=>{if(i.getOrCreate(s.chatId).mutate(e=>e.upsert(s)),"assistant"===s.role&&"generating"===s.status?o.mutate(e=>{e.set(s.id,structuredClone(s))}):o.mutate(e=>{e.delete(s.id)}),"assistant"===s.role&&"awaiting-tool"===s.status){if(n.has(s.id))for(let n of s.contentSoFar.filter(e=>"tool-invocation"===e.type&&"executing"===e.stage)){if(r.has(n.invocationId))continue;r.add(n.invocationId);let i=e.getToolÎ£(n.name,s.chatId).get()?.execute;i&&(async()=>{let e=await i(n.args,{name:n.name,invocationId:n.invocationId});return await t(s.chatId,s.id,n.invocationId,e??{data:{}})})().catch(e=>{_(`Error trying to respond to tool-call: ${String(e)} (in execute())`)})}}else n.delete(s.id)})}function d(e){let t=e.next();return t.done?void 0:t.value}let l=new ef(e=>new ef(t=>{let n=Q.from(()=>{var n=i.getOrCreate(e).get();function r(e){if(!e.deletedAt)return!0;for(let t of n.walkDown(e.id,e=>!e.deletedAt))return!0;return!1}function o(e){let t=[],i=null;for(let o of n.walkUp(e.id)){let e=d(n.walkLeft(o.id,r))?.id??null,s=d(n.walkRight(o.id,r))?.id??null;if(!o.deletedAt||e||s){let n={...o,navigation:{parent:null,prev:e,next:s}};null!==i&&(i.navigation.parent=n.id),i=n,t.push(n)}}return t.reverse()}function s(){let e=n.sorted.findRight(e=>!e.deletedAt);return e?o(e):[]}if(null===t)return s();let a=n.get(t);if(!a)return s();for(let e of n.walkUp(a.id)){for(let t of n.walkDown(e.id,e=>!e.deletedAt))return o(t);if(!e.deletedAt)return o(e)}return s()},e4);return Q.from(()=>{let e=o.get();return n.get().map(t=>{if("assistant"!==t.role||"generating"!==t.status)return t;let n=e.get(t.id);return void 0===n?t:{...t,contentSoFar:n.contentSoFar}})},e3)}));return{getMessageById:function(e){for(let t of i.values()){let n=t.get().get(e);if(n)return n}},getChatMessagesForBranchÎ£:function(e,t){return l.getOrCreate(e).getOrCreate(t||null)},createOptimistically:function(e,t,n,r){let i=`ms_${ea()}`,o=tn();return"user"===t?a({id:i,chatId:e,role:t,parentId:n,createdAt:o,content:r,_optimistic:!0}):a({id:i,chatId:e,role:t,parentId:n,createdAt:o,status:"generating",contentSoFar:[],_optimistic:!0}),i},upsert:a,upsertMany:s,remove:function(e,t){let n=i.get(e);if(!n)return;let r=n.get().get(t);r&&!r.deletedAt&&("assistant"===r.role&&"completed"!==r.status?a({...r,deletedAt:tn(),contentSoFar:[]}):a({...r,deletedAt:tn(),content:[]}))},removeByChatId:function(e){let t=i.get(e);void 0!==t&&t.mutate(e=>e.clear())},addDelta:function(e,t){o.mutate(n=>{let r=n.get(e);return void 0!==r&&(!function(e,t){let n=e[e.length-1];switch(t.type){case"text-delta":n?.type==="text"?n.text+=t.textDelta:e.push({type:"text",text:t.textDelta});break;case"reasoning-delta":n?.type==="reasoning"?n.text+=t.textDelta:e.push({type:"reasoning",text:t.textDelta??""});break;case"tool-invocation":e.push(t);break;default:return eR(t,"Unhandled case")}}(r.contentSoFar,t),n.set(e,r),!0)})},failAllPending:function(){H(()=>{o.mutate(e=>{let t=!1;for(let[n,r]of e)r._optimistic||(e.delete(n),t=!0);return t}),s(Array.from(function*(){for(let e of i.values())for(let t of e.get())"assistant"!==t.role||"generating"!==t.status||t._optimistic||(yield t)}()).map(e=>({...e,status:"failed",errorReason:"Lost connection"})))})},markMine(e){n.add(e)}}}(o,u),a={staticSessionInfoSig:new Y(null),dynamicSessionInfoSig:new Y(null),pendingCmds:new Map,chatsStore:i,messagesStore:s,toolsStore:o,knowledge:new tt},d=!1;function l(){"initial"===r.getStatus()&&r.connect()}async function c(e){var t;l(),"connected"!==r.getStatus()&&await r.events.didConnect.waitUntil();let{promise:n,resolve:i,reject:o}=K(),s=AbortSignal.timeout(4e3);s.addEventListener("abort",()=>o(s.reason),{once:!0});let d=ea(7);return a.pendingCmds.set(d,{resolve:i,reject:o}),t={...e,cmdId:d},r.send(JSON.stringify({...t})),n.finally(()=>{a.pendingCmds.delete(d)}).catch(e=>{throw _(e.message),e})}async function u(e,t,n,r,i){let o=a.knowledge.get(),d=a.toolsStore.getToolDescriptions(e),l=await c({cmd:"set-tool-result",chatId:e,messageId:t,invocationId:n,result:r,generationOptions:{copilotId:i?.copilotId,stream:i?.stream,timeout:i?.timeout,knowledge:o.length>0?o:void 0,tools:d.length>0?d:void 0}});l.ok&&s.markMine(l.message.id)}return r.events.onMessage.subscribe(function(e){if("string"!=typeof e.data)return;let t=C(e.data);if(!t)return;let n="cmdId"in t?t.cmdId:"cmd-failed"===t.event?t.failedCmdId:void 0,r=a.pendingCmds.get(n);if(n&&!r)return void b("Ignoring unexpected command response. Already timed out, or not for us?",t);if("event"in t)switch(t.event){case"cmd-failed":r?.reject(Error(t.error));break;case"delta":{let{id:e,delta:n}=t;a.messagesStore.addDelta(e,n);break}case"settle":a.messagesStore.upsert(t.message);break;case"warning":b(t.message);break;case"error":_(t.error);break;case"rebooted":a.messagesStore.failAllPending();break;case"sync":H(()=>{for(let e of t["-messages"]??[])a.messagesStore.remove(e.chatId,e.id);for(let e of t["-chats"]??[])a.chatsStore.markDeleted(e),a.messagesStore.removeByChatId(e);for(let e of t.clear??[])a.messagesStore.removeByChatId(e);t.chats&&a.chatsStore.upsertMany(t.chats),t.messages&&a.messagesStore.upsertMany(t.messages)});break;default:return eR(t,"Unhandled case")}else switch(t.cmd){case"get-chats":a.chatsStore.upsertMany(t.chats);break;case"get-or-create-chat":a.chatsStore.upsert(t.chat);break;case"delete-chat":a.chatsStore.markDeleted(t.chatId),a.messagesStore.removeByChatId(t.chatId);break;case"get-message-tree":a.chatsStore.upsert(t.chat),a.messagesStore.upsertMany(t.messages);break;case"delete-message":a.messagesStore.remove(t.chatId,t.messageId);break;case"clear-chat":a.messagesStore.removeByChatId(t.chatId);break;case"ask-in-chat":t.sourceMessage&&a.messagesStore.upsert(t.sourceMessage),a.messagesStore.upsert(t.targetMessage);break;case"abort-ai":break;case"set-tool-result":t.ok&&a.messagesStore.upsert(t.message);break;default:return eR(t,"Unhandled case")}r?.resolve(t)}),r.events.statusDidChange.subscribe(function(e){let n=r.authValue;if(null!==n){let e=ek(n);if(e!==t)if(t=e,"secret"===n.type){let e=n.token.parsed;a.staticSessionInfoSig.set({userId:"sec-legacy"===e.k?e.id:e.uid,userInfo:"sec-legacy"===e.k?e.info:e.ui})}else a.staticSessionInfoSig.set({userId:void 0,userInfo:void 0})}}),r.events.statusDidChange.subscribe(function(t){"reconnecting"===t?n=setTimeout(()=>{d=!0},e.lostConnectionTimeout):(clearTimeout(n),d&&(d=!1))}),r.events.didConnect.subscribe(function(){}),r.events.didDisconnect.subscribe(function(){b("onDidDisconnect")}),r.events.onConnectionError.subscribe(({message:e,code:t})=>{}),Object.defineProperty({[e2]:{context:a},connectInitially:l,disconnect:()=>r.disconnect(),getChats:function(e={}){return c({cmd:"get-chats",cursor:e.cursor})},getOrCreateChat:function(e,t){return c({cmd:"get-or-create-chat",id:e,options:t})},deleteChat:e=>c({cmd:"delete-chat",chatId:e}),getMessageTree:function(e){return c({cmd:"get-message-tree",chatId:e})},deleteMessage:(e,t)=>c({cmd:"delete-message",chatId:e,messageId:t}),clearChat:e=>c({cmd:"clear-chat",chatId:e}),askUserMessageInChat:async(e,t,n,r)=>{let i=a.knowledge.get(),o=a.toolsStore.getToolDescriptions(e),d=await c({cmd:"ask-in-chat",chatId:e,sourceMessage:t,targetMessageId:n,generationOptions:{copilotId:r?.copilotId,stream:r?.stream,timeout:r?.timeout,knowledge:i.length>0?i:void 0,tools:o.length>0?o:void 0}});return s.markMine(d.targetMessage.id),d},abort:e=>c({cmd:"abort-ai",messageId:e}),setToolResult:u,getStatus:()=>r.getStatus(),signals:{chatsÎ£:a.chatsStore.chatsÎ£,getChatMessagesForBranchÎ£:a.messagesStore.getChatMessagesForBranchÎ£,getToolÎ£:a.toolsStore.getToolÎ£},getChatById:a.chatsStore.getChatById,registerKnowledgeLayer:function(e){return a.knowledge.registerLayer(e)},deregisterKnowledgeLayer:function(e){a.knowledge.deregisterLayer(e)},updateKnowledge:function(e,t,n=ea()){a.knowledge.updateKnowledge(e,n,t)},registerTool:a.toolsStore.registerTool},e2,{enumerable:!1})}({userId:d.get(),lostConnectionTimeout:i,backgroundKeepAliveTimeout:tY(e.backgroundKeepAliveTimeout),polyfills:e.polyfills,delegates:{createSocket:(n=e.polyfills?.WebSocket,e=>{let t=n??("undefined"==typeof WebSocket?void 0:WebSocket);if(void 0===t)throw new eF("To use Liveblocks client in a non-DOM environment, you need to provide a WebSocket polyfill.");let r=new URL(a);if(r.protocol="http:"===r.protocol?"ws":"wss",r.pathname="/ai/v4","secret"===e.type)r.searchParams.set("tok",e.token.raw);else if("public"!==e.type)return eR(e,"Unhandled case");else throw Error("Public key not supported with AI Copilots");return r.searchParams.set("version",o||"dev"),new t(r.toString())}),authenticate:async()=>{let e=await g.getAuthValue({requestedScope:"room:read"});if("public"===e.type)throw new eF("Cannot use AI Copilots with a public API key");if("sec-legacy"===e.token.parsed.k)throw new eF("AI Copilots requires an ID or Access token");if(!e.token.parsed.ai)throw new eF("AI Copilots is not yet enabled for this account. To get started, see https://liveblocks.io/docs/get-started/ai-copilots#Quickstart");return e},canZombie:()=>!1}});function S(e){let t=()=>{if(e.unsubs.delete(t)){var n,r;0===e.unsubs.size&&((n=e.room).id,v.delete(n.id),n.destroy())}else b("This leave function was already called. Calling it more than once has no effect.")};return e.unsubs.add(t),{room:e.room,leave:t}}let E=e.resolveUsers,O=tX(()=>!E,"Set the resolveUsers option in createClient to specify user info."),A=es(new eo(async e=>{let t=e.flat(),n=await E?.({userIds:t});return O(),n??t.map(()=>void 0)},{delay:50})),k=e.resolveRoomsInfo,N=tX(()=>!k,"Set the resolveRoomsInfo option in createClient to specify room info."),D=es(new eo(async e=>{let t=e.flat(),n=await k?.({roomIds:t});return N(),n??t.map(()=>void 0)},{delay:50})),M=new Map,U=[],q=new Y("synchronized"),z=j();function V(){q.set(U.some(e=>"synchronizing"===e.get())?"synchronizing":U.some(e=>"has-local-changes"===e.get())?"has-local-changes":"synchronized")}function F(){let e=new Y("synchronized");U.push(e);let t=e.subscribe(()=>V());return{setSyncStatus:function(t){e.set(t)},destroy:function(){t();let n=U.findIndex(t=>t===e);if(n>-1){let[e]=U.splice(n,1);"synchronized"!==e.get()&&V()}}}}{let t="undefined"!=typeof window?window:void 0;t?.addEventListener("beforeunload",t=>{e.preventUnsavedChanges&&"synchronized"!==q.get()&&t.preventDefault()})}async function B(e){return ts(await y.getNotificationSettings(e))}async function W(e){return ts(await y.updateNotificationSettings(e))}let G=Object.defineProperty({enterRoom:function(t,...n){var d;let l=v.get(t);if(void 0!==l)return S(l);let c=n[0]??{},u=function(e,t){var n,r,i;let o,s,a,d=t.roomId,l=e.initialPresence,c=e.initialStorage,u=t.roomHttpClient,[h,f]=function(){let e="undefined"!=typeof document?document:void 0,t={current:null};function n(){e?.visibilityState==="hidden"?t.current=t.current??Date.now():t.current=null}return e?.addEventListener("visibilitychange",n),[t,()=>{e?.removeEventListener("visibilitychange",n)}]}(),p=new e1({...t.delegates,canZombie:()=>void 0!==t.backgroundKeepAliveTimeout&&null!==h.current&&Date.now()>h.current+t.backgroundKeepAliveTimeout&&"synchronizing"!==ec()},t.enableDebugLogging),m={buffer:{flushTimerID:void 0,lastFlushedAt:0,presenceUpdates:{type:"full",data:l},messages:[],storageOperations:[]},staticSessionInfoSig:new Y(null),dynamicSessionInfoSig:new Y(null),myPresence:new X(l),others:new tB,initialStorage:c,idFactory:null,yjsProvider:void 0,yjsProviderDidChange:j(),pool:function(e,t){let{getCurrentConnectionId:n,onDispatch:r,isStorageWritable:i=()=>!0}=t,o=0,s=0,a=new Map;return{roomId:e,nodes:a,getNode:e=>a.get(e),addNode:(e,t)=>void a.set(e,t),deleteNode:e=>void a.delete(e),generateId:()=>`${n()}:${o++}`,generateOpId:()=>`${n()}:${s++}`,dispatch(e,t,n){r?.(e,t,n)},assertStorageIsWritable:()=>{if(!i())throw Error("Cannot write to storage with a read only user, please ensure the user has write permissions")}}}(d,{getCurrentConnectionId:function(){let e=m.dynamicSessionInfoSig.get();if(e)return e.actor;throw Error("Internal. Tried to get connection id but connection was never open")},onDispatch:function(e,t,n){if(m.activeBatch){for(let t of e)m.activeBatch.ops.push(t);for(let[e,t]of n)m.activeBatch.updates.storageUpdates.set(e,tq(m.activeBatch.updates.storageUpdates.get(e),t));m.activeBatch.reverseOps.pushLeft(t)}else z(t),m.redoStack.length=0,Z(e),V({storageUpdates:n})},isStorageWritable:function(){let e=m.dynamicSessionInfoSig.get()?.scopes;return void 0===e||e8(e)}}),root:void 0,undoStack:[],redoStack:[],pausedHistory:null,activeBatch:null,unacknowledgedOps:new Map,opStackTraces:void 0},g=!1;p.events.onMessage.subscribe(function(e){if("string"!=typeof e.data)return;let t=function(e){let t=C(e);return void 0===t?null:tV(t)?P(t.map(e=>G(e))):P([G(t)])}(e.data);if(null===t||0===t.length)return;let n={storageUpdates:new Map,others:[]};for(let e of t)switch(e.type){case 101:{let t=function(e){m.others.setConnection(e.actor,e.id,e.info,e.scopes),m.buffer.messages.push({type:100,data:m.myPresence.get(),targetActor:e.actor}),J();let t=m.others.getUser(e.actor);return t?{type:"enter",user:t}:void 0}(e);t&&n.others.push(t);break}case 100:{let t=function(e){if(void 0!==e.targetActor){let t=m.others.getUser(e.actor);m.others.setOther(e.actor,e.data);let n=m.others.getUser(e.actor);if(void 0===t&&void 0!==n)return{type:"enter",user:n}}else m.others.patchOther(e.actor,e.data);let t=m.others.getUser(e.actor);return t?{type:"update",updates:e.data,user:t}:void 0}(e);t&&n.others.push(t);break}case 103:{let t=m.others.get();y.customEvent.notify({connectionId:e.actor,user:e.actor<0?null:t.find(t=>t.connectionId===e.actor)??null,event:e.event});break}case 102:{let t=function(e){let t=m.others.getUser(e.actor);return t?(m.others.removeConnection(e.actor),{type:"leave",user:t}):null}(e);t&&n.others.push(t);break}case 300:y.ydoc.notify(e);break;case 104:n.others.push(function(e){var t;let n;for(let r of(m.dynamicSessionInfoSig.set({actor:e.actor,nonce:e.nonce,scopes:e.scopes}),t=e.actor,n=0,m.idFactory=()=>`${t}:${n++}`,$(),m.others.connectionIds()))void 0===e.users[r]&&m.others.removeConnection(r);for(let t in e.users){let n=e.users[t],r=Number(t);m.others.setConnection(r,n.id,n.info,n.scopes)}return{type:"reset"}}(e));break;case 200:en(e);break;case 201:for(let[t,r]of F(e.ops,!1).updates.storageUpdates)n.storageUpdates.set(t,tq(n.storageUpdates.get(t),r));break;case 299:I("Storage mutation rejection error",e.reason);break;case 400:case 407:case 401:case 408:case 405:case 406:case 402:case 403:case 404:y.comments.notify(e)}V(n)}),p.events.statusDidChange.subscribe(function(e){let t=p.authValue;if(null!==t){let e=ek(t);if(e!==o)if(o=e,"secret"===t.type){let e=t.token.parsed;m.staticSessionInfoSig.set({userId:"sec-legacy"===e.k?e.id:e.uid,userInfo:"sec-legacy"===e.k?e.info:e.ui})}else m.staticSessionInfoSig.set({userId:void 0,userInfo:void 0})}y.status.notify(e),$()}),p.events.statusDidChange.subscribe(function(e){"reconnecting"===e?s=setTimeout(()=>{y.lostConnection.notify("lost"),g=!0,m.others.clearOthers(),V({others:[{type:"reset"}]})},t.lostConnectionTimeout):(clearTimeout(s),g&&("disconnected"===e?y.lostConnection.notify("failed"):y.lostConnection.notify("restored"),g=!1))}),p.events.didConnect.subscribe(function(){m.buffer.presenceUpdates={type:"full",data:{...m.myPresence.get()}},null!==ee&&eo({flush:!1}),J()}),p.events.didDisconnect.subscribe(function(){clearTimeout(m.buffer.flushTimerID)}),p.events.onConnectionError.subscribe(({message:e,code:n})=>{let r=new tH(e,{type:"ROOM_CONNECTION_ERROR",code:n,roomId:d});t.errorEventSource.notify(r)});let y={status:j(),lostConnection:j(),customEvent:j(),self:j(),myPresence:j(),others:j(),storageBatch:j(),history:j(),storageDidLoad:j(),storageStatus:j(),ydoc:j(),comments:j(),roomWillDestroy:j()};async function v(e,t){return u.createTextMention({roomId:d,userId:e,mentionId:t})}async function w(e){return u.deleteTextMention({roomId:d,mentionId:e})}async function S(e,t){await u.reportTextEditor({roomId:d,type:e,rootKey:t})}async function E(){return u.listTextVersions({roomId:d})}async function O(e){return u.listTextVersionsSince({roomId:d,since:e.since,signal:e.signal})}async function A(e){return u.getTextVersion({roomId:d,versionId:e})}async function k(){return u.createTextVersion({roomId:d})}async function N(e){return u.executeContextualPrompt({roomId:d,...e})}function D(e){return!(4*e.length<1048064)&&new TextEncoder().encode(e).length>=1048064}function L(e){let n=t.largeMessageStrategy??"default",r=er(e);if(!D(r))return p.send(r);switch(n){case"default":{let e=new tH("Message is too large for websockets",{type:"LARGE_MESSAGE_ERROR"});t.errorEventSource.notify(e)||_("Message is too large for websockets.  Configure largeMessageStrategy option or useErrorListener to handle this.");return}case"split":for(let t of(b("Message is too large for websockets, splitting into smaller chunks"),function* e(t){if(t.length<2)if(201===t[0].type)return void(yield*function* e(t){let{ops:n,...r}=t;if(n.length<2)throw Error("Cannot split ops into smaller chunks");let i=Math.floor(n.length/2);for(let t of[n.slice(0,i),n.slice(i)]){let n={ops:t,...r},i=er([n]);D(i)?yield*e(n):yield i}}(t[0]));else throw Error("Cannot split into chunks smaller than the allowed message size");let n=Math.floor(t.length/2);for(let r of[t.slice(0,n),t.slice(n)]){let t=er(r);D(t)?yield*e(r):yield t}}(e)))p.send(t);return;case"experimental-fallback-to-http":{b("Message is too large for websockets, so sending over HTTP instead");let t=m.dynamicSessionInfoSig.get()?.nonce??T("Session is not authorized to send message over HTTP");u.sendMessages({roomId:d,nonce:t,messages:e}).then(e=>{e.ok||403!==e.status||p.reconnect()});return}}}let M=Q.from(m.staticSessionInfoSig,m.dynamicSessionInfoSig,m.myPresence,(e,t,n)=>{if(null===e||null===t)return null;{let r=e8(t.scopes);return{connectionId:t.actor,id:e.userId,info:e.userInfo,presence:n,canWrite:r,canComment:e7(t.scopes)}}});function $(){let e=M.get();null!==e&&e!==a&&(y.self.notify(e),a=e)}let U=Q.from(M,e=>null!==e?tW("Me",e):null);function q(e){m.undoStack.length>=50&&m.undoStack.shift(),m.undoStack.push(e),W()}function z(e){null!==m.pausedHistory?m.pausedHistory.pushLeft(e):q(e)}function V(e){let t=e.storageUpdates,n=e.others;if(void 0!==n&&n.length>0){let e=m.others.get();for(let t of n)y.others.notify({...t,others:e})}if(e.presence&&($(),y.myPresence.notify(m.myPresence.get())),void 0!==t&&t.size>0){let e=Array.from(t.values());y.storageBatch.notify(e)}ef()}function F(e,t){let n={reverse:new tz,storageUpdates:new Map,presence:!1},r=new Set,i=e.map(e=>"presence"===e.type||e.opId?e:{...e,opId:m.pool.generateOpId()});for(let e of i)if("presence"===e.type){let t={type:"presence",data:{}};for(let n in e.data)t.data[n]=m.myPresence.get()[n];if(m.myPresence.patch(e.data),null===m.buffer.presenceUpdates)m.buffer.presenceUpdates={type:"partial",data:e.data};else for(let t in e.data)m.buffer.presenceUpdates.data[t]=e.data[t];n.reverse.pushLeft(t),n.presence=!0}else{let i;if(t)i=0;else{let t=eN(e.opId);i=m.unacknowledgedOps.delete(t)?2:1}let o=function(e,t){if(5===e.type&&"ACK"===e.id)return{modified:!1};switch(e.type){case 6:case 3:case 5:{let n=m.pool.nodes.get(e.id);if(void 0===n)return{modified:!1};return n._apply(e,0===t)}case 1:{let n=m.pool.nodes.get(e.id);if(void 0===n)return{modified:!1};if("HasParent"===n.parent.type&&t$(n.parent.node))return n.parent.node._setChildKey(tp(e.parentKey),n,t);return{modified:!1}}case 4:case 2:case 7:case 8:{if(void 0===e.parentId)return{modified:!1};let n=m.pool.nodes.get(e.parentId);if(void 0===n)return{modified:!1};return n._attachChild(e,t)}}}(e,i);if(o.modified){let t=o.modified.node._id;t&&r.has(t)||(n.storageUpdates.set(eN(o.modified.node._id),tq(n.storageUpdates.get(eN(o.modified.node._id)),o.modified)),n.reverse.pushLeft(o.reverse)),(2===e.type||7===e.type||4===e.type)&&r.add(eN(e.id))}}return{ops:i,reverse:Array.from(n.reverse),updates:{storageUpdates:n.storageUpdates,presence:n.presence}}}function B(){return m.undoStack.length>0}function H(){return m.redoStack.length>0}function W(){y.history.notify({canUndo:B(),canRedo:H()})}function G(e){return!function(e){return null!==e&&"string"!=typeof e&&"number"!=typeof e&&"boolean"!=typeof e&&!tV(e)}(e)?null:e}function J(){let e=m.buffer.storageOperations;if(e.length>0){for(let t of e)m.unacknowledgedOps.set(eN(t.opId),t);ef()}if("connected"!==p.getStatus()){m.buffer.storageOperations=[];return}let n=Date.now(),r=n-m.buffer.lastFlushedAt;if(r>=t.throttleDelay){let e=function(){let e=[];for(let t of(m.buffer.presenceUpdates&&e.push("full"===m.buffer.presenceUpdates.type?{type:100,targetActor:-1,data:m.buffer.presenceUpdates.data}:{type:100,data:m.buffer.presenceUpdates.data}),m.buffer.messages))e.push(t);return m.buffer.storageOperations.length>0&&e.push({type:201,ops:m.buffer.storageOperations}),e}();if(0===e.length)return;L(e),m.buffer={flushTimerID:void 0,lastFlushedAt:n,messages:[],storageOperations:[],presenceUpdates:null}}else clearTimeout(m.buffer.flushTimerID),m.buffer.flushTimerID=setTimeout(J,t.throttleDelay-r)}function Z(e){let{storageOperations:t}=m.buffer;for(let n of e)t.push(n);J()}let ee=null,et=null;function en(e){var t;let n=new Map(m.unacknowledgedOps);if(0===e.items.length)throw Error("Internal error: cannot load storage without items");void 0!==m.root?function(e){if(void 0===m.root)return;let t=new Map;for(let[e,n]of m.pool.nodes)t.set(e,n._serialize());V(F(function(e,t){let n=[];return e.forEach((e,r)=>{t.get(r)||n.push({type:5,id:r})}),t.forEach((t,r)=>{let i=e.get(r);if(i)0===t.type&&(0!==i.type||er(t.data)!==er(i.data))&&n.push({type:3,id:r,data:t.data}),t.parentKey!==i.parentKey&&n.push({type:1,id:r,parentKey:eN(t.parentKey,"Parent key must not be missing")});else switch(t.type){case 3:n.push({type:8,id:r,parentId:t.parentId,parentKey:t.parentKey,data:t.data});break;case 1:n.push({type:2,id:r,parentId:t.parentId,parentKey:t.parentKey});break;case 0:if(void 0===t.parentId||void 0===t.parentKey)throw Error("Internal error. Cannot serialize storage root into an operation");n.push({type:4,id:r,parentId:t.parentId,parentKey:t.parentKey,data:t.data});break;case 2:n.push({type:7,id:r,parentId:t.parentId,parentKey:t.parentKey})}}),n}(t,new Map(e)),!1).updates)}(e.items):m.root=tP._fromItems(e.items,m.pool);let r=M.get()?.canWrite??!0,i=m.undoStack.length;for(let e in m.initialStorage)void 0===m.root.get(e)&&(r?m.root.set(e,void 0===(t=m.initialStorage[e])?void 0:tL(t)?t.clone():R(t)):b(`Attempted to populate missing storage key '${e}', but current user has no write access`));m.undoStack.length=i,function(e){if(0===e.size)return;let t=[],n=F(Array.from(e.values()),!0);t.push({type:201,ops:n.ops}),V(n.updates),L(t)}(n),et?.(),ef(),y.storageDidLoad.notify()}async function ei(){p.authValue&&en({type:200,items:await u.streamStorage({roomId:d})})}function eo(e){let n=m.buffer.messages;t.unstable_streamData?ei():n.some(e=>200===e.type)||n.push({type:200}),e.flush&&J()}function es(){return null===ee&&(eo({flush:!0}),ee=new Promise(e=>{et=e}),ef()),ee}function ea(){let e=m.root;return void 0!==e?e:(es(),null)}async function ed(){return void 0!==m.root?Promise.resolve({root:m.root}):(await es(),{root:eN(m.root)})}let el=t.createSyncSource();function ec(){return void 0===m.root?null===ee?"not-loaded":"loading":0===m.unacknowledgedOps.size?"synchronized":"synchronizing"}let eh=ec();function ef(){let e=ec();eh!==e&&(eh=e,y.storageStatus.notify(e)),el.setSyncStatus("synchronizing"===e?"synchronizing":"synchronized")}function ep(){return null!==M.get()}async function em(){for(;!ep();){let{promise:e,resolve:t}=K(),n=eb.self.subscribeOnce(t),r=eb.status.subscribeOnce(t);await e,n(),r()}}function eg(){return null!==ea()}async function ey(){for(;!eg();)await ed()}let ev=Q.from(m.others.signal,e=>e.map((e,t)=>tW(`Other ${t}`,e))),eb={status:y.status.observable,lostConnection:y.lostConnection.observable,customEvent:y.customEvent.observable,others:y.others.observable,self:y.self.observable,myPresence:y.myPresence.observable,storageBatch:y.storageBatch.observable,history:y.history.observable,storageDidLoad:y.storageDidLoad.observable,storageStatus:y.storageStatus.observable,ydoc:y.ydoc.observable,comments:y.comments.observable,roomWillDestroy:y.roomWillDestroy.observable};async function e_(e){return u.getThreadsSince({roomId:d,since:e.since,signal:e.signal})}async function ew(e){return u.getThreads({roomId:d,query:e?.query,cursor:e?.cursor})}async function eS(e){return u.getThread({roomId:d,threadId:e})}async function eI(e){return u.createThread({roomId:d,threadId:e.threadId,commentId:e.commentId,metadata:e.metadata,body:e.body,attachmentIds:e.attachmentIds})}async function eE(e){return u.deleteThread({roomId:d,threadId:e})}async function eO({metadata:e,threadId:t}){return u.editThreadMetadata({roomId:d,threadId:t,metadata:e})}async function eA(e){return u.markThreadAsResolved({roomId:d,threadId:e})}async function eT(e){return u.markThreadAsUnresolved({roomId:d,threadId:e})}async function eC(e){return u.subscribeToThread({roomId:d,threadId:e})}async function eP(e){return u.unsubscribeFromThread({roomId:d,threadId:e})}async function eD(e){return u.createComment({roomId:d,threadId:e.threadId,commentId:e.commentId,body:e.body,attachmentIds:e.attachmentIds})}async function ex(e){return u.editComment({roomId:d,threadId:e.threadId,commentId:e.commentId,body:e.body,attachmentIds:e.attachmentIds})}async function eL({threadId:e,commentId:t}){return u.deleteComment({roomId:d,threadId:e,commentId:t})}async function eM({threadId:e,commentId:t,emoji:n}){return u.addReaction({roomId:d,threadId:e,commentId:t,emoji:n})}async function e$({threadId:e,commentId:t,emoji:n}){return await u.removeReaction({roomId:d,threadId:e,commentId:t,emoji:n})}async function eU(e,t={}){return u.uploadAttachment({roomId:d,attachment:e,signal:t.signal})}function eK(e){return u.getSubscriptionSettings({roomId:d,signal:e?.signal})}function ej(e){return u.updateSubscriptionSettings({roomId:d,settings:e})}async function eq(e){await u.markRoomInboxNotificationAsRead({roomId:d,inboxNotificationId:e})}let ez=t.createSyncSource();function eV(e){return ez.setSyncStatus("synchronizing"===e||"loading"===e?"synchronizing":"synchronized")}return Object.defineProperty({[e2]:{get presenceBuffer(){return R(m.buffer.presenceUpdates?.data??null)},get undoStack(){return R(m.undoStack)},get nodeCount(){return m.pool.nodes.size},getYjsProvider:()=>m.yjsProvider,setYjsProvider(e){m.yjsProvider?.off("status",eV),m.yjsProvider=e,e?.on("status",eV),m.yjsProviderDidChange.notify()},yjsProviderDidChange:m.yjsProviderDidChange.observable,reportTextEditor:S,createTextMention:v,deleteTextMention:w,listTextVersions:E,listTextVersionsSince:O,getTextVersion:A,createTextVersion:k,executeContextualPrompt:N,getSelf_forDevTools:()=>U.get(),getOthers_forDevTools:()=>ev.get(),simulate:{explicitClose:e=>p._privateSendMachineEvent({type:"EXPLICIT_SOCKET_CLOSE",event:e}),rawSend:e=>p.send(e)},attachmentUrlsStore:u.getOrCreateAttachmentUrlsStore(d)},id:d,subscribe:(n=d,r=eb,i=t.errorEventSource,function(e,t,o){var s;if("string"==typeof e&&("my-presence"===(s=e)||"others"===s||"event"===s||"error"===s||"history"===s||"status"===s||"storage-status"===s||"lost-connection"===s||"connection"===s||"comments"===s)){if("function"!=typeof t)throw Error("Second argument must be a callback function");switch(e){case"event":return r.customEvent.subscribe(t);case"my-presence":return r.myPresence.subscribe(t);case"others":return r.others.subscribe(e=>{let{others:n,...r}=e;return t(n,r)});case"error":return i.subscribe(e=>{if(e.roomId===n)return t(e)});case"status":return r.status.subscribe(t);case"lost-connection":return r.lostConnection.subscribe(t);case"history":return r.history.subscribe(t);case"storage-status":return r.storageStatus.subscribe(t);case"comments":return r.comments.subscribe(t);default:return eR(e,`"${String(e)}" is not a valid event name`)}}if(void 0===t||"function"==typeof e)if("function"==typeof e)return r.storageBatch.subscribe(e);else throw Error("Please specify a listener callback");if(tM(e))return o?.isDeep?r.storageBatch.subscribe(n=>{let r=n.filter(t=>(function e(t,n){return t===n||"HasParent"===t.parent.type&&e(t.parent.node,n)})(t.node,e));r.length>0&&t(r)}):r.storageBatch.subscribe(n=>{for(let r of n)r.node._id===e._id&&t(r.node)});throw Error(`${String(e)} is not a value that can be subscribed to.`)}),connect:()=>p.connect(),reconnect:()=>p.reconnect(),disconnect:()=>p.disconnect(),destroy:()=>{let{roomWillDestroy:e,...t}=y;for(let e of Object.values(t))e.dispose();y.roomWillDestroy.notify(),m.yjsProvider?.off("status",eV),el.destroy(),ez.destroy(),f(),p.destroy(),e.dispose()},updatePresence:function(e,t){let n={};for(let t in null===m.buffer.presenceUpdates&&(m.buffer.presenceUpdates={type:"partial",data:{}}),e){let r=e[t];void 0!==r&&(m.buffer.presenceUpdates.data[t]=r,n[t]=m.myPresence.get()[t])}m.myPresence.patch(e),m.activeBatch?(t?.addToHistory&&m.activeBatch.reverseOps.pushLeft({type:"presence",data:n}),m.activeBatch.updates.presence=!0):(J(),t?.addToHistory&&z([{type:"presence",data:n}]),V({presence:!0}))},updateYDoc:function(e,t,n){let r={type:301,update:e,guid:t,v2:n};m.buffer.messages.push(r),y.ydoc.notify(r),J()},broadcastEvent:function(e,t={shouldQueueEventIfNotReady:!1}){("connected"===p.getStatus()||t.shouldQueueEventIfNotReady)&&(m.buffer.messages.push({type:103,event:e}),J())},batch:function(e){let t;if(m.activeBatch)return e();m.activeBatch={ops:[],updates:{storageUpdates:new Map,presence:!1,others:[]},reverseOps:new tz};try{t=e()}finally{let e=m.activeBatch;m.activeBatch=null,e.reverseOps.length>0&&z(Array.from(e.reverseOps)),e.ops.length>0&&(m.redoStack.length=0),e.ops.length>0&&Z(e.ops),V(e.updates),J()}return t},history:{undo:function(){if(m.activeBatch)throw Error("undo is not allowed during a batch");let e=m.undoStack.pop();if(void 0===e)return;m.pausedHistory=null;let t=F(e,!0);for(let e of(V(t.updates),m.redoStack.push(t.reverse),W(),t.ops))"presence"!==e.type&&m.buffer.storageOperations.push(e);J()},redo:function(){if(m.activeBatch)throw Error("redo is not allowed during a batch");let e=m.redoStack.pop();if(void 0===e)return;m.pausedHistory=null;let t=F(e,!0);for(let e of(V(t.updates),m.undoStack.push(t.reverse),W(),t.ops))"presence"!==e.type&&m.buffer.storageOperations.push(e);J()},canUndo:B,canRedo:H,clear:function(){m.undoStack.length=0,m.redoStack.length=0},pause:function(){null===m.pausedHistory&&(m.pausedHistory=new tz)},resume:function(){let e=m.pausedHistory;m.pausedHistory=null,null!==e&&e.length>0&&q(Array.from(e))}},fetchYDoc:function(e,t,n){m.buffer.messages.find(r=>300===r.type&&r.vector===e&&r.guid===t&&r.v2===n)||m.buffer.messages.push({type:300,vector:e,guid:t,v2:n}),J()},getStorage:ed,getStorageSnapshot:ea,getStorageStatus:ec,isPresenceReady:ep,isStorageReady:eg,waitUntilPresenceReady:x(em),waitUntilStorageReady:x(ey),events:eb,getStatus:()=>p.getStatus(),getSelf:()=>M.get(),getPresence:()=>m.myPresence.get(),getOthers:()=>m.others.get(),getThreads:ew,getThreadsSince:e_,getThread:eS,createThread:eI,deleteThread:eE,editThreadMetadata:eO,markThreadAsResolved:eA,markThreadAsUnresolved:eT,subscribeToThread:eC,unsubscribeFromThread:eP,createComment:eD,editComment:ex,deleteComment:eL,addReaction:eM,removeReaction:e$,prepareAttachment:function(e){return{type:"localAttachment",status:"idle",id:eu(),name:e.name,size:e.size,mimeType:e.type,file:e}},uploadAttachment:eU,getAttachmentUrl:function(e){return u.getAttachmentUrl({roomId:d,attachmentId:e})},getNotificationSettings:eK,getSubscriptionSettings:eK,updateNotificationSettings:ej,updateSubscriptionSettings:ej,markInboxNotificationAsRead:eq},e2,{enumerable:!1})}({initialPresence:("function"==typeof c.initialPresence?c.initialPresence(t):c.initialPresence)??{},initialStorage:("function"==typeof c.initialStorage?c.initialStorage(t):c.initialStorage)??{}},{roomId:t,throttleDelay:r,lostConnectionTimeout:i,backgroundKeepAliveTimeout:s,polyfills:e.polyfills,delegates:e.mockedDelegates??{createSocket:(d=e.polyfills?.WebSocket,e=>{let n=d??("undefined"==typeof WebSocket?void 0:WebSocket);if(void 0===n)throw new eF("To use Liveblocks client in a non-DOM environment, you need to provide a WebSocket polyfill.");let r=new URL(a);if(r.protocol="http:"===r.protocol?"ws":"wss",r.pathname="/v7",r.searchParams.set("roomId",t),"secret"===e.type)r.searchParams.set("tok",e.token.raw);else{if("public"!==e.type)return eR(e,"Unhandled case");r.searchParams.set("pubkey",e.publicApiKey)}return r.searchParams.set("version",o||"dev"),new n(r.toString())}),authenticate:async()=>g.getAuthValue({requestedScope:"room:read",roomId:t})},enableDebugLogging:e.enableDebugLogging,baseUrl:a,errorEventSource:z,largeMessageStrategy:e.largeMessageStrategy,unstable_streamData:!!e.unstable_streamData,roomHttpClient:y,createSyncSource:F}),h={room:u,unsubs:new Set};if(v.set(t,h),c.autoConnect??!0){if("undefined"==typeof atob){if(e.polyfills?.atob===void 0)throw Error("You need to polyfill atob to use the client in your environment. Please follow the instructions at https://liveblocks.io/docs/errors/liveblocks-client/atob-polyfill");global.atob=e.polyfills.atob}u.connect()}return S(h)},getRoom:function(e){return v.get(e)?.room||null},logout:function(){for(let{room:t}of(g.reset(),d.set(()=>void 0),v.values())){var e;"initial"!==(e=t.getStatus())&&"disconnected"!==e&&t.reconnect()}},getInboxNotifications:y.getInboxNotifications,getInboxNotificationsSince:y.getInboxNotificationsSince,getUnreadInboxNotificationsCount:y.getUnreadInboxNotificationsCount,markAllInboxNotificationsAsRead:y.markAllInboxNotificationsAsRead,markInboxNotificationAsRead:y.markInboxNotificationAsRead,deleteAllInboxNotifications:y.deleteAllInboxNotifications,deleteInboxNotification:y.deleteInboxNotification,getNotificationSettings:B,updateNotificationSettings:W,resolvers:{invalidateUsers:function(e){A.invalidate(e)},invalidateRoomsInfo:function(e){D.invalidate(e)},invalidateMentionSuggestions:function(){M.clear()}},getSyncStatus:function(){let e=q.get();return"synchronizing"===e?e:"synchronized"},events:{error:z,syncStatus:q},[e2]:{currentUserId:d,mentionSuggestionsCache:M,ai:w,resolveMentionSuggestions:e.resolveMentionSuggestions,usersStore:A,roomsInfoStore:D,getRoomIds:()=>Array.from(v.keys()),httpClient:y,as:()=>G,createSyncSource:F,emitError:(e,t)=>{let n=tH.from(e,t);z.notify(n)||_(n.message)}}},e2,{enumerable:!1});return G}function tJ(e,t,n,r,i){if("number"!=typeof t||t<n||void 0!==r&&t>r)throw Error(void 0!==r?`${e} should be between ${i??n} and ${r}.`:`${e} should be at least ${i??n}.`);return t}function tY(e){if(void 0!==e)return tJ("backgroundKeepAliveTimeout",e,15e3)}function tX(e,...t){return()=>{}}function tZ(e){return!("type"in e)&&"text"in e&&"string"==typeof e.text}function tQ(e){return"type"in e&&"mention"===e.type}function t0(e){return"type"in e&&"link"===e.type}var t1={paragraph:function(e){return"type"in e&&"paragraph"===e.type},text:tZ,link:t0,mention:tQ},t2={paragraph:"block",text:"inline",link:"inline",mention:"inline"};function t3(e,t){let n=new Set,r=[];return!function(e,t,n){if(!e||!e?.content)return;let r="string"==typeof t?t:void 0,i=r?t2[r]:"all",o=r?t1[r]:()=>!0,s="function"==typeof t?t:n;for(let t of e.content)if(("all"===i||"block"===i)&&o(t)&&s?.(t),"all"===i||"inline"===i)for(let e of t.children)o(e)&&s?.(e)}(e,"mention",e=>{!n.has(e.id)&&(!t||t(e))&&(n.add(e.id),r.push(e))}),r}var t4={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},t5=RegExp(Object.keys(t4).map(e=>`\\${e}`).join("|"),"g"),t6=class{#eP;#eN;constructor(e,t){this.#eP=e,this.#eN=t}toString(){return this.#eP.reduce((e,t,n)=>e+function(e){if(e instanceof t6)return e.toString();if(Array.isArray(e))return(e.length<=0?new t6([""],[]):new t6(["",...Array(e.length-1).fill(""),""],e)).toString();return String(e).replace(t5,e=>t4[e])}(eN(this.#eN[n-1]))+t)}};function t9(e,...t){return new t6(e,t)}var t8={_:"\\_","*":"\\*","#":"\\#","`":"\\`","~":"\\~","!":"\\!","|":"\\|","(":"\\(",")":"\\)","{":"\\{","}":"\\}","[":"\\[","]":"\\]"},t7=RegExp(Object.keys(t8).map(e=>`\\${e}`).join("|"),"g"),ne=class{#eP;#eN;constructor(e,t){this.#eP=e,this.#eN=t}toString(){return this.#eP.reduce((e,t,n)=>e+function(e){if(e instanceof ne)return e.toString();if(Array.isArray(e))return(e.length<=0?new ne([""],[]):new ne(["",...Array(e.length-1).fill(""),""],e)).toString();return String(e).replace(t7,e=>t8[e])}(eN(this.#eN[n-1]))+t)}};function nt(e,...t){return new ne(e,t)}function nn(e){let t={};for(let n in e){let r=e[n];void 0!==r&&(t[n]=nr(r))}return t}function nr(e){if(e instanceof tP)return nn(e.toObject());if(e instanceof tS)return e.toArray().map(nr);if(e instanceof tR){let t={};for(let[n,r]of e.entries())t[n]=nr(r);return t}return e instanceof t_?e.data:Array.isArray(e)?e.map(nr):O(e)?nn(e):e}function ni(e){if(Array.isArray(e))return new tS(e.map(ni));if(!O(e))return e;{let t={};for(let n in e){let r=e[n];void 0!==r&&(t[n]=ni(r))}return new tP(t)}}var no=[1e3,2e3,4e3,8e3,1e4];function ns(e,t,n){let r=performance.now(),i="undefined"!=typeof document?document:void 0,o="undefined"!=typeof window?window:void 0,s=n?.maxStaleTimeMs??Number.POSITIVE_INFINITY,a={inForeground:i?.visibilityState!=="hidden",lastSuccessfulPollAt:r,count:0,backoff:0};function d(){return a.count>0&&a.inForeground}let l=new eL({}).addState("@idle").addState("@enabled").addState("@polling");function c(){d()?l.send({type:"START"}):l.send({type:"STOP"})}function u(){performance.now()-a.lastSuccessfulPollAt>s&&l.send({type:"POLL"})}function h(e){a.inForeground=e,c(),u()}function f(){h(i?.visibilityState!=="hidden")}return l.addTransitions("@idle",{START:"@enabled"}),l.addTransitions("@enabled",{STOP:"@idle",POLL:"@polling"}),l.addTimedTransition("@enabled",()=>Math.max(0,a.lastSuccessfulPollAt+t-performance.now())+a.backoff,"@polling"),l.onEnterAsync("@polling",async(t,n)=>{await e(n),n.aborted||(a.lastSuccessfulPollAt=performance.now())},()=>({target:d()?"@enabled":"@idle",effect:()=>{a.backoff=0}}),()=>({target:d()?"@enabled":"@idle",effect:()=>{a.backoff=no.find(e=>e>a.backoff)??no[no.length-1]}}),3e4),i?.addEventListener("visibilitychange",f),o?.addEventListener("online",f),o?.addEventListener("focus",u),l.start(),{inc:function(){a.count++,c()},dec:function(){a.count--,a.count<0&&(a.count=0),c()},pollNowIfStale:u,markAsStale:function(){a.lastSuccessfulPollAt=performance.now()-s-1},setInForeground:h}}function na(e,t){return"string"==typeof e?`${e}:${t}`:`${e.kind}:${e.subjectId}`}var nd=(e=>(e.Lexical="lexical",e.TipTap="tiptap",e.BlockNote="blocknote",e))(nd||{});d(i,o,"esm")}}]);