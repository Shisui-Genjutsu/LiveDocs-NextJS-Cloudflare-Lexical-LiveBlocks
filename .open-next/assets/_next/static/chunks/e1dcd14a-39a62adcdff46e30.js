"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[318],{61089:(t,e,i)=>{i.d(e,{$n:()=>et,AH:()=>tM,AZ:()=>tI,Ac:()=>ef,Ci:()=>t2,Ec:()=>tS,FT:()=>F,Lw:()=>t6,N5:()=>tq,Nv:()=>tK,OP:()=>t9,PD:()=>eu,Q2:()=>tG,R1:()=>eo,TA:()=>L,Ul:()=>X,Z5:()=>ep,_j:()=>eh,aV:()=>tR,aq:()=>tE,bK:()=>em,cr:()=>tB,dW:()=>tC,eJ:()=>t8,eg:()=>tk,hx:()=>t3,mN:()=>t7,mp:()=>en,nN:()=>t4,oY:()=>tL,q9:()=>ec,qo:()=>ed,sX:()=>tg,tH:()=>x,tJ:()=>t$,tK:()=>es,uC:()=>t5,w6:()=>ty,xx:()=>tO,yh:()=>el});var n,r,a,o,s,d,l,u,c,h,f,m,p,g,_,v,b,A,w,T,E,I=i(94971),M=i(14096),S=i(86266),R=i(63169),O=i(83893),k=i(74935),y=i(12115),N=i(95155),C=(0,y.createContext)(null);function L(){return(0,y.useContext)(C)}function x(){var t;return null!=(t=L())?t:(0,k.xl)("LiveblocksProvider is missing from the React tree.")}var U=(0,y.createContext)(null);function D(){return(0,y.useContext)(U)}function H(){return null!==D()}function F(t){let e=(0,y.useRef)(t);return(0,y.useEffect)(()=>{e.current=t},[t]),e}function P(t,e,i,n,r){let a,o=(0,y.useRef)(null);null===o.current?o.current=a={hasValue:!1,value:null}:a=o.current;let[s,d]=(0,y.useMemo)(()=>{let t,o,s=!1,d=e=>{var i;if(!s){s=!0,t=e;let i=n(e);if(void 0!==r&&a.hasValue){let t=a.value;if(r(t,i))return o=t,t}return o=i,i}let d=o;if((i=t)===e&&(0!==i||1/i==1/e)||i!=i&&e!=e)return d;let l=n(e);return void 0!==r&&r(d,l)?(t=e,d):(t=e,o=l,l)},l=void 0===i?null:i;return[()=>d(e()),null===l?void 0:()=>d(l())]},[e,i,n,r]),l=(0,y.useSyncExternalStore)(t,s,d);return(0,y.useEffect)(()=>{a.hasValue=!0,a.value=l},[l]),(0,y.useDebugValue)(l),l}var j=t=>t;function X(t,e,i){if(t instanceof k.Xf)throw Error("Using a mutable Signal with useSignal will likely not work as expected.");return P(t.subscribe,t.get,t.get,null!=e?e:j,i)}var V={SMOOTH_DELAY:1e3,NOTIFICATIONS_POLL_INTERVAL:6e4,NOTIFICATIONS_MAX_STALE_TIME:5e3,ROOM_THREADS_POLL_INTERVAL:3e5,ROOM_THREADS_MAX_STALE_TIME:5e3,USER_THREADS_POLL_INTERVAL:6e4,USER_THREADS_MAX_STALE_TIME:3e4,HISTORY_VERSIONS_POLL_INTERVAL:6e4,HISTORY_VERSIONS_MAX_STALE_TIME:5e3,ROOM_SUBSCRIPTION_SETTINGS_POLL_INTERVAL:6e4,ROOM_SUBSCRIPTION_SETTINGS_MAX_STALE_TIME:5e3,USER_NOTIFICATION_SETTINGS_INTERVAL:3e5,USER_NOTIFICATION_SETTINGS_MAX_STALE_TIME:6e4},W=Object.freeze({isLoading:!0}),z=t=>Object.freeze({isLoading:!1,error:t});function B(t,e){return 1==arguments.length?Object.freeze({isLoading:!1,data:t}):Object.freeze({isLoading:!1,[t]:e})}function q(){if("undefined"==typeof window)throw Error("You cannot use the Suspense version of Liveblocks hooks server side. Make sure to only call them client side by using a ClientSideSuspense wrapper.\nFor tips, see https://liveblocks.io/docs/api-reference/liveblocks-react#ClientSideSuspense")}var G=t=>t;function K(t){return(0,y.useReducer)(G,t)[0]}function $(t){let e=K(t);if("function"!=typeof e)return e;{let e=F(t);return(0,y.useCallback)(function(){for(var t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];return e.current(...i)},[e])}}var Y=t=>{if("pending"===t.status)throw t;if("fulfilled"===t.status)return t.value;if("rejected"===t.status)throw t.reason;throw t.status="pending",t.then(e=>{t.status="fulfilled",t.value=e},e=>{t.status="rejected",t.reason=e}),t};function J(t){let e=new Set;e.add("constructor");let i=t.constructor.prototype;do for(let n of Reflect.ownKeys(i)){if(e.has(n))continue;let r=Reflect.getOwnPropertyDescriptor(i,n);"function"==typeof(null==r?void 0:r.value)&&(e.add(n),t[n]=t[n].bind(t))}while((i=Reflect.getPrototypeOf(i))&&i!==Object.prototype)}var Z=(n=new WeakMap,r=new WeakMap,a=new WeakMap,class t{clone(){let e=new t;return(0,S._)(e,n,new Map((0,I._)(this,n))),(0,S._)(e,r,(0,I._)(this,r).clone()),(0,S._)(e,a,(0,I._)(this,a).clone()),e}get(t){let e=this.getEvenIfDeleted(t);return(null==e?void 0:e.deletedAt)?void 0:e}getEvenIfDeleted(t){return(0,I._)(this,n).get(t)}upsert(t){this.signal.mutate(()=>{var e;let i=(t=(e=t).deletedAt&&e.comments.length>0?{...e,comments:[]}:!e.comments.some(t=>!t.deletedAt)?{...e,deletedAt:new Date,comments:[]}:e).id,o=(0,I._)(this,n).get(i);if(o){if(o.deletedAt)return!1;(0,I._)(this,r).remove(o),(0,I._)(this,a).remove(o)}return t.deletedAt||((0,I._)(this,r).add(t),(0,I._)(this,a).add(t)),(0,I._)(this,n).set(i,t),!0})}upsertIfNewer(t){let e=this.get(t.id);(!e||t.updatedAt>=e.updatedAt)&&this.upsert(t)}applyDelta(t,e){(0,k.OX)(()=>{for(let e of t)this.upsertIfNewer(e);for(let{id:t,deletedAt:i}of e)this.getEvenIfDeleted(t)&&this.delete(t,i)})}delete(t,e){let i=(0,I._)(this,n).get(t);i&&!i.deletedAt&&this.upsert({...i,deletedAt:e,updatedAt:e})}findMany(t,e,i){let n="desc"===i?(0,I._)(this,a):(0,I._)(this,r),o=[];return void 0!==t&&o.push(e=>e.roomId===t),void 0!==e&&o.push(t=>{var i,n;return i=t,(void 0===(n=e).resolved||i.resolved===n.resolved)&&function(t,e){let i=t.metadata;return void 0===e.metadata||Object.entries(e.metadata).every(t=>{var e,n;let[r,a]=t;return void 0===a||(e=i[r],null===(n=a)?void 0===e:(0,k.WU)(n)?"string"==typeof e&&e.startsWith(n.startsWith):e===n)})}(t,e)}),Array.from(n.filter(t=>o.every(e=>e(t))))}constructor(){(0,M._)(this,n,{writable:!0,value:void 0}),(0,M._)(this,r,{writable:!0,value:void 0}),(0,M._)(this,a,{writable:!0,value:void 0}),(0,S._)(this,r,k.aG.from([],(t,e)=>{let i=t.createdAt,n=e.createdAt;return i<n||i===n&&t.id<e.id})),(0,S._)(this,a,k.aG.from([],(t,e)=>{let i=e.updatedAt,n=t.updatedAt;return i<n||i===n&&e.id<t.id})),(0,S._)(this,n,new Map),this.signal=new k.Xf(this)}});function Q(t,e){return(0,k.JB)([t,null!=e?e:{}])}function tt(t){return stableStringify(null!=t?t:{})}function te(t){return"status"in t||(t.status="pending",t.then(e=>{t.status="fulfilled",t.value=e},e=>{t.status="rejected",t.reason=e})),t}var ti=Promise.resolve(),tn=(o=new WeakMap,s=new WeakMap,d=new WeakMap,l=new WeakSet,u=new WeakSet,c=new WeakMap,class{get(){return(0,I._)(this,o).get()}fetchMore(){var t;return(null==(t=(0,I._)(this,o).get().data)?void 0:t.cursor)?((0,I._)(this,d)||(0,S._)(this,d,(0,R._)(this,u,e_).call(this).finally(()=>{(0,S._)(this,d,null)})),(0,I._)(this,d)):ti}waitUntilLoaded(){if((0,I._)(this,c))return(0,I._)(this,c);let t=te((0,k.Ap)(()=>(0,I._)(this,s).call(this,void 0),5,[5e3,5e3,1e4,15e3]));return t.then(t=>{(0,I._)(this,o).set(B({cursor:t,hasFetchedAll:null===t,isFetchingMore:!1,fetchMoreError:void 0,fetchMore:this.fetchMore}))},t=>{(0,I._)(this,o).set(z(t)),setTimeout(()=>{(0,S._)(this,c,null),(0,I._)(this,o).set(W)},5e3)}),(0,S._)(this,c,t),(0,I._)(this,c)}constructor(t){(0,O._)(this,l),(0,O._)(this,u),(0,M._)(this,o,{writable:!0,value:void 0}),(0,M._)(this,s,{writable:!0,value:void 0}),(0,M._)(this,d,{writable:!0,value:void 0}),(0,M._)(this,c,{writable:!0,value:void 0}),(0,S._)(this,c,null),(0,S._)(this,o,new k.HN(W)),(0,S._)(this,s,t),(0,S._)(this,d,null),this.signal=(0,I._)(this,o).asReadonly(),J(this)}}),tr=(h=new WeakMap,f=new WeakMap,m=new WeakMap,class{get(){return(0,I._)(this,h).get()}waitUntilLoaded(){if((0,I._)(this,m))return(0,I._)(this,m);let t=te((0,k.Ap)(()=>(0,I._)(this,f).call(this),5,[5e3,5e3,1e4,15e3]));return t.then(()=>{(0,I._)(this,h).set(B(void 0))},t=>{(0,I._)(this,h).set(z(t)),setTimeout(()=>{(0,S._)(this,m,null),(0,I._)(this,h).set(W)},5e3)}),(0,S._)(this,m,t),t}constructor(t){(0,M._)(this,h,{writable:!0,value:void 0}),(0,M._)(this,f,{writable:!0,value:void 0}),(0,M._)(this,m,{writable:!0,value:void 0}),(0,S._)(this,m,null),(0,S._)(this,h,new k.HN(W)),this.signal=(0,I._)(this,h).asReadonly(),(0,S._)(this,f,t),J(this)}}),ta=(p=new WeakMap,g=new WeakMap,_=new WeakMap,v=new WeakMap,b=new WeakMap,A=new WeakMap,w=new WeakMap,T=new WeakMap,E=new WeakSet,class{markInboxNotificationRead(t,e,i){(0,k.OX)(()=>{this.optimisticUpdates.remove(i),this.notifications.markRead(t,e)})}markAllInboxNotificationsRead(t,e){(0,k.OX)(()=>{this.optimisticUpdates.remove(t),this.notifications.markAllRead(e)})}deleteInboxNotification(t,e){(0,k.OX)(()=>{this.optimisticUpdates.remove(e),this.notifications.delete(t)})}deleteAllInboxNotifications(t){(0,k.OX)(()=>{this.optimisticUpdates.remove(t),this.notifications.clear()})}createSubscription(t,e){(0,k.OX)(()=>{this.optimisticUpdates.remove(e),this.subscriptions.create(t)})}deleteSubscription(t,e){(0,k.OX)(()=>{this.optimisticUpdates.remove(e),this.subscriptions.delete(t)})}createThread(t,e){(0,k.OX)(()=>{this.optimisticUpdates.remove(t),this.threads.upsert(e)})}patchThread(t,e,i,n){return(0,R._)(this,E,ev).call(this,t,e,t=>({...t,...(0,k.BU)(i)}),n)}addReaction(t,e,i,n,r){(0,R._)(this,E,ev).call(this,t,e,t=>td(t,i,n),r)}removeReaction(t,e,i,n,r,a){(0,R._)(this,E,ev).call(this,t,e,t=>tl(t,i,n,r,a),a)}deleteThread(t,e){return(0,R._)(this,E,ev).call(this,t,e,t=>({...t,updatedAt:new Date,deletedAt:new Date}))}createComment(t,e){(0,k.OX)(()=>{this.optimisticUpdates.remove(e);let i=this.threads.get(t.threadId);i&&(this.threads.upsert(to(i,t)),this.notifications.updateAssociatedNotification(t))})}editComment(t,e,i){return(0,R._)(this,E,ev).call(this,t,e,t=>to(t,i))}deleteComment(t,e,i,n){return(0,R._)(this,E,ev).call(this,t,e,t=>ts(t,i,n),n)}updateThreadifications(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[];(0,k.OX)(()=>{this.threads.applyDelta(t,n),this.notifications.applyDelta(e,r),this.subscriptions.applyDelta(i,a)})}updateRoomSubscriptionSettings(t,e,i){(0,k.OX)(()=>{this.optimisticUpdates.remove(e),this.roomSubscriptionSettings.update(t,i)})}async fetchNotificationsDeltaUpdate(t){let e=(0,I._)(this,g);if(null===e)return;let i=await (0,I._)(this,p).getInboxNotificationsSince({since:e,signal:t});e<i.requestedAt&&(0,S._)(this,g,i.requestedAt),this.updateThreadifications(i.threads.updated,i.inboxNotifications.updated,i.subscriptions.updated,i.threads.deleted,i.inboxNotifications.deleted,i.subscriptions.deleted)}async fetchRoomThreadsDeltaUpdate(t,e){let i=(0,I._)(this,v).get(t);if(void 0===i)return;let n=await (0,I._)(this,p)[k.HM].httpClient.getThreadsSince({roomId:t,since:i,signal:e});this.updateThreadifications(n.threads.updated,n.inboxNotifications.updated,n.subscriptions.updated,n.threads.deleted,n.inboxNotifications.deleted,n.subscriptions.deleted),this.permissionHints.update(n.permissionHints),i<n.requestedAt&&(0,I._)(this,v).set(t,n.requestedAt)}async fetchUserThreadsDeltaUpdate(t){let e=(0,I._)(this,b);if(null===e)return;let i=await (0,I._)(this,p)[k.HM].httpClient.getUserThreadsSince_experimental({since:e,signal:t});e<i.requestedAt&&(0,S._)(this,g,i.requestedAt),this.updateThreadifications(i.threads.updated,i.inboxNotifications.updated,i.subscriptions.updated,i.threads.deleted,i.inboxNotifications.deleted,i.subscriptions.deleted),this.permissionHints.update(i.permissionHints)}async fetchRoomVersionsDeltaUpdate(t,e){let i=(0,I._)(this,A).get(t);if(void 0===i)return;let n=(0,k.nn)((0,I._)(this,p).getRoom(t),"Room with id ".concat(t," is not available on client")),r=await n[k.HM].listTextVersionsSince({since:i,signal:e});this.historyVersions.update(t,r.versions),i<r.requestedAt&&(0,I._)(this,A).set(t,r.requestedAt)}async refreshRoomSubscriptionSettings(t,e){let i=(0,k.nn)((0,I._)(this,p).getRoom(t),"Room with id ".concat(t," is not available on client")),n=await i.getSubscriptionSettings({signal:e});this.roomSubscriptionSettings.update(t,n)}async refreshNotificationSettings(t){let e=await (0,I._)(this,p).getNotificationSettings({signal:t});this.notificationSettings.update(e)}updateNotificationSettings_confirmOptimisticUpdate(t,e){(0,k.OX)(()=>{this.optimisticUpdates.remove(e),this.notificationSettings.update(t)})}constructor(t){(0,O._)(this,E),(0,M._)(this,p,{writable:!0,value:void 0}),(0,M._)(this,g,{writable:!0,value:void 0}),(0,M._)(this,_,{writable:!0,value:void 0}),(0,M._)(this,v,{writable:!0,value:void 0}),(0,M._)(this,b,{writable:!0,value:void 0}),(0,M._)(this,A,{writable:!0,value:void 0}),(0,M._)(this,w,{writable:!0,value:void 0}),(0,M._)(this,T,{writable:!0,value:void 0}),(0,S._)(this,g,null),(0,S._)(this,v,new Map),(0,S._)(this,b,null),(0,S._)(this,A,new Map),(0,S._)(this,p,t[k.HM].as()),this.optimisticUpdates=function(t){let e=new k.HN([]),i=t[k.HM].createSyncSource();return e.subscribe(()=>i.setSyncStatus(e.get().length>0?"synchronizing":"synchronized")),{signal:e.asReadonly(),add:function(t){let i=(0,k.Ak)(),n={...t,id:i};return e.set(t=>[...t,n]),i},remove:function(t){e.set(e=>e.filter(e=>e.id!==t))}}}((0,I._)(this,p)),this.permissionHints=function(){let t=new k.Ge(()=>new k.HN(new Set));return{getPermissionForRoomΣ:function(e){return t.getOrCreate(e)},update:function(e){(0,k.OX)(()=>{for(let[i,n]of Object.entries(e)){let e=t.getOrCreate(i),r=new Set(e.get());for(let t of n)r.add(t);e.set(r)}})}}}(),(0,S._)(this,_,new tn(async t=>{let e=await (0,I._)(this,p).getInboxNotifications({cursor:t});return this.updateThreadifications(e.threads,e.inboxNotifications,e.subscriptions),null===(0,I._)(this,g)&&(0,S._)(this,g,e.requestedAt),e.nextCursor}));let e=async()=>{let t=await (0,I._)(this,p).getNotificationSettings();this.notificationSettings.update(t)};this.notificationSettings=function(t){let e=new k.HN((0,k.b4)({}));return{signal:k.ez.from(e,t,(t,e)=>(function(t,e){let i=t;for(let t of e)"update-notification-settings"===t.type&&(i=(0,k.Fr)(i,t.settings));return i})(t,e)),update:function(t){e.set(t)}}}(this.optimisticUpdates.signal),(0,S._)(this,w,new tr(e)),(0,S._)(this,T,new tn(async t=>(await (0,I._)(this,p)[k.HM].ai.getChats({cursor:t})).nextCursor)),this.threads=new Z,this.subscriptions=function(t,e){let i=new k.Xf(new Map);return{signal:k.ez.from(i,t,(t,i)=>(function(t,e,i){let n=Object.fromEntries(t);for(let t of i)if("update-room-subscription-settings"===t.type){if(!t.settings.threads)continue;for(let i of e.findMany(t.roomId,void 0,"desc")){let e=(0,k.P$)("thread",i.id);switch(t.settings.threads){case"all":n[e]={kind:"thread",subjectId:i.id,createdAt:new Date};break;case"none":delete n[e];break;case"replies_and_mentions":(function(t,e){let i=!1;for(let n of t.comments)if(!n.deletedAt&&(n.userId===e||(0,k.Je)(n.body,t=>"user"===t.kind&&t.id===e).length>0)){i=!0;break}return i})(i,t.userId)&&!n[e]&&(n[e]={kind:"thread",subjectId:i.id,createdAt:new Date});break;default:(0,k.xb)(t.settings.threads,"Unexpected thread subscription settings.")}}}return n})(t,e,i)),applyDelta:function(t,e){i.mutate(i=>{let n=!1;for(let e of t)i.set((0,k.P$)(e),e),n=!0;for(let t of e)i.delete((0,k.P$)(t)),n=!0;return n})},create:function(t){i.mutate(e=>{e.set((0,k.P$)(t),t)})},delete:function(t){i.mutate(e=>{e.delete(t)})}}}(this.optimisticUpdates.signal,this.threads),this.notifications=function(){let t=new k.Xf(new Map);return{signal:t.asReadonly(),markAllRead:function(e){t.mutate(t=>{for(let i of t.values())i.readAt=e})},markRead:function(e,i){t.mutate(t=>{let n=t.get(e);return!!n&&(t.set(e,{...n,readAt:i}),!0)})},delete:function(e){t.mutate(t=>t.delete(e))},applyDelta:function(e,i){t.mutate(t=>{let n=!1;for(let i of e){var r,a;let e=t.get(i.id);(!e||1!==(r=e,a=i,r.notifiedAt>a.notifiedAt?1:r.notifiedAt<a.notifiedAt?-1:r.readAt&&a.readAt?r.readAt>a.readAt?1:r.readAt<a.readAt?-1:0:r.readAt||a.readAt?r.readAt?1:-1:0))&&(t.set(i.id,i),n=!0)}for(let e of i)t.delete(e.id),n=!0;return n})},clear:function(){t.mutate(t=>t.clear())},updateAssociatedNotification:function(e){t.mutate(t=>{let i=function(t,e){for(let i of t)if(e(i))return i}(t.values(),t=>"thread"===t.kind&&t.threadId===e.threadId);return!!i&&(t.set(i.id,{...i,notifiedAt:e.createdAt,readAt:e.createdAt}),!0)})},upsert:function(e){t.mutate(t=>{t.set(e.id,e)})}}}(),this.roomSubscriptionSettings=function(t){let e=new k.Xf(new Map);return{signal:k.ez.from(e,t,(t,e)=>(function(t,e){let i=Object.fromEntries(t);for(let t of e)switch(t.type){case"update-room-subscription-settings":{let e=i[t.roomId];if(void 0===e)break;i[t.roomId]={...e,...t.settings}}}return i})(t,e)),update:function(t,i){e.mutate(e=>{e.set(t,i)})}}}(this.optimisticUpdates.signal),this.historyVersions=function(){let t=new k.Xf(new k.Ge(()=>new Map));return{signal:k.ez.from(t,t=>Object.fromEntries([...t].map(t=>{let[e,i]=t;return[e,Object.fromEntries(i)]}))),update:function(e,i){t.mutate(t=>{let n=t.getOrCreate(e);for(let t of i)n.set(t.id,t)})}}}();let i=k.ez.from(this.threads.signal,this.notifications.signal,this.optimisticUpdates.signal,(t,e,i)=>(function(t,e,i){let n=t.clone(),r=Object.fromEntries(e);for(let t of i)switch(t.type){case"create-thread":n.upsert(t.thread);break;case"edit-thread-metadata":{let e=n.get(t.threadId);if(void 0===e||e.updatedAt>t.updatedAt)break;n.upsert({...e,updatedAt:t.updatedAt,metadata:{...e.metadata,...t.metadata}});break}case"mark-thread-as-resolved":{let e=n.get(t.threadId);if(void 0===e)break;n.upsert({...e,resolved:!0});break}case"mark-thread-as-unresolved":{let e=n.get(t.threadId);if(void 0===e)break;n.upsert({...e,resolved:!1});break}case"create-comment":{let e=n.get(t.comment.threadId);if(void 0===e)break;n.upsert(to(e,t.comment));let i=Object.values(r).find(t=>"thread"===t.kind&&t.threadId===e.id);if(void 0===i)break;r[i.id]={...i,notifiedAt:t.comment.createdAt,readAt:t.comment.createdAt};break}case"edit-comment":{let e=n.get(t.comment.threadId);if(void 0===e)break;n.upsert(to(e,t.comment));break}case"delete-comment":{let e=n.get(t.threadId);if(void 0===e)break;n.upsert(ts(e,t.commentId,t.deletedAt));break}case"delete-thread":{let e=n.get(t.threadId);if(void 0===e)break;n.upsert({...e,deletedAt:t.deletedAt,updatedAt:t.deletedAt,comments:[]});break}case"add-reaction":{let e=n.get(t.threadId);if(void 0===e)break;n.upsert(td(e,t.commentId,t.reaction));break}case"remove-reaction":{let e=n.get(t.threadId);if(void 0===e)break;n.upsert(tl(e,t.commentId,t.emoji,t.userId,t.removedAt));break}case"mark-inbox-notification-as-read":{let e=r[t.inboxNotificationId];if(void 0===e)break;r[t.inboxNotificationId]={...e,readAt:t.readAt};break}case"mark-all-inbox-notifications-as-read":for(let e in r){let i=r[e];if(void 0===i)break;r[e]={...i,readAt:t.readAt}}break;case"delete-inbox-notification":delete r[t.inboxNotificationId];break;case"delete-all-inbox-notifications":r={}}return{sortedNotifications:Object.values(r).filter(t=>"thread"!==t.kind||void 0!==n.get(t.threadId)).sort((t,e)=>e.notifiedAt.getTime()-t.notifiedAt.getTime()),notificationsById:r,threadsDB:n}})(t,e,i)),n=k.ez.from(i,t=>t.threadsDB),r=k.ez.from(i,t=>({sortedNotifications:t.sortedNotifications,notificationsById:t.notificationsById}),k.x7),a=k.ez.from(r,this.subscriptions.signal,(t,e)=>({subscriptions:e,notifications:t.sortedNotifications})),o=new k.Ge(t=>{let e=JSON.parse(t),i=new tn(async t=>{let i=await (0,I._)(this,p)[k.HM].httpClient.getUserThreads_experimental({cursor:t,query:e});return this.updateThreadifications(i.threads,i.inboxNotifications,i.subscriptions),this.permissionHints.update(i.permissionHints),null===(0,I._)(this,b)&&(0,S._)(this,b,i.requestedAt),i.nextCursor});return{signal:k.ez.from(()=>{let t=i.get();if(t.isLoading||t.error)return t;let n=this.outputs.threads.get().findMany(void 0,null!=e?e:{},"desc"),r=t.data;return{isLoading:!1,threads:n,hasFetchedAll:r.hasFetchedAll,isFetchingMore:r.isFetchingMore,fetchMoreError:r.fetchMoreError,fetchMore:r.fetchMore}},k.dP),waitUntilLoaded:i.waitUntilLoaded}}),s=new k.Ge(t=>{let[e,i]=JSON.parse(t),n=new tn(async t=>{let n=await (0,I._)(this,p)[k.HM].httpClient.getThreads({roomId:e,cursor:t,query:i});this.updateThreadifications(n.threads,n.inboxNotifications,n.subscriptions),this.permissionHints.update(n.permissionHints);let r=(0,I._)(this,v).get(e);return(void 0===r||r>n.requestedAt)&&(0,I._)(this,v).set(e,n.requestedAt),n.nextCursor});return{signal:k.ez.from(()=>{let t=n.get();if(t.isLoading||t.error)return t;let r=this.outputs.threads.get().findMany(e,null!=i?i:{},"asc"),a=t.data;return{isLoading:!1,threads:r,hasFetchedAll:a.hasFetchedAll,isFetchingMore:a.isFetchingMore,fetchMoreError:a.fetchMoreError,fetchMore:a.fetchMore}},k.dP),waitUntilLoaded:n.waitUntilLoaded}}),d={signal:k.ez.from(()=>{let t=(0,I._)(this,_).get();if(t.isLoading||t.error)return t;let e=t.data;return{isLoading:!1,inboxNotifications:this.outputs.notifications.get().sortedNotifications,hasFetchedAll:e.hasFetchedAll,isFetchingMore:e.isFetchingMore,fetchMoreError:e.fetchMoreError,fetchMore:e.fetchMore}}),waitUntilLoaded:(0,I._)(this,_).waitUntilLoaded},l=new k.Ge(t=>{let e=new tr(async()=>{let e=(0,I._)(this,p).getRoom(t);if(null===e)throw Error("Room '".concat(t,"' is not available on client"));let i=await e.getSubscriptionSettings();this.roomSubscriptionSettings.update(t,i)});return{signal:k.ez.from(()=>{let i=e.get();return i.isLoading||i.error?i:B("settings",(0,k.nn)(this.roomSubscriptionSettings.signal.get()[t]))},k.x7),waitUntilLoaded:e.waitUntilLoaded}}),u=new k.Ge(t=>{let e=new tr(async()=>{let e=(0,I._)(this,p).getRoom(t);if(null===e)throw Error("Room '".concat(t,"' is not available on client"));let i=await e[k.HM].listTextVersions();this.historyVersions.update(t,i.versions);let n=(0,I._)(this,A).get(t);(void 0===n||n>i.requestedAt)&&(0,I._)(this,A).set(t,i.requestedAt)});return{signal:k.ez.from(()=>{var i;let n=e.get();return n.isLoading||n.error?n:B("versions",Object.values(null!=(i=this.historyVersions.signal.get()[t])?i:{}))},k.x7),waitUntilLoaded:e.waitUntilLoaded}}),c={signal:k.ez.from(()=>{let t=(0,I._)(this,w).get();return t.isLoading||t.error?t:B("settings",(0,k.nn)(this.notificationSettings.signal.get()))},k.x7),waitUntilLoaded:(0,I._)(this,w).waitUntilLoaded},h={signal:k.ez.from(()=>{let t=(0,I._)(this,T).get();return t.isLoading||t.error?t:{isLoading:!1,chats:(0,I._)(this,p)[k.HM].ai.signals.chatsΣ.get(),hasFetchedAll:t.data.hasFetchedAll,isFetchingMore:t.data.isFetchingMore,fetchMore:t.data.fetchMore,fetchMoreError:t.data.fetchMoreError}},k.x7),waitUntilLoaded:(0,I._)(this,T).waitUntilLoaded},f=new k.Ge(t=>{let e=new tr(async()=>{await (0,I._)(this,p)[k.HM].ai.getMessageTree(t)});return new k.Ge(i=>({signal:k.ez.from(()=>{let n=e.get();return n.isLoading||n.error?n:B("messages",(0,I._)(this,p)[k.HM].ai.signals.getChatMessagesForBranchΣ(t,null!=i?i:void 0).get())}),waitUntilLoaded:e.waitUntilLoaded}))}),m=new k.Ge(t=>{let e=new tr(async()=>{await (0,I._)(this,p)[k.HM].ai.getOrCreateChat(t)});return{signal:k.ez.from(()=>{if(void 0!==(0,I._)(this,p)[k.HM].ai.getChatById(t))return B("chat",(0,k.nn)((0,I._)(this,p)[k.HM].ai.getChatById(t)));{let i=e.get();return i.isLoading||i.error?i:B("chat",(0,k.nn)((0,I._)(this,p)[k.HM].ai.getChatById(t)))}},k.x7),waitUntilLoaded:e.waitUntilLoaded}});this.outputs={threadifications:i,threads:n,loadingRoomThreads:s,loadingUserThreads:o,notifications:r,loadingNotifications:d,roomSubscriptionSettingsByRoomId:l,versionsByRoomId:u,notificationSettings:c,threadSubscriptions:a,aiChats:h,messagesByChatId:f,aiChatById:m},J(this)}});function to(t,e){if(void 0!==t.deletedAt)return t;if(e.threadId!==t.id)return k.k2.warn("Comment ".concat(e.id," does not belong to thread ").concat(t.id)),t;let i=t.comments.find(t=>t.id===e.id);if(void 0===i){let i=new Date(Math.max(t.updatedAt.getTime(),e.createdAt.getTime()));return{...t,updatedAt:i,comments:[...t.comments,e]}}if(void 0!==i.deletedAt)return t;if(void 0===i.editedAt||void 0===e.editedAt||i.editedAt<=e.editedAt){var n;let i=t.comments.map(t=>t.id===e.id?e:t);return{...t,updatedAt:new Date(Math.max(t.updatedAt.getTime(),(null==(n=e.editedAt)?void 0:n.getTime())||e.createdAt.getTime())),comments:i}}return t}function ts(t,e,i){if(void 0!==t.deletedAt)return t;let n=t.comments.find(t=>t.id===e);if(void 0===n||void 0!==n.deletedAt)return t;let r=t.comments.map(t=>t.id===e?{...t,deletedAt:i,body:void 0,attachments:[]}:t);return r.every(t=>void 0!==t.deletedAt)?{...t,deletedAt:i,updatedAt:i}:{...t,updatedAt:i,comments:r}}function td(t,e,i){if(void 0!==t.deletedAt)return t;let n=t.comments.find(t=>t.id===e);if(void 0===n||void 0!==n.deletedAt)return t;let r=t.comments.map(t=>t.id===e?{...t,reactions:function(t,e){let i=t.find(t=>t.emoji===e.emoji);return void 0===i?[...t,{emoji:e.emoji,createdAt:e.createdAt,users:[{id:e.userId}]}]:!1===i.users.some(t=>t.id===e.userId)?t.map(t=>t.emoji===e.emoji?{...t,users:[...t.users,{id:e.userId}]}:t):t}(t.reactions,i)}:t);return{...t,updatedAt:new Date(Math.max(i.createdAt.getTime(),t.updatedAt.getTime())),comments:r}}function tl(t,e,i,n,r){if(void 0!==t.deletedAt)return t;let a=t.comments.find(t=>t.id===e);if(void 0===a||void 0!==a.deletedAt)return t;let o=t.comments.map(t=>t.id===e?{...t,reactions:t.reactions.map(t=>t.emoji===i?{...t,users:t.users.filter(t=>t.id!==n)}:t).filter(t=>t.users.length>0)}:t);return{...t,updatedAt:new Date(Math.max(r.getTime(),t.updatedAt.getTime())),comments:o}}function tu(t){return Error("resolveUsers didn't return anything for user '".concat(t,"'"))}function tc(t){return Error("resolveRoomsInfo didn't return anything for room '".concat(t,"'"))}function th(t){return t}var tf=new WeakMap,tm=new WeakMap;function tp(t){return t.inboxNotifications?B("count",function(t,e){let i=0;for(let n of t)e(n)&&i++;return i}(t.inboxNotifications,t=>null===t.readAt||t.readAt<t.notifiedAt)):t}function tg(t){let e=tf.get(t);return e||(e=new ta(t),tf.set(t,e)),e}function t_(t){let e=tm.get(t);return e||(e=function(t){let e=tg(t),i=(0,k.F2)(async t=>{try{return await e.fetchNotificationsDeltaUpdate(t)}catch(t){throw t}},V.NOTIFICATIONS_POLL_INTERVAL,{maxStaleTimeMs:V.NOTIFICATIONS_MAX_STALE_TIME}),n=(0,k.F2)(async t=>{try{return await e.fetchUserThreadsDeltaUpdate(t)}catch(t){throw t}},V.USER_THREADS_POLL_INTERVAL,{maxStaleTimeMs:V.USER_THREADS_MAX_STALE_TIME}),r=(0,k.F2)(async t=>{try{return await e.refreshNotificationSettings(t)}catch(t){throw t}},V.USER_NOTIFICATION_SETTINGS_INTERVAL,{maxStaleTimeMs:V.USER_NOTIFICATION_SETTINGS_MAX_STALE_TIME});return{store:e,notificationsPoller:i,userThreadsPoller:n,notificationSettingsPoller:r}}(t),tm.set(t,e)),e}function tv(t){useEffect4(()=>{t[kInternal3].ai.connectInitially()},[t])}function tb(t,e,i){let{store:n,notificationsPoller:r}=t_(t);return(0,y.useEffect)(()=>void n.outputs.loadingNotifications.waitUntilLoaded()),(0,y.useEffect)(()=>(r.inc(),r.pollNowIfStale(),()=>{r.dec()}),[r]),X(n.outputs.loadingNotifications.signal,e,i)}function tA(t,e){let i=t[k.HM].usersStore,n=(0,y.useCallback)(()=>i.getItemState(e),[i,e]),r=(0,y.useCallback)(t=>void 0===t||(null==t?void 0:t.isLoading)?null!=t?t:{isLoading:!0}:t.error?t:t.data?{isLoading:!1,user:t.data}:{isLoading:!1,error:tu(e)},[e]),a=P(i.subscribe,n,n,r,k.x7);return(0,y.useEffect)(()=>void i.enqueue(e)),a}function tw(t,e){let i=t[k.HM].roomsInfoStore,n=(0,y.useCallback)(()=>i.getItemState(e),[i,e]),r=(0,y.useCallback)(t=>void 0===t||(null==t?void 0:t.isLoading)?null!=t?t:{isLoading:!0}:t.error?t:t.data?{isLoading:!1,info:t.data}:{isLoading:!1,error:tc(e)},[e]),a=P(i.subscribe,n,n,r,k.x7);return(0,y.useEffect)(()=>void i.enqueue(e)),a}function tT(t){return function(t){let e=L();if(!(null==t?void 0:t.allowNesting)&&null!==e)throw Error("You cannot nest multiple LiveblocksProvider instances in the same React tree.")}(t),(0,N.jsx)(C.Provider,{value:t.client,children:t.children})}function tE(t){let{children:e,...i}=t,n={publicApiKey:K(i.publicApiKey),throttle:K(i.throttle),lostConnectionTimeout:K(i.lostConnectionTimeout),backgroundKeepAliveTimeout:K(i.backgroundKeepAliveTimeout),polyfills:K(i.polyfills),largeMessageStrategy:K(i.largeMessageStrategy),unstable_streamData:K(i.unstable_streamData),preventUnsavedChanges:K(i.preventUnsavedChanges),authEndpoint:$(i.authEndpoint),resolveMentionSuggestions:$(i.resolveMentionSuggestions),resolveUsers:$(i.resolveUsers),resolveRoomsInfo:$(i.resolveRoomsInfo),baseUrl:K(i.baseUrl),enableDebugLogging:K(i.enableDebugLogging)},r=(0,y.useMemo)(()=>(0,k.UU)(n),[]);return(0,y.useEffect)(()=>()=>{r[k.HM].ai.disconnect()},[r]),(0,N.jsx)(tT,{client:r,children:e})}function tI(){var t=x();q(),Y(t_(t).store.outputs.loadingNotifications.waitUntilLoaded());let e=tb(t,th,k.x7);return(0,k.vA)(!e.error,"Did not expect error"),(0,k.vA)(!e.isLoading,"Did not expect loading"),e}function tM(){var t;return t=x(),(0,y.useCallback)(e=>{let{store:i}=t_(t),n=new Date,r=i.optimisticUpdates.add({type:"mark-inbox-notification-as-read",inboxNotificationId:e,readAt:n});t.markInboxNotificationAsRead(e).then(()=>{i.markInboxNotificationRead(e,n,r)},n=>{i.optimisticUpdates.remove(r),t[k.HM].emitError({type:"MARK_INBOX_NOTIFICATION_AS_READ_ERROR",inboxNotificationId:e},n)})},[t])}function tS(){var t;return t=x(),(0,y.useCallback)(e=>{let{store:i}=t_(t),n=new Date,r=i.optimisticUpdates.add({type:"delete-inbox-notification",inboxNotificationId:e,deletedAt:n});t.deleteInboxNotification(e).then(()=>{i.deleteInboxNotification(e,r)},n=>{i.optimisticUpdates.remove(r),t[k.HM].emitError({type:"DELETE_INBOX_NOTIFICATION_ERROR",inboxNotificationId:e},n)})},[t])}function tR(){var t=x();q(),Y(t_(t).store.outputs.loadingNotifications.waitUntilLoaded());let e=tb(t,tp,k.x7);return(0,k.vA)(!e.isLoading,"Did not expect loading"),(0,k.vA)(!e.error,"Did not expect error"),e}function tO(t){return tw(x(),t)}var tk=function(t){var e=x(),i=t;let{store:n}=t_(e);return X(n.outputs.threadifications,(0,y.useCallback)(t=>{var e,n;let r=null!=(e=t.notificationsById[i])?e:(0,k.xl)('Inbox notification with ID "'.concat(i,'" not found'));return"thread"!==r.kind&&(0,k.xl)('Inbox notification with ID "'.concat(i,'" is not of kind "thread"')),null!=(n=t.threadsDB.get(r.threadId))?n:(0,k.xl)('Thread with ID "'.concat(r.threadId,'" not found, this inbox notification might not be of kind "thread"'))},[i]))},ty=function(t){return tA(x(),t)};function tN(t,e){var i,n;return K(null!=(i=null==e?void 0:e.smooth)&&i)?function(t){let e=t.getSyncStatus,[i,n]=(0,y.useState)(e),r=F(e());return(0,y.useEffect)(()=>{let i,a=t.events.syncStatus.subscribe(()=>{let t=e();"synchronizing"===r.current&&"synchronized"===t?i=setTimeout(()=>n(t),V.SMOOTH_DELAY):(clearTimeout(i),n(t))});return()=>{clearTimeout(i),a()}},[t,e,r]),i}(t):(n=t,(0,y.useSyncExternalStore)(n.events.syncStatus.subscribe,n.getSyncStatus,n.getSyncStatus))}function tC(t){return tN(x(),t)}function tL(t){let e=x(),i=F(t);(0,y.useEffect)(()=>e.events.error.subscribe(t=>i.current(t)),[e,i])}var tx=()=>{},tU=t=>t,tD=Object.freeze([]);function tH(){return tD}function tF(){return null}function tP(t){return t.map(t=>t.connectionId)}function tj(t){let e=t[k.HM].currentUserId.get();return void 0===e?"anonymous":e}var tX=new WeakMap;function tV(t){let e=tX.get(t);return e||(e=function(t){let e=tg(t),i=new k.Ge(t=>(0,k.F2)(async i=>{try{return await e.fetchRoomThreadsDeltaUpdate(t,i)}catch(e){throw k.k2.warn("Polling new threads for '".concat(t,"' failed: ").concat(String(e))),e}},V.ROOM_THREADS_POLL_INTERVAL,{maxStaleTimeMs:V.ROOM_THREADS_MAX_STALE_TIME})),n=new k.Ge(t=>(0,k.F2)(async i=>{try{return await e.fetchRoomVersionsDeltaUpdate(t,i)}catch(e){throw k.k2.warn("Polling new history versions for '".concat(t,"' failed: ").concat(String(e))),e}},V.HISTORY_VERSIONS_POLL_INTERVAL,{maxStaleTimeMs:V.HISTORY_VERSIONS_MAX_STALE_TIME})),r=new k.Ge(t=>(0,k.F2)(async i=>{try{return await e.refreshRoomSubscriptionSettings(t,i)}catch(e){throw k.k2.warn("Polling subscription settings for '".concat(t,"' failed: ").concat(String(e))),e}},V.ROOM_SUBSCRIPTION_SETTINGS_POLL_INTERVAL,{maxStaleTimeMs:V.ROOM_SUBSCRIPTION_SETTINGS_MAX_STALE_TIME}));return{store:e,onMutationFailure:function(i,n,r){if(e.optimisticUpdates.remove(i),r instanceof k.j$){if(403===r.status){var a,o;let t=[r.message,null==(a=r.details)?void 0:a.suggestion,null==(o=r.details)?void 0:o.docs].filter(Boolean).join("\n");k.k2.error(t)}t[k.HM].emitError(n,r)}else throw r},pollThreadsForRoomId:t=>{let e=i.getOrCreate(t);e&&(e.markAsStale(),e.pollNowIfStale())},getOrCreateThreadsPollerForRoomId:i.getOrCreate.bind(i),getOrCreateVersionsPollerForRoomId:n.getOrCreate.bind(n),getOrCreateSubscriptionSettingsPollerForRoomId:r.getOrCreate.bind(r)}}(t),tX.set(t,e)),e}function tW(t){var e;let i=x(),{id:n,stableEnterRoom:r}=t,a=K({initialPresence:t.initialPresence,initialStorage:t.initialStorage,autoConnect:null!=(e=t.autoConnect)?e:"undefined"!=typeof window}),[{room:o},s]=(0,y.useState)(()=>r(n,{...a,autoConnect:!1}));return(0,y.useEffect)(()=>{let{store:t}=tV(i);async function e(e){if(e.type===k.gk.THREAD_DELETED)return void t.deleteThread(e.threadId,null);let i=await o.getThread(e.threadId);if(!i.thread)return void t.deleteThread(e.threadId,null);let{thread:n,inboxNotification:r,subscription:a}=i,s=t.outputs.threads.get().getEvenIfDeleted(e.threadId);switch(e.type){case k.gk.COMMENT_EDITED:case k.gk.THREAD_METADATA_UPDATED:case k.gk.THREAD_UPDATED:case k.gk.COMMENT_REACTION_ADDED:case k.gk.COMMENT_REACTION_REMOVED:case k.gk.COMMENT_DELETED:if(!s)break;t.updateThreadifications([n],r?[r]:[],a?[a]:[]);break;case k.gk.COMMENT_CREATED:t.updateThreadifications([n],r?[r]:[],a?[a]:[])}}return o.events.comments.subscribe(t=>void e(t))},[i,o]),(0,y.useEffect)(()=>{let t=r(n,a);s(t);let{room:e,leave:i}=t;return a.autoConnect&&e.connect(),()=>{i()}},[n,a,r]),(0,N.jsx)(U.Provider,{value:o,children:t.children})}function tz(t){let e=D();if(null===e&&!(null==t?void 0:t.allowOutsideRoom))throw Error("RoomProvider is missing from the React tree.");return e}function tB(t,e){let i=(0,y.useRef)(!1),n=tz();(0,y.useEffect)(()=>{if(!i.current)return n.events.status.subscribe(r=>{"connected"!==r||i.current||(i.current=!0,n[k.HM].reportTextEditor(t,e))})},[n,t,e])}function tq(){let t=tz();return(0,y.useCallback)((e,i)=>{t[k.HM].createTextMention(e,i).catch(t=>{k.k2.error("Cannot create text mention for user '".concat(e,"' and mention '").concat(i,"'"),t)})},[t])}function tG(){let t=tz();return(0,y.useCallback)(e=>{t[k.HM].deleteTextMention(e).catch(t=>{k.k2.error("Cannot delete text mention '".concat(e,"'"),t)})},[t])}function tK(){return x()[k.HM].resolveMentionSuggestions}function t$(){return x()[k.HM].mentionSuggestionsCache}function tY(){return tz().history}function tJ(t,e){let i=tz(),n=i.events.self.subscribe,r=i.getSelf,a=null!=t?t:tU;return P(n,r,tF,(0,y.useCallback)(t=>null!==t?a(t):null,[a]),e)}function tZ(t,e){let i=tz(),n=i.events.others.subscribe;return P(n,i.getOthers,tH,null!=t?t:tU,e)}var tQ=Symbol();function t0(){let t=tz(),e=t.events.storageDidLoad.subscribeOnce;return useSyncExternalStore3(e,t.getStorageSnapshot,tF)}function t1(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{scrollOnLoad:e=!0}=t,i=x(),n=tz(),{store:r,getOrCreateThreadsPollerForRoomId:a}=tV(i),o=Q(n.id,t.query),s=a(n.id);(0,y.useEffect)(()=>void r.outputs.loadingRoomThreads.getOrCreate(o).waitUntilLoaded()),(0,y.useEffect)(()=>(s.inc(),s.pollNowIfStale(),()=>s.dec()),[s]);let d=X(r.outputs.loadingRoomThreads.getOrCreate(o).signal);return(0,y.useEffect)(()=>{!function(t,e){if(!1===t||!e.threads||"undefined"==typeof window)return;let i=window.location.hash.slice(1);if(!i.startsWith("cm_"))return;let n=document.getElementById(i);null!==n&&e.threads.flatMap(t=>t.comments).some(t=>t.id===i)&&n.scrollIntoView()}(e,d)},[d.isLoading]),d}function t3(t){let e=x();return(0,y.useCallback)(i=>{var n;let r=i.body,a=null!=(n=i.metadata)?n:{},o=i.attachments,s=(0,k.IZ)(),d=(0,k.h$)(),l=new Date,u={id:d,threadId:s,roomId:t,createdAt:l,type:"comment",userId:tj(e),body:r,reactions:[],attachments:null!=o?o:[]},c={id:s,type:"thread",createdAt:l,updatedAt:l,roomId:t,metadata:a,comments:[u],resolved:!1},{store:h,onMutationFailure:f}=tV(e),m=h.optimisticUpdates.add({type:"create-thread",thread:c,roomId:t}),p=null==o?void 0:o.map(t=>t.id);return e[k.HM].httpClient.createThread({roomId:t,threadId:s,commentId:d,body:r,metadata:a,attachmentIds:p}).then(t=>{h.createThread(m,t)},e=>f(m,{type:"CREATE_THREAD_ERROR",roomId:t,threadId:s,commentId:d,body:r,metadata:a},e)),c},[e,t])}function t5(t){let e=x();return(0,y.useCallback)(i=>{let{threadId:n,body:r,attachments:a}=i,o=(0,k.h$)(),s={id:o,threadId:n,roomId:t,type:"comment",createdAt:new Date,userId:tj(e),body:r,reactions:[],attachments:null!=a?a:[]},{store:d,onMutationFailure:l}=tV(e),u=d.optimisticUpdates.add({type:"create-comment",comment:s}),c=null==a?void 0:a.map(t=>t.id);return e[k.HM].httpClient.createComment({roomId:t,threadId:n,commentId:o,body:r,attachmentIds:c}).then(t=>{d.createComment(t,u)},e=>l(u,{type:"CREATE_COMMENT_ERROR",roomId:t,threadId:n,commentId:o,body:r},e)),s},[e,t])}function t2(t){let e=x();return(0,y.useCallback)(i=>{let{threadId:n,commentId:r,body:a,attachments:o}=i,s=new Date,{store:d,onMutationFailure:l}=tV(e),u=d.outputs.threads.get().getEvenIfDeleted(n);if(void 0===u)return void k.k2.warn('Internal unexpected behavior. Cannot edit comment in thread "'.concat(n,'" because the thread does not exist in the cache.'));let c=u.comments.find(t=>t.id===r);if(void 0===c||void 0!==c.deletedAt)return void k.k2.warn('Internal unexpected behavior. Cannot edit comment "'.concat(r,'" in thread "').concat(n,'" because the comment does not exist in the cache.'));let h=d.optimisticUpdates.add({type:"edit-comment",comment:{...c,editedAt:s,body:a,attachments:null!=o?o:[]}}),f=null==o?void 0:o.map(t=>t.id);e[k.HM].httpClient.editComment({roomId:t,threadId:n,commentId:r,body:a,attachmentIds:f}).then(t=>{d.editComment(n,h,t)},e=>l(h,{type:"EDIT_COMMENT_ERROR",roomId:t,threadId:n,commentId:r,body:a},e))},[e,t])}function t4(t){let e=x();return(0,y.useCallback)(i=>{let{threadId:n,commentId:r}=i,a=new Date,{store:o,onMutationFailure:s}=tV(e),d=o.optimisticUpdates.add({type:"delete-comment",threadId:n,commentId:r,deletedAt:a,roomId:t});e[k.HM].httpClient.deleteComment({roomId:t,threadId:n,commentId:r}).then(()=>{o.deleteComment(n,d,r,a)},e=>s(d,{type:"DELETE_COMMENT_ERROR",roomId:t,threadId:n,commentId:r},e))},[e,t])}function t7(t){let e=x();return(0,y.useCallback)(i=>{let{threadId:n,commentId:r,emoji:a}=i,o=new Date,s=tj(e),{store:d,onMutationFailure:l}=tV(e),u=d.optimisticUpdates.add({type:"add-reaction",threadId:n,commentId:r,reaction:{emoji:a,userId:s,createdAt:o}});e[k.HM].httpClient.addReaction({roomId:t,threadId:n,commentId:r,emoji:a}).then(t=>{d.addReaction(n,u,r,t,o)},e=>l(u,{type:"ADD_REACTION_ERROR",roomId:t,threadId:n,commentId:r,emoji:a},e))},[e,t])}function t6(t){let e=x();return(0,y.useCallback)(i=>{let{threadId:n,commentId:r,emoji:a}=i,o=tj(e),s=new Date,{store:d,onMutationFailure:l}=tV(e),u=d.optimisticUpdates.add({type:"remove-reaction",threadId:n,commentId:r,emoji:a,userId:o,removedAt:s});e[k.HM].httpClient.removeReaction({roomId:t,threadId:n,commentId:r,emoji:a}).then(()=>{d.removeReaction(n,u,r,a,o,s)},e=>l(u,{type:"REMOVE_REACTION_ERROR",roomId:t,threadId:n,commentId:r,emoji:a},e))},[e,t])}function t9(t){let e=x();return(0,y.useCallback)(i=>{let{store:n,onMutationFailure:r}=tV(e),a=Object.values(n.outputs.notifications.get().notificationsById).find(t=>"thread"===t.kind&&t.threadId===i);if(!a)return;let o=new Date,s=n.optimisticUpdates.add({type:"mark-inbox-notification-as-read",inboxNotificationId:a.id,readAt:o});e[k.HM].httpClient.markRoomInboxNotificationAsRead({roomId:t,inboxNotificationId:a.id}).then(()=>{n.markInboxNotificationRead(a.id,o,s)},e=>{r(s,{type:"MARK_INBOX_NOTIFICATION_AS_READ_ERROR",roomId:t,inboxNotificationId:a.id},e)})},[e,t])}function t8(t){let e=x();return(0,y.useCallback)(i=>{let n=new Date,{store:r,onMutationFailure:a}=tV(e),o=r.optimisticUpdates.add({type:"mark-thread-as-resolved",threadId:i,updatedAt:n});e[k.HM].httpClient.markThreadAsResolved({roomId:t,threadId:i}).then(()=>{r.patchThread(i,o,{resolved:!0},n)},e=>a(o,{type:"MARK_THREAD_AS_RESOLVED_ERROR",roomId:t,threadId:i},e))},[e,t])}function et(t){let e=x();return(0,y.useCallback)(i=>{let n=new Date,{store:r,onMutationFailure:a}=tV(e),o=r.optimisticUpdates.add({type:"mark-thread-as-unresolved",threadId:i,updatedAt:n});e[k.HM].httpClient.markThreadAsUnresolved({roomId:t,threadId:i}).then(()=>{r.patchThread(i,o,{resolved:!1},n)},e=>a(o,{type:"MARK_THREAD_AS_UNRESOLVED_ERROR",roomId:t,threadId:i},e))},[e,t])}function ee(t){let e=x();return(0,y.useCallback)(i=>{let n=new Date,{store:r,onMutationFailure:a}=tV(e),o=r.optimisticUpdates.add({type:"subscribe-to-thread",threadId:i,subscribedAt:n});e[k.HM].httpClient.subscribeToThread({roomId:t,threadId:i}).then(t=>{r.createSubscription(t,o)},e=>a(o,{type:"SUBSCRIBE_TO_THREAD_ERROR",roomId:t,threadId:i},e))},[e,t])}function ei(t){let e=x();return(0,y.useCallback)(i=>{let n=new Date,{store:r,onMutationFailure:a}=tV(e),o=r.optimisticUpdates.add({type:"unsubscribe-from-thread",threadId:i,unsubscribedAt:n});e[k.HM].httpClient.unsubscribeFromThread({roomId:t,threadId:i}).then(()=>{r.deleteSubscription((0,k.P$)("thread",i),o)},e=>a(o,{type:"UNSUBSCRIBE_FROM_THREAD_ERROR",roomId:t,threadId:i},e))},[e,t])}function en(t,e){let{store:i}=tV(x()),n=(0,y.useMemo)(()=>(0,k.P$)("thread",e),[e]),r=ee(t),a=ei(t),o=(0,y.useCallback)(()=>r(e),[r,e]),s=(0,y.useCallback)(()=>a(e),[a,e]);return X(i.outputs.threadSubscriptions,(0,y.useCallback)(t=>{var i;let r=t.subscriptions[n],a=t.notifications.find(t=>"thread"===t.kind&&t.threadId===e);return void 0===r?{status:"not-subscribed",subscribe:o,unsubscribe:s}:{status:"subscribed",unreadSince:null!=(i=null==a?void 0:a.readAt)?i:null,subscribe:o,unsubscribe:s}},[n,e,o,s]),k.x7)}function er(){q(),Y(tz().waitUntilPresenceReady())}function ea(t){return void 0===t||(null==t?void 0:t.isLoading)?null!=t?t:{isLoading:!0}:t.error?t:((0,k.vA)(void 0!==t.data,"Unexpected missing attachment URL"),{isLoading:!1,url:t.data})}function eo(t,e){let i=x()[k.HM].httpClient.getOrCreateAttachmentUrlsStore(e),n=(0,y.useCallback)(()=>i.getItemState(t),[i,t]);return(0,y.useEffect)(()=>{i.enqueue(t)},[i,t]),P(i.subscribe,n,n,ea,k.x7)}function es(t){return X(tV(x()).store.permissionHints.getPermissionForRoomΣ(t))}var ed=function(t){let e=x(),[i]=(0,y.useState)(()=>new Map),n=(0,y.useCallback)((t,n)=>{let r=i.get(t);if(r)return r;let a=e.enterRoom(t,n),o=a.leave;return a.leave=()=>{o(),i.delete(t)},i.set(t,a),a},[e,i]);return(0,N.jsx)(tW,{...t,stableEnterRoom:n})},el=tz,eu=function(){return t3(tz().id)},ec=t1,eh=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};q();let e=x(),i=tz(),{store:n}=tV(e),r=Q(i.id,t.query);Y(n.outputs.loadingRoomThreads.getOrCreate(r).waitUntilLoaded());let a=t1(t);return(0,k.vA)(!a.error,"Did not expect error"),(0,k.vA)(!a.isLoading,"Did not expect loading"),a};function ef(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return function(t,e){return er(),tZ(t,e)}(...e)}function em(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return tJ(...e)}function ep(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return function(t,e){return er(),tJ(t,e)}(...e)}function eg(t){let e=(0,I._)(this,o).get();void 0!==e.data&&(0,I._)(this,o).set(B({...e.data,...t}))}async function e_(){var t;let e=(0,I._)(this,o).get();if((null==(t=e.data)?void 0:t.cursor)&&!e.data.isFetchingMore){(0,R._)(this,l,eg).call(this,{isFetchingMore:!0});try{let t=await (0,I._)(this,s).call(this,e.data.cursor);(0,R._)(this,l,eg).call(this,{cursor:t,hasFetchedAll:null===t,fetchMoreError:void 0,isFetchingMore:!1})}catch(t){(0,R._)(this,l,eg).call(this,{isFetchingMore:!1,fetchMoreError:t})}}}function ev(t,e,i,n){(0,k.OX)(()=>{null!==e&&this.optimisticUpdates.remove(e);let r=this.threads,a=r.get(t);a&&(n&&a.updatedAt>n||r.upsert(i(a)))})}}}]);